<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CapyFix - Corretor de Código com IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png">
  <link rel="stylesheet" href="cu-style.css">
  <script src="cu-navigation.js" defer></script>

  <style>
    .font-jetbrains { font-family: 'JetBrains Mono', monospace; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--cu-purple); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .markdown-output pre { background:#00000033; border-radius:8px; padding:1rem; }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <header class="cu-header">
    <div class="cu-brand">
        <a href="index.html" class="flex items-center gap-2 group">
            <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png"></div>
            <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
        </a>
        <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyFix</span>
    </div>
    <div class="flex items-center gap-2">
        <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
    </div>
  </header>

  <div class="flex flex-1">
    <aside id="sidebar" class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin">
      <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
    </aside>

    <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
      <section class="cu-panel p-4 sm:p-6 flex flex-col h-full">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold" style="color: var(--cu-cyan);">CapyFix 🛠️</h1>
          <p class="text-cu-text-dim mt-1">Depure e refatore seu código com a ajuda de uma IA especialista.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1">
          <div class="flex flex-col space-y-4">
            <h2 class="text-xl font-semibold">Seu Código</h2>
            <div class="cu-panel bg-transparent p-4 space-y-3">
                <div>
                    <label for="language" class="block text-sm font-medium text-cu-text-dim mb-1">Linguagem:</label>
                    <select id="language" class="cu-select"><option>JavaScript</option><option>Python</option><option>HTML</option><option>CSS</option></select>
                </div>
                <div>
                    <label for="problem" class="block text-sm font-medium text-cu-text-dim mb-1">Qual o problema?</label>
                    <textarea id="problem" rows="3" class="cu-textarea font-jetbrains" placeholder="Ex: O loop não para..."></textarea>
                </div>
                <div class="flex-1 min-h-[160px] flex flex-col">
                    <label for="code" class="block text-sm font-medium text-cu-text-dim mb-1">Cole o código:</label>
                    <textarea id="code" class="cu-textarea font-jetbrains flex-1" placeholder="function suaFuncao() { ... }"></textarea>
                </div>
            </div>
            <button id="solve-btn" class="cu-btn primary text-lg">
              <span class="btn-text">Analisar e Corrigir</span>
              <div class="loader hidden"></div>
            </button>
          </div>

          <div class="flex flex-col">
            <h2 class="text-xl font-semibold mb-3">Solução Proposta</h2>
            <div id="solution" class="cu-panel bg-transparent p-4 flex-1 overflow-y-auto scrollbar-thin markdown-output"></div>
            <div id="loading" class="hidden flex-1 justify-center items-center"><div class="loader"></div></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="notificationArea"></div>

  <script>
    let apiKey = localStorage.getItem('capyUniverseApiKey_gemini') || '';
    marked.setOptions({ highlight: (code, lang) => hljs.highlight(code, { language: hljs.getLanguage(lang) ? lang : 'plaintext' }).value });

    function toggleLoading(isLoading) { /* ... */ }

    async function getCodeSolution() {
        if (!apiKey) return alert("Configure a chave API do Gemini.");
        const code = document.getElementById('code').value.trim();
        if (!code) return alert("Insira o código a ser analisado.");

        toggleLoading(true);
        const prompt = `Aja como CapyFix. Analise o código em ${document.getElementById('language').value} com o problema: "${document.getElementById('problem').value}". Código: \`\`\`${document.getElementById('language').value}\n${code}\n\`\`\`. Responda em Markdown com Diagnóstico, Código Corrigido e Explicação.`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) throw new Error(`Erro na API: ${response.status}`);
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) {
                document.getElementById('solution').innerHTML = marked.parse(text.trim());
                document.querySelectorAll('#solution pre code').forEach(block => hljs.highlightElement(block));
            } else { throw new Error("Resposta da IA vazia."); }
        } catch (error) { document.getElementById('solution').innerHTML = `<p class="text-red-400">Erro: ${error.message}</p>`; }
        finally { toggleLoading(false); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const savedKey = localStorage.getItem('capyUniverseApiKey_gemini');
        if (savedKey) apiKey = savedKey;
        document.getElementById('solve-btn').addEventListener('click', getCodeSolution);
    });
  </script>
</body>
</html>

