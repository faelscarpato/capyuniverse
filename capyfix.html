<!DOCTYPE html>
<html lang="pt-BR" data-theme="capyuniverse">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CapyFix - Corretor de C√≥digo com IA</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Syne:wght@700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png">

  <!-- Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3FFD7ZEBN1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-3FFD7ZEBN1');
  </script>

  <!-- ===== Tema CapyUniverse ===== -->
  <style>
    :root{
      --cu-bg-0:#0b0b14; --cu-bg-1:#0f1024; --cu-grid:#2a2e63; --cu-card:#0f0f22cc;
      --cu-cyan:#22d3ee; --cu-magenta:#f472d0; --cu-amber:#f59e0b; --cu-text:#e6e6f0; --cu-text-dim:#aab;
      --cu-radius:16px; --cu-radius-lg:22px; --cu-blur:12px;
      --cu-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.03);
    }
    html{ background:var(--cu-bg-0); }
    body{
      font-family:Inter,system-ui,sans-serif; color:var(--cu-text);
      background:
        radial-gradient(1200px 700px at 70% -10%, rgba(139,92,246,.25), transparent 60%),
        radial-gradient(900px 600px at -10% 20%, rgba(34,211,238,.18), transparent 60%),
        var(--cu-bg-0);
    }
    .cu-stars{ position:fixed; inset:0; pointer-events:none; z-index:-2;
      background:
        radial-gradient(circle at 15% 20%, rgba(255,255,255,.12) 0 1px, transparent 2px) 0 0/180px 180px,
        radial-gradient(circle at 75% 35%, rgba(255,255,255,.10) 0 1px, transparent 2px) 0 0/220px 220px,
        radial-gradient(circle at 40% 70%, rgba(255,255,255,.08) 0 1px, transparent 2px) 0 0/260px 260px; }
    .cu-stage{ position:fixed; inset:auto 0 0 0; height:38vh; pointer-events:none; z-index:-1;
      background: linear-gradient( to top, rgba(10,10,22,.65), transparent 70%),
        repeating-linear-gradient( to right, transparent 0 38px, var(--cu-grid) 38px 39px),
        repeating-linear-gradient( to top,   transparent 0 38px, var(--cu-grid) 38px 39px);
      mask: linear-gradient(to top, black, transparent 80%); }

    .cu-header{ position:fixed; top:0; left:0; right:0; z-index:40; height:64px;
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
      padding:0 .9rem; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(10,10,30,.7), rgba(10,10,30,.35));
      border-bottom:1px solid rgba(255,255,255,.06); }
    .cu-brand{ display:flex; align-items:center; gap:.6rem; }
    .cu-appname{ font-family:Syne,Inter,sans-serif; font-weight:800; letter-spacing:.4px; }
    .cu-chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .6rem; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); background:linear-gradient(120deg, rgba(34,211,238,.16), rgba(139,92,246,.16)); }

    .cu-panel{ background:var(--cu-card); backdrop-filter: blur(var(--cu-blur));
      border-radius:var(--cu-radius-lg); box-shadow:var(--cu-shadow); border:1px solid rgba(255,255,255,.06); }
    .cu-btn{ display:inline-flex; align-items:center; gap:.55rem; padding:.6rem .9rem; border-radius:14px; font-weight:600;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(130deg, rgba(34,211,238,.18), rgba(244,114,208,.18));
      box-shadow:var(--cu-shadow); backdrop-filter: blur(6px); transition:.2s transform, .2s filter; }
    .cu-btn:hover{ transform: translateY(-1px);
      filter: drop-shadow(0 0 10px rgba(34,211,238,.45)) drop-shadow(0 0 24px rgba(244,114,208,.35)); }
    .cu-btn.primary{ background: linear-gradient(140deg, #0ea5e9 0%, #22d3ee 40%, #a855f7 78%, #f59e0b 100%); color:white; border-color:transparent; }
    .cu-input, .cu-select, .cu-textarea{ width:100%; background:rgba(15,15,40,.6);
      border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:.75rem .9rem; color:var(--cu-text); outline:none; }
    .cu-input:focus, .cu-select:focus, .cu-textarea:focus{ border-color: var(--cu-cyan); box-shadow: 0 0 0 3px rgba(34,211,238,.18); }

    /* Markdown / resposta: nunca corta texto */
    #solution{ overflow: hidden; }
    #solution .md{ overflow-wrap:anywhere; word-wrap:break-word; }
    #solution .md pre{ overflow:auto; white-space:pre; background:#1b1c2e; border-radius:8px; padding:1rem; }
    #solution .md code.hljs{ color:#e6e6f0; }
    #solution .md h3{ color:#67e8f9; margin:.9rem 0 .4rem; font-weight:600; font-size:1.1rem; }

    /* Scrollbar est√©tica */
    .scrollbar-thin::-webkit-scrollbar{ width:8px; height:8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb{ background:linear-gradient(120deg,#22d3ee,#8b5cf6); border-radius:999px; }
    .scrollbar-thin::-webkit-scrollbar-track{ background:rgba(255,255,255,.06); }
  </style>
  <script src="cu-init.js"></script>
</head>

<body class="min-h-screen flex flex-col text-[15px]">
  <div class="cu-stars"></div>
  <div class="cu-stage"></div>

  <!-- Header (mobile-first) -->
  <header class="cu-header">
    <div class="cu-brand">
      <button id="sidebarToggleBtn" class="lg:hidden p-2 rounded-md text-gray-300 hover:bg-white/10 focus:outline-none">
        <i class="fas fa-bars text-xl"></i>
      </button>
      <div class="flex items-center gap-2">
        <svg class="w-7 h-7" viewBox="0 0 64 64" aria-hidden="true">
          <defs><linearGradient id="g2" x1="0" x2="1"><stop offset="0" stop-color="#22d3ee"/><stop offset="1" stop-color="#f472d0"/></linearGradient></defs>
        <circle cx="32" cy="32" r="30" fill="url(#g2)" opacity=".25"/>
        <path d="M18 40c7 6 21 6 28 0 2-2 2-6-1-8l-4-3c-1-5-5-9-9-9s-8 4-9 9l-4 3c-3 2-3 6-1 8z" fill="url(#g2)"/>
        <rect x="23" y="28" rx="4" ry="4" width="18" height="14" fill="#0b0b14"/>
        <text x="32" y="39" text-anchor="middle" font-size="9" font-family="Syne, Inter, sans-serif" fill="#fff">Fix</text>
        </svg>
        <span class="cu-appname text-xl">CapyFix</span>
        <span class="cu-chip hidden sm:inline-flex">CapyUniverse</span>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button onclick="location.href='index.html'" class="cu-btn hidden sm:inline-flex">In√≠cio</button>
      <button id="openApiKeysModalButton" class="cu-btn primary hidden sm:inline-flex">Chaves API</button>
    </div>
  </header>

  <div class="flex flex-1 pt-16 min-h-0">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 sidebar-glass text-gray-300 space-y-1 p-3 fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 lg:static lg:inset-0 transition-transform duration-300 ease-in-out z-30 shadow-lg overflow-y-auto pt-4 scrollbar-thin">
      <p class="text-xs text-center text-zinc-400 p-2">Carregando menu...</p>
    </aside>
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/60 z-20 hidden lg:hidden"></div>

    <!-- Main -->
    <main class="flex-1 min-h-0 p-4 sm:p-6 lg:p-8 overflow-y-auto w-full">
      <section class="cu-panel p-5 sm:p-6 lg:p-8 flex flex-col h-full">
        <div class="text-center mb-6 sm:mb-8">
          <h1 class="text-2xl sm:text-3xl font-bold" style="color:#22d3ee;">CapyFix üõ†Ô∏è</h1>
          <p class="text-zinc-300 mt-1">Especialista IA para depurar e refatorar c√≥digo.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8 flex-1 min-h-0">
          <!-- Entrada -->
          <div class="flex flex-col space-y-4">
            <h2 class="text-xl sm:text-2xl font-semibold text-white">Seu C√≥digo</h2>
            <div>
              <label for="language" class="block text-sm font-medium text-zinc-400 mb-1">Linguagem:</label>
              <select id="language" class="cu-select">
                <option value="javascript">JavaScript</option><option value="python">Python</option>
                <option value="html">HTML</option><option value="css">CSS</option>
                <option value="java">Java</option><option value="csharp">C#</option>
                <option value="cpp">C++</option><option value="php">PHP</option>
                <option value="ruby">Ruby</option><option value="go">Go</option>
                <option value="swift">Swift</option><option value="kotlin">Kotlin</option>
                <option value="typescript">TypeScript</option><option value="sql">SQL</option>
                <option value="plaintext">Outro</option>
              </select>
            </div>
            <div>
              <label for="problem" class="block text-sm font-medium text-zinc-400 mb-1">Qual o problema?</label>
              <textarea id="problem" rows="3" class="cu-textarea font-mono" placeholder="Ex: O loop n√£o para, a fun√ß√£o retorna undefined..."></textarea>
            </div>
            <div class="flex-1 min-h-[160px] flex flex-col">
              <label for="code" class="block text-sm font-medium text-zinc-400 mb-1">Cole o c√≥digo aqui:</label>
              <textarea id="code" class="cu-textarea font-mono w-full flex-1" placeholder="function minhaFuncao() { ... }"></textarea>
            </div>
            <button id="solve-btn" class="cu-btn primary font-bold py-3 px-6 rounded-lg transition-transform hover:scale-[1.02] shadow-lg flex items-center justify-center">
              <span class="btn-text">Analisar e Corrigir</span>
              <div class="loader hidden ml-2"></div>
            </button>
          </div>

          <!-- Sa√≠da -->
          <div class="flex flex-col min-h-0">
            <h2 class="text-xl sm:text-2xl font-semibold text-white mb-3 sm:mb-4">Solu√ß√£o Proposta pela IA</h2>
            <div id="solution" class="flex-1 min-h-0 cu-panel p-3 sm:p-4 overflow-y-auto scrollbar-thin">
              <div class="md text-zinc-400 text-center pt-12">A solu√ß√£o aparecer√° aqui‚Ä¶</div>
            </div>
            <div id="loading" class="hidden text-center flex-1 flex-col justify-center items-center">
              <div class="loader"></div>
              <p class="mt-4 text-white">CapyFix est√° depurando o seu c√≥digo...</p>
            </div>
            <p id="errorMessage" class="text-red-400 text-sm mt-2 text-center"></p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- FAB: Chaves API (mobile) -->
  <button id="fabApi" class="sm:hidden fixed bottom-4 right-4 cu-btn primary rounded-full p-3 shadow-xl z-50" title="Chaves API">üîë</button>

  <!-- Modal Chaves -->
  <div id="apiKeysModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[60] hidden p-4"></div>

  <script>
    const currentPageId = 'CapyFix';
    let apiKey = '';
    const API_KEY_STORAGE_KEY = 'capyUniverseApiKey_gemini';

    const dom = {
      sidebar: document.getElementById('sidebar'),
      sidebarToggleBtn: document.getElementById('sidebarToggleBtn'),
      sidebarOverlay: document.getElementById('sidebarOverlay'),
      apiKeysModal: document.getElementById('apiKeysModal'),
      openApiKeysModalButton: document.getElementById('openApiKeysModalButton'),
      fabApi: document.getElementById('fabApi'),
      solveBtn: document.getElementById('solve-btn'),
      solutionDiv: document.getElementById('solution'),
      loadingDiv: document.getElementById('loading'),
      errorMessage: document.getElementById('errorMessage'),
      languageInput: document.getElementById('language'),
      problemInput: document.getElementById('problem'),
      codeInput: document.getElementById('code'),
    };

    // Markdown + highlight
    marked.setOptions({
      highlight: (code, lang) => {
        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
        return hljs.highlight(code, { language }).value;
      }
    });

    function toggleLoading(isLoading) {
      const btnText = dom.solveBtn.querySelector('.btn-text');
      const loader = dom.solveBtn.querySelector('.loader');
      dom.solveBtn.disabled = isLoading;
      if (isLoading) {
        btnText?.classList.add('hidden'); loader?.classList.remove('hidden');
        dom.solutionDiv.classList.add('hidden'); dom.loadingDiv.classList.remove('hidden');
      } else {
        btnText?.classList.remove('hidden'); loader?.classList.add('hidden');
        dom.solutionDiv.classList.remove('hidden'); dom.loadingDiv.classList.add('hidden');
      }
    }

    async function getCodeSolution() {
      if (!apiKey) { dom.errorMessage.textContent = "Configure sua chave API (√≠cone üîë)."; return; }
      dom.errorMessage.textContent = "";
      const language = dom.languageInput.value;
      const problem = dom.problemInput.value.trim();
      const code = dom.codeInput.value.trim();
      if (!code || !problem || !language) { alert('Preencha linguagem, problema e c√≥digo.'); return; }

      const prompt = `
Aja como um programador s√™nior (CapyFix). Analise o c√≥digo em "${language}" e proponha solu√ß√£o.

Problema:
"${problem}"

C√≥digo:
\`\`\`${language}
${code}
\`\`\`

Responda em Markdown com:
### Diagn√≥stico do Problema
### C√≥digo Corrigido
### Explica√ß√£o da Solu√ß√£o
`;

      toggleLoading(true);
      try {
        const payload = {
          contents: [{ role: "user", parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.2, maxOutputTokens: 22048 }
        };
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,{
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorBody = await response.json();
          throw new Error(`Erro na API ${response.status}: ${errorBody.error?.message||'desconhecido'}`);
        }
        const result = await response.json();
        const txt = result?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!txt) throw new Error("A API n√£o retornou uma solu√ß√£o no formato esperado.");

        // Garante que o conte√∫do fique DENTRO da se√ß√£o e com wrap
        dom.solutionDiv.innerHTML = `<div class="md">${marked.parse(txt.trim())}</div>`;
        // Reaplica highlight caso o tema do CSS n√£o pegue no HTML rec√©m-injetado
        dom.solutionDiv.querySelectorAll('pre code').forEach((block)=>{ hljs.highlightElement(block); });

      } catch (error) {
        console.error('Erro ao chamar a API:', error);
        dom.solutionDiv.innerHTML = `<div class="md"><p class="text-red-400">Erro ao buscar a solu√ß√£o: ${error.message}</p></div>`;
      } finally {
        toggleLoading(false);
      }
    }

    // Sidebar + navega√ß√£o (igual ao seu, s√≥ com pequenas melhorias visuais)
    async function renderSidebar() {
      if (!dom.sidebar) return;
      try {
        const response = await fetch('tools.json');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const toolsData = await response.json();

        const categories = {};
        toolsData.forEach(tool => {
          let cats = tool.category;
          if (typeof cats === 'string') cats = [cats];
          (cats||[]).forEach(cat => { (categories[cat] ??= []).push(tool); });
        });

        dom.sidebar.innerHTML = '';
        const home = document.createElement('a');
        home.href='index.html';
        home.className='sidebar-link w-full flex items-center space-x-2.5 p-2.5 mb-2 rounded-md text-sm hover:bg-white/10 transition-colors duration-150 text-gray-300';
        home.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> <span>P√°gina Inicial</span>`;
        dom.sidebar.appendChild(home);

        for (const categoryName in categories) {
          const wrap = document.createElement('div'); wrap.className='mb-1';
          const btn = document.createElement('button');
          btn.className='w-full flex justify-between items-center p-2.5 text-left text-gray-300 hover:bg-white/10 rounded-md focus:outline-none transition-colors duration-150';
          btn.innerHTML=`<span class="font-semibold text-sm">${categoryName}</span><svg class="w-4 h-4 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
          const content = document.createElement('div');
          content.className='category-content pl-3 pt-0.5 space-y-0.5';

          categories[categoryName].forEach(tool => {
            const a=document.createElement('a');
            a.href=tool.pageUrl;
            const icon=tool.icon?tool.icon.replace('w-10 h-10','w-5 h-5').replace('mb-2','mr-2'):'<span class="w-5 h-5 mr-2"></span>';
            a.className=`sidebar-link w-full flex items-center space-x-2 py-1.5 px-2 rounded-md text-xs hover:bg-zinc-600/60 hover:text-white transition-colors duration-150 ${tool.id===currentPageId?'active':'text-gray-400'}`;
            a.innerHTML=icon+`<span>${tool.title}</span>`;
            content.appendChild(a);
          });

          btn.addEventListener('click', ()=>{ content.classList.toggle('expanded'); btn.querySelector('svg').classList.toggle('rotate-180'); });
          if (categories[categoryName].some(t=>t.id===currentPageId)) { content.classList.add('expanded'); btn.querySelector('svg').classList.add('rotate-180'); }
          wrap.appendChild(btn); wrap.appendChild(content); dom.sidebar.appendChild(wrap);
        }
      } catch (e) {
        console.error("Erro ao carregar menu:", e);
        dom.sidebar.innerHTML = '<p class="text-xs text-red-400 p-2">Erro ao carregar menu.</p>';
      }
    }

    function loadApiKey() {
      const saved = localStorage.getItem(API_KEY_STORAGE_KEY);
      if (saved) { apiKey = saved; }
      else { dom.errorMessage.textContent = "Aten√ß√£o: configure a Chave API Gemini (√≠cone üîë)."; }
    }

    function setupApiKeyModal() {
      const modalHTML = `
        <div class="w-full max-w-md">
          <div class="cu-panel p-6">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-bold text-sky-400">Chave API ‚Äî Google Gemini</h2>
              <button id="closeApiKeysModalButton" class="cu-btn" style="padding:.25rem .6rem;">‚úï</button>
            </div>
            <label class="block text-sm text-gray-300 mb-1" for="geminiApiKeyInputModal">Sua Chave:</label>
            <div class="flex">
              <input id="geminiApiKeyInputModal" type="password" placeholder="Cole sua chave aqui" class="cu-input rounded-r-none">
              <button id="saveGeminiKey" class="cu-btn primary rounded-l-none">Salvar</button>
            </div>
            <p class="text-xs text-zinc-400 mt-2">Sua chave √© salva apenas no seu dispositivo (localStorage).</p>
          </div>
        </div>`;
      dom.apiKeysModal.innerHTML = modalHTML;
      const close = ()=>dom.apiKeysModal.classList.add('hidden');

      // Abridores (header e FAB mobile)
      dom.openApiKeysModalButton?.addEventListener('click', ()=>dom.apiKeysModal.classList.remove('hidden'));
      dom.fabApi?.addEventListener('click', ()=>dom.apiKeysModal.classList.remove('hidden'));

      dom.apiKeysModal.addEventListener('click', (e)=>{ if (e.target===dom.apiKeysModal) close(); });
      dom.apiKeysModal.querySelector('#closeApiKeysModalButton').addEventListener('click', close);
      dom.apiKeysModal.querySelector('#saveGeminiKey').addEventListener('click', ()=>{
        const input = dom.apiKeysModal.querySelector('#geminiApiKeyInputModal');
        const key = (input.value||'').trim();
        if(!key){ alert('Insira uma chave v√°lida.'); return; }
        localStorage.setItem(API_KEY_STORAGE_KEY, key);
        apiKey = key; close(); dom.errorMessage.textContent = "";
      });

      // Preenche se j√° houver
      const saved = localStorage.getItem(API_KEY_STORAGE_KEY);
      if (saved) dom.apiKeysModal.querySelector('#geminiApiKeyInputModal').value = saved;
    }

    // Eventos base
    document.addEventListener('DOMContentLoaded', () => {
      renderSidebar();
      setupApiKeyModal();
      loadApiKey();

      dom.solveBtn.addEventListener('click', getCodeSolution);

      dom.sidebarToggleBtn?.addEventListener('click', () => {
        dom.sidebar.classList.toggle('-translate-x-full');
        dom.sidebarOverlay.classList.toggle('hidden');
      });
      dom.sidebarOverlay?.addEventListener('click', () => {
        dom.sidebar.classList.add('-translate-x-full');
        dom.sidebarOverlay.classList.add('hidden');
      });
    });
  </script>
</body>
</html>

