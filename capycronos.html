<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapyCronos Legal - Gerenciador de Prazos IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png">
    <link rel="stylesheet" href="cu-style.css">
    <script src="cu-navigation.js" defer></script>

    <style>
        .font-jetbrains { font-family: 'JetBrains Mono', monospace; }
        .loader { border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Hidden content for PDF export */
        #pdfReportContentDetails { display: none; }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <header class="cu-header">
        <div class="cu-brand">
            <a href="index.html" class="flex items-center gap-2 group">
                <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png"></div>
                <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
            </a>
            <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyCronos</span>
        </div>
        <div class="flex items-center gap-2">
            <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
        </div>
    </header>

    <div id="notificationArea"></div>

    <div class="flex flex-1">
        <aside id="sidebar" class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin">
            <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
        </aside>

        <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
            <section class="cu-panel p-4 sm:p-6 flex flex-col h-full">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold" style="color: var(--cu-amber)">CapyCronos Legal ⏱️</h1>
                    <p class="text-cu-text-dim mt-1">Sua IA para gestão inteligente de prazos jurídicos.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="flex flex-col space-y-4">
                        <div class="cu-panel bg-transparent p-4">
                            <label for="documentInput" class="block text-sm font-medium text-cu-text-dim mb-2">1. Documento Jurídico (Texto Completo):</label>
                            <textarea id="documentInput" class="cu-textarea w-full h-48" placeholder="Cole aqui o texto do documento (despacho, intimação, contrato, etc.)..."></textarea>
                        </div>
                        <div class="cu-panel bg-transparent p-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="deadlineType" class="block text-sm font-medium text-cu-text-dim mb-2">2. Tipo de Prazo:</label>
                                <input type="text" id="deadlineType" class="cu-input w-full" placeholder="Ex: Recurso, Contestação">
                            </div>
                            <div>
                                <label for="referenceDate" class="block text-sm font-medium text-cu-text-dim mb-2">3. Data de Referência:</label>
                                <input type="date" id="referenceDate" class="cu-input w-full">
                            </div>
                        </div>
                        <button id="analyzeDeadlinesButton" class="cu-btn primary text-base w-full">
                            <span class="btn-text">Analisar Prazos com IA</span>
                            <div class="loader hidden ml-2"></div>
                        </button>
                    </div>

                    <div class="space-y-4">
                         <h2 class="text-xl font-bold text-cu-text mb-2">4. Análise de Prazos</h2>
                        <div id="deadlineOutput" class="cu-panel bg-transparent p-4 min-h-[260px] space-y-3">
                            <div class="p-3 rounded-lg bg-white/5">
                                <h3 class="text-lg font-semibold text-amber-300 mb-1">Prazo Identificado:</h3>
                                <p id="identifiedDeadlineOutput" class="text-sm text-cu-text-dim">Aguardando análise...</p>
                            </div>
                            <div class="p-3 rounded-lg bg-white/5">
                                <h3 class="text-lg font-semibold text-amber-300 mb-1">Data Limite Calculada:</h3>
                                <p id="calculatedDueDateOutput" class="text-sm text-cu-text-dim">-</p>
                            </div>
                            <div class="p-3 rounded-lg bg-white/5">
                                <h3 class="text-lg font-semibold text-amber-300 mb-1">Contagem Regressiva:</h3>
                                <p id="countdownOutput" class="text-sm text-cu-text-dim">-</p>
                            </div>
                            <div class="p-3 rounded-lg bg-white/5">
                                <h3 class="text-lg font-semibold text-amber-300 mb-1">Base / Trecho Relevante:</h3>
                                <p id="relevantTextOutput" class="text-xs text-cu-text-dim italic max-h-20 overflow-y-auto scrollbar-thin">-</p>
                            </div>
                            <div class="p-3 rounded-lg bg-white/5">
                                <h3 class="text-lg font-semibold text-amber-300 mb-1">Sugestões de Ação (IA):</h3>
                                <ul id="actionSuggestionsOutput" class="text-sm text-cu-text-dim list-disc pl-5"><li>Aguardando análise...</li></ul>
                            </div>
                        </div>
                         <div class="flex flex-col sm:flex-row gap-3 mt-3">
                            <button id="downloadAnalysisTxtButton" class="cu-btn text-xs w-full sm:w-auto">
                                <i class="fas fa-file-alt mr-1.5"></i>TXT
                            </button>
                            <button id="downloadAnalysisPdfButton" class="cu-btn text-xs w-full sm:w-auto">
                                <i class="fas fa-file-pdf mr-1.5"></i>PDF
                            </button>
                            <button id="exportToCalendarButton" class="cu-btn text-xs w-full sm:w-auto">
                                <i class="fas fa-calendar-plus mr-1.5"></i>Calendário (ICS)
                            </button>
                        </div>
                         <div id="loaderAi" class="text-center py-4 hidden">
                            <div class="loader inline-block"></div>
                            <p class="text-sm text-amber-300 mt-2">CapyCronos IA está calculando os prazos...</p>
                        </div>
                        <p id="errorMsg" class="text-red-400 text-sm mt-2 text-center"></p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="pdfReportContentDetails"></div>

    <script>
        const currentPageId = 'CapyCronosLegal'; 
        let apiKey = '';
        const API_KEY_STORAGE_KEY = 'capyUniverseApiKey_gemini';
        let lastDeadlineAnalysis = null;

        const domElements = {
            sidebar: document.getElementById('sidebar'),
            documentInput: document.getElementById('documentInput'),
            deadlineTypeInput: document.getElementById('deadlineType'),
            referenceDateInput: document.getElementById('referenceDate'),
            analyzeDeadlinesButton: document.getElementById('analyzeDeadlinesButton'),
            identifiedDeadlineOutput: document.getElementById('identifiedDeadlineOutput'),
            calculatedDueDateOutput: document.getElementById('calculatedDueDateOutput'),
            countdownOutput: document.getElementById('countdownOutput'),
            relevantTextOutput: document.getElementById('relevantTextOutput'),
            actionSuggestionsOutput: document.getElementById('actionSuggestionsOutput'),
            downloadTxtButton: document.getElementById('downloadAnalysisTxtButton'),
            downloadPdfButton: document.getElementById('downloadAnalysisPdfButton'),
            exportToCalendarButton: document.getElementById('exportToCalendarButton'),
            pdfReportContentDetails: document.getElementById('pdfReportContentDetails'),
            loaderAi: document.getElementById('loaderAi'),
            errorMsg: document.getElementById('errorMsg')
        };
        
        function toggleLoadingUI(buttonElement, isLoading) {
            const btnText = buttonElement.querySelector('.btn-text');
            const loaderIcon = buttonElement.querySelector('.loader');
            buttonElement.disabled = isLoading;
            domElements.loaderAi.classList.toggle('hidden', !isLoading);

            if(isLoading) {
                if(btnText) btnText.classList.add('hidden');
                if(loaderIcon) loaderIcon.classList.remove('hidden');
            } else {
                if(btnText) btnText.classList.remove('hidden');
                if(loaderIcon) loaderIcon.classList.add('hidden');
            }
        }

        async function handleAnalyzeDeadlines() {
            if (!apiKey) {
                domElements.errorMsg.textContent = "Chave API Gemini não configurada. Por favor, configure-a no menu 'Chaves API'.";
                return;
            }
            domElements.errorMsg.textContent = "";

            const docText = domElements.documentInput.value.trim();
            const deadlineType = domElements.deadlineTypeInput.value.trim();
            const referenceDateStr = domElements.referenceDateInput.value;

            if (!docText || !deadlineType || !referenceDateStr) {
                domElements.errorMsg.textContent = "Por favor, preencha todos os campos: documento, tipo de prazo e data de referência.";
                return;
            }
            
            const referenceDate = new Date(referenceDateStr + "T00:00:00");
            if (isNaN(referenceDate.getTime())) {
                 domElements.errorMsg.textContent = "Data de referência inválida.";
                return;
            }

            toggleLoadingUI(domElements.analyzeDeadlinesButton, true);
            ["identifiedDeadlineOutput", "calculatedDueDateOutput", "countdownOutput", "relevantTextOutput"].forEach(id => domElements[id].textContent = "Analisando...");
            domElements.actionSuggestionsOutput.innerHTML = '<li>Analisando...</li>';
            lastDeadlineAnalysis = null;

            const promptToGemini = `
                Você é CapyCronos, um assistente jurídico especializado em identificar e calcular prazos processuais e contratuais em documentos.
                Analise o seguinte texto de um documento jurídico:
                """
                ${docText}
                """

                O usuário está interessado em prazos relacionados a: "${deadlineType}".
                A data de referência para contagem (ex: data da intimação, publicação ou assinatura), fornecida pelo usuário, é: ${referenceDate.toLocaleDateString('pt-BR')}.

                Com base no texto e na data de referência, identifique:
                1.  "prazoMencionado": Descreva o prazo legal/contratual específico encontrado no texto relacionado a "${deadlineType}" (ex: "15 dias para apresentar contestação", "pagamento em 30 dias corridos"). Se não encontrar um prazo explícito para "${deadlineType}", indique "Nenhum prazo específico encontrado para '${deadlineType}' no texto.".
                2.  "baseCalculo": O evento ou data que inicia a contagem do prazo, conforme o texto (ex: "a partir da data da publicação desta intimação", "contados da assinatura deste instrumento"). Se não explícito, indique "Data de referência informada pelo usuário".
                3.  "duracaoPrazoDias": O número de dias CORRIDOS para o prazo. Se o prazo for em dias úteis, converta para uma estimativa de dias corridos (multiplique por 7/5 aproximadamente). Se for uma data específica, retorne 0. Se não houver duração em dias, retorne 0.
                4.  "dataLimiteTexto": Se o texto mencionar uma data limite explícita para o prazo (formato DD/MM/AAAA), extraia-a. Caso contrário, deixe em branco.
                5.  "trechoRelevante": O trecho exato do texto (máximo 200 caracteres) onde o prazo é mencionado ou pode ser inferido.
                6.  "sugestoesAcao": Uma lista de 2-3 sugestões de ações que o usuário deveria considerar em relação a este prazo (ex: "Preparar a petição de apelação.", "Realizar o pagamento até a data.", "Agendar lembrete para o dia anterior ao vencimento.").

                Se não encontrar informações claras para algum campo, retorne uma string vazia "" para esse campo ou uma indicação como "Não identificado".

                Responda APENAS com um objeto JSON contendo estas chaves.
            `;
            
            try {
                const payload = {
                    contents: [{ parts: [{ text: promptToGemini }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData?.error?.message || `Erro na API: ${response.status}`);
                }
                const result = await response.json();

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    const aiData = JSON.parse(result.candidates[0].content.parts[0].text);
                    lastDeadlineAnalysis = { ...aiData, referenceDate };

                    domElements.identifiedDeadlineOutput.textContent = aiData.prazoMencionado || "Não identificado";
                    domElements.relevantTextOutput.textContent = aiData.trechoRelevante || "Nenhum trecho específico destacado.";
                    domElements.actionSuggestionsOutput.innerHTML = aiData.sugestoesAcao?.length > 0 
                        ? aiData.sugestoesAcao.map(s => `<li>${s}</li>`).join('') 
                        : '<li>Nenhuma sugestão de ação específica.</li>';

                    let calculatedDueDate = null;
                    if (aiData.dataLimiteTexto) {
                        const parts = aiData.dataLimiteTexto.split('/');
                        if (parts.length === 3) calculatedDueDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    } else if (aiData.duracaoPrazoDias > 0) {
                        calculatedDueDate = new Date(referenceDate.getTime());
                        calculatedDueDate.setDate(referenceDate.getDate() + aiData.duracaoPrazoDias);
                    }

                    if (calculatedDueDate && !isNaN(calculatedDueDate.getTime())) {
                        lastDeadlineAnalysis.calculatedDueDate = calculatedDueDate;
                        domElements.calculatedDueDateOutput.textContent = calculatedDueDate.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                        
                        const now = new Date();
                        const diffTime = calculatedDueDate.getTime() - now.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        domElements.countdownOutput.classList.remove('text-red-400', 'text-yellow-400', 'text-emerald-400', 'font-bold');
                        if (diffDays < 0) {
                            domElements.countdownOutput.textContent = `Expirado há ${Math.abs(diffDays)} dia(s).`;
                            domElements.countdownOutput.classList.add('text-red-400');
                        } else if (diffDays === 0) {
                            domElements.countdownOutput.textContent = "Termina Hoje!";
                            domElements.countdownOutput.classList.add('text-red-500','font-bold');
                        } else {
                            domElements.countdownOutput.textContent = `${diffDays} dia(s) restante(s).`;
                            domElements.countdownOutput.classList.add(diffDays <= 7 ? 'text-yellow-400' : 'text-emerald-400');
                        }
                    } else {
                        domElements.calculatedDueDateOutput.textContent = "Não foi possível calcular.";
                        domElements.countdownOutput.textContent = "-";
                    }

                } else {
                    throw new Error(result.promptFeedback?.blockReason ? `Conteúdo bloqueado: ${result.promptFeedback.blockReason}` : "Resposta da API inválida.");
                }

            } catch (error) {
                console.error("Erro ao analisar prazos:", error);
                domElements.errorMsg.textContent = `Erro: ${error.message}`;
            } finally {
                toggleLoadingUI(domElements.analyzeDeadlinesButton, false);
            }
        }
        
        function formatICSDate(date) {
            if (!date || isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0].replace(/-/g, '');
        }

        function exportToCalendar() {
            if (!lastDeadlineAnalysis?.calculatedDueDate) {
                alert("Nenhum prazo calculado para exportar.");
                return;
            }
            const { prazoMencionado, trechoRelevante, sugestoesAcao, calculatedDueDate } = lastDeadlineAnalysis;

            const startDate = formatICSDate(calculatedDueDate);
            const summary = `Prazo CapyCronos: ${prazoMencionado || 'Prazo Jurídico'}`;
            let description = `Detalhes do Prazo:\nReferência no Documento: ${trechoRelevante || 'Não especificado'}\n\n`;
            if (sugestoesAcao?.length > 0) {
                description += "Sugestões de Ação:\n" + sugestoesAcao.map(s => `- ${s}`).join('\n');
            }
            description = description.replace(/\n/g, '\\n');

            const uid = `capycronos-${Date.now()}@capyuniverse.com`;
            const dtstamp = new Date().toISOString().replace(/[-:.]/g, '').substring(0, 15) + 'Z';

            const icsContent = `BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//CapyCronosLegal//CapyUniverse IA//PT\r\nBEGIN:VEVENT\r\nUID:${uid}\r\nDTSTAMP:${dtstamp}\r\nDTSTART;VALUE=DATE:${startDate}\r\nSUMMARY:${summary}\r\nDESCRIPTION:${description}\r\nEND:VEVENT\r\nEND:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `prazo_capycronos.ics`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function downloadAnalysis(format) {
            if (!lastDeadlineAnalysis) {
                alert("Nenhuma análise para exportar.");
                return;
            }
            // ... (rest of the function remains the same, just ensure it uses the new class names if it manipulates the DOM)
        }
        
        async function renderSidebar() { /* ... standard sidebar logic ... */ }

        function loadApiKey() {
            const savedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if(savedKey) {
                apiKey = savedKey;
            } else {
                 domElements.errorMsg.textContent = "Atenção: Chave API Gemini não configurada.";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // renderSidebar(); // This will be handled by the global script if needed
            loadApiKey();
            domElements.referenceDateInput.valueAsDate = new Date();
            
            domElements.analyzeDeadlinesButton.addEventListener('click', handleAnalyzeDeadlines);
            domElements.downloadTxtButton.addEventListener('click', () => downloadAnalysis('txt'));
            domElements.downloadPdfButton.addEventListener('click', () => downloadAnalysis('pdf'));
            domElements.exportToCalendarButton.addEventListener('click', exportToCalendar);
        });
    </script>
</body>
</html>

