<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapyConcilia Fácil - Gerador de Acordos com IA</title>
    <!-- Tailwind para estilos rápidos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FileSaver para downloads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Docx para exportação de documentos Word -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.5.0/docx.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png">
    <!-- Estilos compartilhados do CapyUniverse -->
    <link rel="stylesheet" href="cu-style.css">
    <script src="cu-navigation.js" defer></script>

    <style>
        /* Estilos específicos desta ferramenta */
        .font-jetbrains { font-family: 'JetBrains Mono', monospace; }
        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Ajustes para os sliders personalizados */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track {
            background: var(--cu-bg-1);
            height: 6px;
            border-radius: 3px;
            border: 1px solid #ffffff1a;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            margin-top: -7px;
            background: var(--premium-gradient);
            height: 20px;
            width: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--cu-bg-0);
            transition: transform .2s;
        }
        input[type=range]:hover::-webkit-slider-thumb { transform: scale(1.1); }
        input[type=range]::-moz-range-track {
            background: var(--cu-bg-1);
            height: 6px;
            border-radius: 3px;
            border: 1px solid #ffffff1a;
        }
        input[type=range]::-moz-range-thumb {
            background: var(--premium-gradient);
            height: 20px;
            width: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--cu-bg-0);
        }
    </style>

<!-- gtag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3FFD7ZEBN1"></script>
  <script>
    window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}
    gtag('js', new Date()); gtag('config','G-3FFD7ZEBN1',{page_path:location.pathname});
  </script>

</head>

<body class="min-h-screen flex flex-col">
    <!-- Cabeçalho padrão CapyUniverse -->
    <header class="cu-header">
        <div class="cu-brand">
            <a href="index.html" class="flex items-center gap-2 group">
                <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png" alt="CapyUniverse logo"></div>
                <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
            </a>
            <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyConciliador</span>
        </div>
        <div class="flex items-center gap-2">
            <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
        </div>
    </header>

    <div id="notificationArea"></div>

    <div class="flex flex-1">
        <!-- Sidebar carregada dinamicamente via cu-navigation.js -->
        <aside id="sidebar" class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin">
            <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
        </aside>

        <!-- Área principal -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
            <section class="cu-panel p-4 sm:p-6 flex flex-col h-full">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold" style="color: var(--cu-purple)">CapyConcilia Fácil 🤝</h1>
                    <p class="text-cu-text-dim mt-1">Gere sugestões de acordo com a inteligência e serenidade de uma capivara mediadora.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <!-- Coluna esquerda: entrada e parâmetros -->
                    <div class="lg:col-span-2 flex flex-col space-y-6">
                        <div class="cu-panel bg-transparent p-5">
                            <h2 class="text-xl font-bold text-cu-text pb-2 mb-4">1. Descrição do Caso</h2>
                            <textarea id="caseDescription" class="cu-textarea w-full" rows="8" placeholder="Insira a descrição completa do caso aqui, incluindo os fatos, as alegações das partes e os valores envolvidos..."></textarea>
                        </div>
                        <div class="cu-panel bg-transparent p-5">
                            <h2 class="text-xl font-bold text-cu-text pb-2 mb-4">2. Parâmetros da Negociação</h2>
                            <div class="space-y-5">
                                <div>
                                    <label for="riskSlider" class="flex justify-between text-sm font-medium text-cu-text-dim mb-1">
                                        <span>Risco do Caso</span><span id="riskValue" class="font-jetbrains text-purple-300">50%</span>
                                    </label>
                                    <input type="range" id="riskSlider" min="0" max="100" value="50" class="w-full">
                                    <p class="text-xs mt-1 text-cu-text-dim italic">Indica a probabilidade de perda ou ganho. Níveis altos sugerem mais concessões.</p>
                                </div>
                                <div>
                                    <label for="urgencySlider" class="flex justify-between text-sm font-medium text-cu-text-dim mb-1">
                                        <span>Urgência de Resolução</span><span id="urgencyValue" class="font-jetbrains text-purple-300">50%</span>
                                    </label>
                                    <input type="range" id="urgencySlider" min="0" max="100" value="50" class="w-full">
                                    <p class="text-xs mt-1 text-cu-text-dim italic">Reflete a necessidade de encerrar a disputa rapidamente. Quanto maior, mais flexibilidade pode ser necessária.</p>
                                </div>
                                <div>
                                    <label for="costSlider" class="flex justify-between text-sm font-medium text-cu-text-dim mb-1">
                                        <span>Custo do Litígio</span><span id="costValue" class="font-jetbrains text-purple-300">50%</span>
                                    </label>
                                    <input type="range" id="costSlider" min="0" max="100" value="50" class="w-full">
                                    <p class="text-xs mt-1 text-cu-text-dim italic">Representa o investimento financeiro e emocional do processo. Pontuações elevadas incentivam acordos mais rápidos.</p>
                                </div>
                            </div>
                        </div>
                        <button id="generateSuggestionsButton" class="cu-btn primary text-base w-full flex items-center justify-center gap-2">
                            <span class="btn-text">Gerar Sugestões de Acordo</span>
                            <div class="loader hidden"></div>
                        </button>
                    </div>

                    <!-- Coluna direita: resultados -->
                    <div class="lg:col-span-3 space-y-4">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-cu-text">3. Sugestões Geradas</h2>
                            <button id="exportSuggestionsButton" class="cu-btn invisible">
                                <i class="fas fa-file-word mr-2"></i>Exportar Sugestões
                            </button>
                        </div>
                        <div id="suggestionsContainer" class="space-y-4 max-h-[70vh] overflow-y-auto scrollbar-thin pr-2">
                            <div class="text-center text-cu-text-dim pt-16 flex flex-col items-center">
                                <i class="fas fa-gavel text-4xl mb-3"></i>
                                <p>As sugestões de acordo aparecerão aqui.</p>
                            </div>
                        </div>
                        <p id="errorMessage" class="text-red-400 text-sm mt-2 text-center"></p>

                        <!-- Seção da Minuta gerada -->
                        <div id="draftContainer" class="hidden mt-6 cu-panel bg-transparent p-5">
                            <h2 class="text-xl font-bold text-cu-text pb-2 mb-4">4. Minuta do Acordo</h2>
                            <div id="draftLoader" class="text-center text-cu-text-dim py-8 hidden">
                                <div class="loader inline-block"></div>
                                <p class="mt-2">CapyAdvogado está redigindo a minuta...</p>
                            </div>
                            <textarea id="draftOutput" class="cu-textarea w-full hidden" rows="12"></textarea>
                            <div class="mt-3 flex flex-col sm:flex-row gap-3">
                                <button id="copyDraftButton" class="cu-btn w-full hidden">
                                    <i class="fas fa-copy mr-2"></i>Copiar texto
                                </button>
                                <button id="exportDraftDocxButton" class="cu-btn w-full hidden">
                                    <i class="fas fa-file-word mr-2"></i>Exportar Docx
                                </button>
                                <button id="exportDraftTxtButton" class="cu-btn w-full hidden">
                                    <i class="fas fa-file-alt mr-2"></i>Exportar TXT
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
    /* =====================================
       Variáveis globais e objetos DOM
    ===================================== */
    const currentPageId = 'CapyConciliaFacil';
    const API_KEY_STORAGE_KEY = 'capyUniverseApiKey_gemini';
    let apiKey = '';
    let lastSuggestions = null;

    // Objetos DOM principais
    const dom = {
        sidebar: document.getElementById('sidebar'),
        caseDescription: document.getElementById('caseDescription'),
        riskSlider: document.getElementById('riskSlider'),
        urgencySlider: document.getElementById('urgencySlider'),
        costSlider: document.getElementById('costSlider'),
        riskValue: document.getElementById('riskValue'),
        urgencyValue: document.getElementById('urgencyValue'),
        costValue: document.getElementById('costValue'),
        generateSuggestionsButton: document.getElementById('generateSuggestionsButton'),
        suggestionsContainer: document.getElementById('suggestionsContainer'),
        exportSuggestionsButton: document.getElementById('exportSuggestionsButton'),
        errorMessage: document.getElementById('errorMessage'),
        draftContainer: document.getElementById('draftContainer'),
        draftLoader: document.getElementById('draftLoader'),
        draftOutput: document.getElementById('draftOutput'),
        copyDraftButton: document.getElementById('copyDraftButton'),
        exportDraftDocxButton: document.getElementById('exportDraftDocxButton'),
        exportDraftTxtButton: document.getElementById('exportDraftTxtButton')
    };

    /* =====================================
       Utilitário: Alternar estado de loading em botões
    ===================================== */
    function toggleLoading(button, isLoading, loadingText = 'Gerando...') {
        const btnText = button.querySelector('.btn-text');
        const loader = button.querySelector('.loader');
        button.disabled = isLoading;
        if (isLoading) {
            if (btnText) btnText.textContent = loadingText;
            if (loader) loader.classList.remove('hidden');
        } else {
            if (btnText) btnText.textContent = 'Gerar Sugestões de Acordo';
            if (loader) loader.classList.add('hidden');
        }
    }

    /* =====================================
       Função principal: gerar sugestões de acordo
    ===================================== */
    async function generateAgreementSuggestions() {
        if (!apiKey) {
            dom.errorMessage.textContent = "Chave API Gemini não configurada. Por favor, configure-a no menu 'Chaves API'.";
            return;
        }
        dom.errorMessage.textContent = '';
        const caseDesc = dom.caseDescription.value.trim();
        if (!caseDesc) {
            dom.errorMessage.textContent = 'Por favor, insira a descrição do caso.';
            return;
        }
        // Reset UI
        toggleLoading(dom.generateSuggestionsButton, true, 'Gerando...');
        dom.suggestionsContainer.innerHTML = `<div class="text-center text-cu-text-dim pt-16 flex flex-col items-center"><div class="loader"></div><p class="mt-3">CapyConciliador está analisando o caso...</p></div>`;
        dom.exportSuggestionsButton.classList.add('invisible');
        dom.draftContainer.classList.add('hidden');
        lastSuggestions = null;
        // Construção do prompt para o modelo Gemini
        const prompt = [
            'Aja como "CapyConciliador", um mediador e advogado experiente focado em encontrar soluções amigáveis para disputas.',
            'Analise a seguinte descrição de caso e os parâmetros de negociação para gerar 3 sugestões de acordo distintas e realistas.',
            '',
            '**Descrição do Caso:**',
            '"""',
            caseDesc,
            '"""',
            '',
            '**Parâmetros de Negociação (0 = baixo, 100 = alto):**',
            '- Risco do Caso (para o seu cliente): ' + dom.riskSlider.value,
            '- Urgência de Resolução: ' + dom.urgencySlider.value,
            '- Custo Estimado do Litígio: ' + dom.costSlider.value,
            '',
            'Para cada sugestão, forneça os seguintes detalhes em formato JSON. A resposta final deve ser um array de objetos JSON.',
            '',
            '**Formato de Resposta JSON:**',
            '[',
            '    {',
            '        "valorSugerido": "Descreva o valor monetário ou a principal condição do acordo (ex: \"R$ 15.000,00 em 3 parcelas\", \"Devolução do produto e pedido de desculpas formal\").",',
            '        "pontosFortes": ["Liste o principal benefício desta sugestão.", "Liste outro ponto positivo, como rapidez ou baixo custo."],',
            '        "pontosFracos": ["Liste uma possível desvantagem ou o que se está abrindo mão.", "Liste outro ponto a ser considerado."],',
            '        "impactoLegal": "Descreva brevemente o impacto legal deste acordo (ex: \"Quitação total das obrigações, sem reconhecimento de culpa.\", \"Encerramento do processo com resolução de mérito.\")"',
            '    }',
            ']',
            '',
            'Gere 3 objetos no array, variando as propostas desde uma mais conservadora até uma mais ousada, considerando os parâmetros de risco e urgência.',
            'Seja criativo, mas mantenha as sugestões plausíveis dentro de um contexto jurídico.',
            'Responda APENAS com o array JSON.'
        ].join('\n');
        try {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: 'application/json' }
            };
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData?.error?.message || 'Erro na API: ' + response.status);
            }
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) {
                lastSuggestions = JSON.parse(text);
                displaySuggestions(lastSuggestions);
            } else {
                throw new Error('Resposta da IA vazia ou em formato inesperado.');
            }
        } catch (err) {
            console.error(err);
            dom.errorMessage.textContent = 'Erro: ' + err.message;
            dom.suggestionsContainer.innerHTML = '<p class="text-center text-red-400">Falha ao gerar sugestões. Tente novamente.</p>';
        } finally {
            toggleLoading(dom.generateSuggestionsButton, false);
        }
    }

    /* =====================================
       Renderiza as sugestões na interface
    ===================================== */
    function displaySuggestions(suggestions) {
        dom.suggestionsContainer.innerHTML = '';
        if (!suggestions || !suggestions.length) {
            dom.suggestionsContainer.innerHTML = '<p class="text-center text-cu-text-dim">Nenhuma sugestão gerada.</p>';
            return;
        }
        suggestions.forEach((sugg, index) => {
            const card = document.createElement('div');
            card.className = 'cu-panel bg-transparent p-4 flex flex-col space-y-3';
            card.innerHTML = `
                <div>
                    <span class="text-xs font-bold text-purple-400 uppercase">Sugestão ${index + 1}</span>
                    <p class="text-2xl font-bold text-white mt-1">${sugg.valorSugerido}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <h3 class="font-semibold text-emerald-300 mb-1">Pontos Fortes</h3>
                        <ul class="list-disc list-inside text-cu-text-dim space-y-1">${sugg.pontosFortes.map(p => `<li>${p}</li>`).join('')}</ul>
                    </div>
                    <div>
                        <h3 class="font-semibold text-red-300 mb-1">Pontos Fracos / Concessões</h3>
                        <ul class="list-disc list-inside text-cu-text-dim space-y-1">${sugg.pontosFracos.map(p => `<li>${p}</li>`).join('')}</ul>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-sky-300 mb-1">Impacto Legal Previsto</h3>
                    <p class="text-sm text-cu-text-dim">${sugg.impactoLegal}</p>
                </div>
                <div class="mt-2 self-start">
                    <button class="cu-btn text-sm">✨ Elaborar Minuta do Acordo</button>
                </div>
            `;
            card.querySelector('.cu-btn').addEventListener('click', (e) => {
                handleDraftAgreement(sugg, e.currentTarget);
            });
            dom.suggestionsContainer.appendChild(card);
        });
        dom.exportSuggestionsButton.classList.remove('invisible');
    }

    /* =====================================
       Geração da minuta a partir da sugestão
    ===================================== */
    async function handleDraftAgreement(suggestionData, buttonElement) {
        if (!apiKey) {
            alert('Configure sua chave API do Gemini para elaborar a minuta.');
            return;
        }
        const original = buttonElement.innerHTML;
        buttonElement.innerHTML = '<div class="loader"></div>';
        buttonElement.disabled = true;
        dom.draftContainer.classList.remove('hidden');
        dom.draftLoader.classList.remove('hidden');
        dom.draftOutput.classList.add('hidden');
        dom.copyDraftButton.classList.add('hidden');
        dom.exportDraftDocxButton.classList.add('hidden');
        dom.exportDraftTxtButton.classList.add('hidden');
        const caseDesc = dom.caseDescription.value.trim();
        // Prompt detalhado para gerar a minuta
        const prompt = [
            'Você é o CapyAdvogado, um especialista em redação de documentos jurídicos.',
            'Com base na descrição do caso e na sugestão de acordo específica abaixo, elabore uma minuta de "Termo de Acordo Extrajudicial".',
            '',
            '**Descrição do Caso:**',
            '"""',
            caseDesc,
            '"""',
            '',
            '**Sugestão de Acordo Escolhida:**',
            '- Termos Principais: "' + suggestionData.valorSugerido + '"',
            '- Impacto Legal Previsto: "' + suggestionData.impactoLegal + '"',
            '',
            '**Instruções para a Minuta:**',
            '1. Crie um título claro: "TERMO DE ACORDO EXTRAJUDICIAL".',
            '2. Inclua uma seção para a qualificação das partes, usando placeholders claros (ex: [NOME COMPLETO PARTE A], [CPF/CNPJ], [ENDEREÇO COMPLETO]).',
            '3. Descreva o "OBJETO DO ACORDO" de forma sucinta, com base na descrição do caso.',
            '4. Detalhe as "CLÁUSULAS E CONDIÇÕES", incorporando os termos da sugestão de acordo (valor, forma de pagamento, obrigações de fazer/não fazer, etc.).',
            '5. Adicione uma cláusula de "QUITAÇÃO", mencionando o impacto legal previsto.',
            '6. Finalize com placeholders para local, data e assinaturas das partes e testemunhas.',
            '7. Inclua um aviso final, em negrito, de que "Este documento é uma minuta preliminar gerada por IA e deve ser revisada e ajustada por um profissional do direito antes de sua utilização."',
            '',
            'Responda apenas com o texto completo da minuta, formatado para ser lido em um editor de texto.'
        ].join('\n');
        try {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData?.error?.message || 'Erro na API: ' + response.status);
            }
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) {
                dom.draftOutput.value = text.trim();
                dom.draftOutput.classList.remove('hidden');
                dom.copyDraftButton.classList.remove('hidden');
                dom.exportDraftDocxButton.classList.remove('hidden');
                dom.exportDraftTxtButton.classList.remove('hidden');
            } else {
                throw new Error('A IA não retornou um rascunho válido.');
            }
        } catch (err) {
            console.error(err);
            dom.draftOutput.value = 'Erro ao gerar a minuta: ' + err.message;
            dom.draftOutput.classList.remove('hidden');
        } finally {
            dom.draftLoader.classList.add('hidden');
            buttonElement.innerHTML = original;
            buttonElement.disabled = false;
        }
    }

    /* =====================================
       Função de cópia da minuta para a área de transferência
    ===================================== */
    function copyDraftText() {
        dom.draftOutput.select();
        document.execCommand('copy');
        dom.copyDraftButton.innerHTML = '<i class="fas fa-check mr-2"></i>Copiado!';
        setTimeout(() => {
            dom.copyDraftButton.innerHTML = '<i class="fas fa-copy mr-2"></i>Copiar texto';
        }, 2000);
    }

    /* =====================================
       Exportar sugestões para DOCX
    ===================================== */
    function exportSuggestions() {
        if (!lastSuggestions || !lastSuggestions.length) {
            alert('Não há sugestões para exportar.');
            return;
        }
        // Cria HTML estruturado para Word
        let html = '<html><head><meta charset="UTF-8"><title>Sugestões de Acordo</title>' +
            '<style>body { font-family: \"Times New Roman\", Times, serif; font-size: 12pt; }' +
            'h1 { font-size: 18pt; text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }' +
            'h2 { font-size: 16pt; margin-top: 20px; }' +
            'h3 { font-size: 14pt; margin-top: 15px; }' +
            'ul { padding-left: 20px; }</style>
<!-- gtag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3FFD7ZEBN1"></script>
  <script>
    window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}
    gtag('js', new Date()); gtag('config','G-3FFD7ZEBN1',{page_path:location.pathname});
  </script>

</head><body>';
        html += '<h1>Sugestões de Acordo - CapyConcilia Fácil</h1>';
        html += '<p><strong>Descrição do Caso Analisado:</strong></p>';
        html += '<p><em>' + dom.caseDescription.value.replace(/\n/g, '<br>') + '</em></p><hr>';
        lastSuggestions.forEach((s, idx) => {
            html += `<h2>Sugestão ${idx + 1}: ${s.valorSugerido}</h2>`;
            html += '<h3>Pontos Fortes</h3><ul>' + s.pontosFortes.map(p => `<li>${p}</li>`).join('') + '</ul>';
            html += '<h3>Pontos Fracos / Concessões</h3><ul>' + s.pontosFracos.map(p => `<li>${p}</li>`).join('') + '</ul>';
            html += '<h3>Impacto Legal Previsto</h3><p>' + s.impactoLegal + '</p>';
        });
        html += '</body></html>';
        const blob = new Blob([html], { type: 'application/msword;charset=utf-8' });
        saveAs(blob, 'sugestoes_de_acordo_capyconcilia.doc');
    }

    /* =====================================
       Exportar minuta: Docx
    ===================================== */
    async function exportDraftToDocx() {
        const text = dom.draftOutput.value;
        if (!text.trim()) {
            alert('Não há minuta para exportar.');
            return;
        }
        // Cria um documento Word usando a biblioteca docx
        const { Document, Packer, Paragraph, TextRun } = window.docx;
        const doc = new Document({ sections: [{ properties: {}, children: [] }] });
        const lines = text.split(/\r?\n/);
        lines.forEach(line => {
            doc.addSection({
                children: [new Paragraph({ children: [new TextRun(line)] })]
            });
        });
        const blob = await Packer.toBlob(doc);
        saveAs(blob, 'minuta_acordo_capyconcilia.docx');
    }

    /* =====================================
       Exportar minuta: TXT simples
    ===================================== */
    function exportDraftToTxt() {
        const text = dom.draftOutput.value;
        if (!text.trim()) {
            alert('Não há minuta para exportar.');
            return;
        }
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        saveAs(blob, 'minuta_acordo_capyconcilia.txt');
    }

    /* =====================================
       Atualização de valores dos sliders
    ===================================== */
    function updateSliderValue(slider, display) {
        display.textContent = slider.value + '%';
    }

    /* =====================================
       Carrega e renderiza a sidebar a partir de tools.json
    ===================================== */
    async function renderSidebar() {
        if (!dom.sidebar) return;
        try {
            const response = await fetch('tools.json');
            if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
            const toolsData = await response.json();
            const categories = {};
            toolsData.forEach(tool => {
                let cats = tool.category;
                if (typeof cats === 'string') cats = [cats];
                if (Array.isArray(cats)) {
                    cats.forEach(cat => {
                        if (!categories[cat]) categories[cat] = [];
                        categories[cat].push(tool);
                    });
                }
            });
            dom.sidebar.innerHTML = '';
            const homeLink = document.createElement('a');
            homeLink.href = 'index.html';
            homeLink.className = 'sidebar-link flex items-center gap-2 p-2 rounded-md';
            homeLink.innerHTML = '<i class="fas fa-home w-5 text-center text-purple-400"></i><span>Página Inicial</span>';
            dom.sidebar.appendChild(homeLink);
            for (const catName in categories) {
                const catDiv = document.createElement('div');
                const catButton = document.createElement('button');
                catButton.className = 'w-full flex justify-between items-center p-2 text-left text-cu-text-dim hover:text-cu-text hover:bg-white/5 rounded-md';
                catButton.innerHTML = '<span class="font-semibold text-sm">' + catName + '</span><i class="fas fa-chevron-down w-4 h-4 transform transition-transform duration-200"></i>';
                const catContent = document.createElement('div');
                catContent.className = 'category-content pl-3 pt-1 space-y-1';
                categories[catName].forEach(tool => {
                    const link = document.createElement('a');
                    link.href = tool.pageUrl;
                    link.className = 'sidebar-link flex items-center gap-2 p-1.5 rounded-md text-xs' + (tool.id === currentPageId ? ' active' : '');
                    link.innerHTML = '<span class="w-5 text-center">' + (tool.icon || '✨') + '</span><span>' + tool.title + '</span>';
                    catContent.appendChild(link);
                });
                catButton.addEventListener('click', () => {
                    catContent.classList.toggle('expanded');
                    catButton.querySelector('i').classList.toggle('rotate-180');
                });
                if (categories[catName].some(t => t.id === currentPageId)) {
                    catContent.classList.add('expanded');
                    catButton.querySelector('i').classList.add('rotate-180');
                }
                catDiv.appendChild(catButton);
                catDiv.appendChild(catContent);
                dom.sidebar.appendChild(catDiv);
            }
        } catch (err) {
            console.error(err);
            dom.sidebar.innerHTML = '<p class="text-xs text-red-400 p-2">Erro ao carregar menu.</p>';
        }
    }

    /* =====================================
       Carrega a chave de API salva
    ===================================== */
    function loadApiKey() {
        const saved = localStorage.getItem(API_KEY_STORAGE_KEY);
        if (saved) apiKey = saved;
        else dom.errorMessage.textContent = 'Atenção: Chave API Gemini não configurada. A análise de IA não funcionará.';
    }

    /* =====================================
       Configuração inicial de eventos
    ===================================== */
    document.addEventListener('DOMContentLoaded', () => {
        renderSidebar();
        loadApiKey();
        dom.riskSlider.addEventListener('input', () => updateSliderValue(dom.riskSlider, dom.riskValue));
        dom.urgencySlider.addEventListener('input', () => updateSliderValue(dom.urgencySlider, dom.urgencyValue));
        dom.costSlider.addEventListener('input', () => updateSliderValue(dom.costSlider, dom.costValue));
        dom.generateSuggestionsButton.addEventListener('click', generateAgreementSuggestions);
        dom.exportSuggestionsButton.addEventListener('click', exportSuggestions);
        dom.copyDraftButton.addEventListener('click', copyDraftText);
        dom.exportDraftDocxButton.addEventListener('click', exportDraftToDocx);
        dom.exportDraftTxtButton.addEventListener('click', exportDraftToTxt);
    });
    </script>
</body>
</html>