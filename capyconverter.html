<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapyConverter - CapyUniverse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
    <link rel="stylesheet" href="cu-style.css">
    <script src="cu-navigation.js" defer></script>

    <style>
        .dropzone { border: 2px dashed #ffffff33; transition: background-color 0.3s; }
        .dropzone.dragover { background-color: #ffffff11; }
        .grid-card { display: flex; flex-direction: column; border-radius: var(--cu-radius); overflow: hidden; background: var(--cu-card); }
    </style>

<!-- gtag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3FFD7ZEBN1"></script>
  <script>
    window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}
    gtag('js', new Date()); gtag('config','G-3FFD7ZEBN1',{page_path:location.pathname});
  </script>

</head>

<body class="min-h-screen flex flex-col">
    <header class="cu-header">
        <div class="cu-brand">
            <a href="index.html" class="flex items-center gap-2 group">
                <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png"></div>
                <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
            </a>
            <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyConverter</span>
        </div>
        <div class="flex items-center gap-2">
            <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
        </div>
    </header>

    <div class="flex flex-1">
        <aside id="sidebar" class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin">
            <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
        </aside>

        <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
            <section class="cu-panel p-4 sm:p-6 flex flex-col h-full">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold" style="color: var(--cu-cyan);">CapyConverter 🌀</h1>
                    <p class="text-cu-text-dim mt-1">Converta imagens, documentos e outros arquivos.</p>
                </div>

                <div class="max-w-4xl mx-auto w-full space-y-8">
                    <div class="cu-panel bg-transparent p-4">
                        <div class="grid md:grid-cols-4 gap-4">
                            <div class="md:col-span-2">
                                <label class="text-sm text-cu-text-dim">Formato de saída</label>
                                <div class="mt-1 grid grid-cols-3 sm:grid-cols-6 gap-2">
                                    <button data-format="image/png" class="fmt cu-btn">PNG</button>
                                    <button data-format="image/jpeg" class="fmt cu-btn">JPG</button>
                                    <button data-format="image/webp" class="fmt cu-btn">WebP</button>
                                    <button data-format="text/plain" class="fmt cu-btn">TXT</button>
                                    <button data-format="text/markdown" class="fmt cu-btn">MD</button>
                                    <button data-format="application/pdf" class="fmt cu-btn">PDF</button>
                                    <button data-format="application/zip" class="fmt cu-btn">ZIP</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-cu-text-dim">Qualidade</label>
                                <input id="quality" type="range" min="0.1" max="1" step="0.05" value="0.9" class="w-full accent-purple-500">
                                <div class="text-xs text-cu-text-dim mt-1"><span id="qval">0.90</span></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="text-sm text-cu-text-dim">Largura</label><input id="maxW" type="number" class="cu-input w-full mt-1" placeholder="auto"></div>
                                <div><label class="text-sm text-cu-text-dim">Altura</label><input id="maxH" type="number" class="cu-input w-full mt-1" placeholder="auto"></div>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center gap-3">
                            <button id="btnConvertAll" class="cu-btn primary"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Converter tudo</button>
                            <a href="#" id="btnExportAll" class="cu-btn"><i class="fa-solid fa-download mr-2"></i>Baixar tudo</a>
                        </div>
                    </div>

                    <div id="dropzone" class="dropzone cu-panel bg-transparent p-5 text-center">
                        <input id="fileInput" type="file" multiple class="absolute inset-0 opacity-0 cursor-pointer" />
                        <p class="text-cu-text-dim"><i class="fa-solid fa-cloud-arrow-up mr-2"></i>Arraste e solte ou <span class="underline">clique para selecionar</span>.</p>
                    </div>

                    <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

                    <template id="cardTmpl">
                        <div class="grid-card">
                            <div class="aspect-video bg-black/30 grid place-items-center overflow-hidden"><img class="preview max-h-full"/><span class="icon-placeholder text-4xl"></span></div>
                            <div class="p-4 space-y-2 text-sm">
                                <div class="flex justify-between"><div class="truncate filename"></div><span class="format badge"></span></div>
                                <div class="text-xs text-cu-text-dim dims"></div>
                                <div class="flex gap-2 pt-1">
                                    <button class="btnConvert cu-btn primary text-sm"><i class="fa-solid fa-repeat mr-2"></i>Converter</button>
                                    <a class="btnDownload cu-btn text-sm" download><i class="fa-solid fa-download mr-2"></i>Baixar</a>
                                </div>
                                <div class="text-xs text-cu-text-dim status"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Element selector helpers. Allows optional scope parameter for nested queries.
        const $ = (sel, scope = document) => scope.querySelector(sel);
        const $$ = (sel, scope = document) => Array.from(scope.querySelectorAll(sel));

        // Internal state for conversion settings and loaded files
        const state = {
            fmt: 'image/png',
            quality: 0.9,
            maxW: null,
            maxH: null,
            files: []
        };

        // Update selected output format and highlight active button
        function setFmt(fmt) {
            state.fmt = fmt;
            $$('.fmt').forEach(b => {
                if (b.dataset.format === fmt) {
                    b.classList.add('primary');
                } else {
                    b.classList.remove('primary');
                }
            });
        }

        // Convert a single file based on the selected output format
        async function convertFile(file, filename) {
            // Image formats (PNG, JPEG, WebP)
            if (state.fmt.startsWith('image/')) {
                if (!file.type.startsWith('image/')) {
                    throw new Error('Apenas imagens podem ser convertidas neste formato.');
                }
                const img = await createImageBitmap(file);
                const canvas = document.createElement('canvas');
                let { width, height } = img;
                // Resize preserving aspect ratio based on user-specified max width/height
                if (state.maxW && width > state.maxW) {
                    height *= state.maxW / width;
                    width = state.maxW;
                }
                if (state.maxH && height > state.maxH) {
                    width *= state.maxH / height;
                    height = state.maxH;
                }
                canvas.width = width;
                canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                return new Promise(resolve => {
                    canvas.toBlob(blob => {
                        const ext = state.fmt.split('/')[1];
                        resolve({
                            blob,
                            outName: filename.replace(/\.[^.]+$/, `.${ext}`),
                            width,
                            height
                        });
                    }, state.fmt, state.fmt === 'image/png' ? undefined : state.quality);
                });
            }
            // PDF export: generate text-based PDF for text, embed image for images
            if (state.fmt === 'application/pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ unit: 'pt' });
                if (file.type.startsWith('image/')) {
                    const dataURL = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(file);
                    });
                    const imgBmp = await createImageBitmap(file);
                    // Fit image to page while preserving aspect ratio
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    let imgW = imgBmp.width;
                    let imgH = imgBmp.height;
                    const ratio = Math.min(pageWidth / imgW, pageHeight / imgH);
                    imgW *= ratio;
                    imgH *= ratio;
                    pdf.addImage(dataURL, file.type.split('/')[1].toUpperCase(), 0, 0, imgW, imgH);
                } else {
                    const text = await file.text();
                    // Split text into lines that fit on the page
                    const margin = 40;
                    const maxLineWidth = pdf.internal.pageSize.getWidth() - margin * 2;
                    const lines = pdf.splitTextToSize(text, maxLineWidth);
                    pdf.text(lines, margin, margin);
                }
                return {
                    blob: pdf.output('blob'),
                    outName: filename.replace(/\.[^.]+$/, '.pdf')
                };
            }
            // Plain text or Markdown
            if (state.fmt === 'text/plain' || state.fmt === 'text/markdown') {
                const text = await file.text();
                const ext = state.fmt === 'text/plain' ? '.txt' : '.md';
                const blob = new Blob([text], { type: `${state.fmt};charset=utf-8` });
                return {
                    blob,
                    outName: filename.replace(/\.[^.]+$/, ext)
                };
            }
            // ZIP: package the original file into a zip archive
            if (state.fmt === 'application/zip') {
                const zip = new JSZip();
                zip.file(filename, await file.arrayBuffer());
                return {
                    blob: await zip.generateAsync({ type: 'blob' }),
                    outName: filename.replace(/\.[^.]+$/, '.zip')
                };
            }
            throw new Error('Formato de saída não suportado.');
        }

        // Create a card element for a selected file and attach event handlers
        function createCard(file) {
            const template = document.getElementById('cardTmpl');
            const node = template.content.firstElementChild.cloneNode(true);
            // Populate filename and file type
            node.querySelector('.filename').textContent = file.name;
            node.querySelector('.format').textContent = file.type || 'desconhecido';
            // Show preview for images or icon for other files
            if (file.type.startsWith('image/')) {
                const previewImg = node.querySelector('.preview');
                previewImg.src = URL.createObjectURL(file);
                node.querySelector('.icon-placeholder').remove();
            } else {
                // Remove the image element for non-image files
                node.querySelector('.preview').remove();
                node.querySelector('.icon-placeholder').innerHTML = '<i class="fas fa-file"></i>';
            }
            // Convert button action
            node.querySelector('.btnConvert').onclick = async () => {
                const status = node.querySelector('.status');
                status.textContent = 'Convertendo...';
                try {
                    const result = await convertFile(file, file.name);
                    const url = URL.createObjectURL(result.blob);
                    const downloadBtn = node.querySelector('.btnDownload');
                    downloadBtn.href = url;
                    downloadBtn.download = result.outName;
                    status.textContent = `Pronto: ${result.outName}`;
                } catch (err) {
                    status.textContent = err.message;
                }
            };
            return node;
        }

        // Add selected files to the grid and internal state
        function addFiles(fileList) {
            const files = Array.from(fileList);
            state.files.push(...files);
            files.forEach(file => {
                document.getElementById('grid').appendChild(createCard(file));
            });
        }

        // Initialize event listeners once the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial format button
            setFmt(state.fmt);
            // Quality slider updates
            document.getElementById('quality').oninput = e => {
                state.quality = parseFloat(e.target.value);
                document.getElementById('qval').textContent = state.quality.toFixed(2);
            };
            // Dimension inputs
            document.getElementById('maxW').onchange = () => {
                const val = parseInt(document.getElementById('maxW').value);
                state.maxW = isNaN(val) ? null : val;
            };
            document.getElementById('maxH').onchange = () => {
                const val = parseInt(document.getElementById('maxH').value);
                state.maxH = isNaN(val) ? null : val;
            };
            // Format button clicks
            $$('.fmt').forEach(btn => {
                btn.addEventListener('click', () => setFmt(btn.dataset.format));
            });
            // File input interactions
            // O próprio input ocupa toda a área da dropzone (com opacity 0), portanto
            // não precisamos disparar manualmente um click no dropzone. Basta ouvir
            // o evento change do input e adicionar os arquivos selecionados. Isso
            // evita que o seletor de arquivos abra duas vezes seguidas.
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', e => {
                if (e.target.files && e.target.files.length) {
                    addFiles(e.target.files);
                    // Limpa o input após adicionar arquivos para permitir selecionar o mesmo arquivo novamente
                    e.target.value = '';
                }
            });
            // Drag-and-drop events
            const dz = document.getElementById('dropzone');
            ['dragenter', 'dragover'].forEach(eventType => {
                dz.addEventListener(eventType, ev => {
                    ev.preventDefault();
                    dz.classList.add('dragover');
                });
            });
            ['dragleave', 'drop'].forEach(eventType => {
                dz.addEventListener(eventType, ev => {
                    ev.preventDefault();
                    dz.classList.remove('dragover');
                });
            });
            dz.addEventListener('drop', ev => {
                if (ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files.length) {
                    addFiles(ev.dataTransfer.files);
                }
            });
            // Convert all files at once
            document.getElementById('btnConvertAll').addEventListener('click', () => {
                document.querySelectorAll('#grid .btnConvert').forEach(btn => btn.click());
            });
            // Export all converted files sequentially with a small delay
            document.getElementById('btnExportAll').addEventListener('click', e => {
                e.preventDefault();
                const links = document.querySelectorAll('#grid .btnDownload[href]');
                links.forEach((link, i) => {
                    setTimeout(() => {
                        link.click();
                    }, i * 200);
                });
            });
        });
    </script>
</body>
</html>

