<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapyConverter - CapyUniverse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
    <link rel="stylesheet" href="cu-style.css">
    <script src="cu-navigation.js" defer></script>

    <style>
        .dropzone { border: 2px dashed #ffffff33; transition: background-color 0.3s; }
        .dropzone.dragover { background-color: #ffffff11; }
        .grid-card { display: flex; flex-direction: column; border-radius: var(--cu-radius); overflow: hidden; background: var(--cu-card); }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <header class="cu-header">
        <div class="cu-brand">
            <a href="index.html" class="flex items-center gap-2 group">
                <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png"></div>
                <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
            </a>
            <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyConverter</span>
        </div>
        <div class="flex items-center gap-2">
            <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
        </div>
    </header>

    <div class="flex flex-1">
        <aside id="sidebar" class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin">
            <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
        </aside>

        <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
            <section class="cu-panel p-4 sm:p-6 flex flex-col h-full">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold" style="color: var(--cu-cyan);">CapyConverter 🌀</h1>
                    <p class="text-cu-text-dim mt-1">Converta imagens, documentos e outros arquivos.</p>
                </div>

                <div class="max-w-4xl mx-auto w-full space-y-8">
                    <div class="cu-panel bg-transparent p-4">
                        <div class="grid md:grid-cols-4 gap-4">
                            <div class="md:col-span-2">
                                <label class="text-sm text-cu-text-dim">Formato de saída</label>
                                <div class="mt-1 grid grid-cols-3 sm:grid-cols-6 gap-2">
                                    <button data-format="image/png" class="fmt cu-btn">PNG</button>
                                    <button data-format="image/jpeg" class="fmt cu-btn">JPG</button>
                                    <button data-format="image/webp" class="fmt cu-btn">WebP</button>
                                    <button data-format="application/pdf" class="fmt cu-btn">PDF</button>
                                    <button data-format="application/zip" class="fmt cu-btn">ZIP</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-cu-text-dim">Qualidade</label>
                                <input id="quality" type="range" min="0.1" max="1" step="0.05" value="0.9" class="w-full accent-purple-500">
                                <div class="text-xs text-cu-text-dim mt-1"><span id="qval">0.90</span></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="text-sm text-cu-text-dim">Largura</label><input id="maxW" type="number" class="cu-input w-full mt-1" placeholder="auto"></div>
                                <div><label class="text-sm text-cu-text-dim">Altura</label><input id="maxH" type="number" class="cu-input w-full mt-1" placeholder="auto"></div>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center gap-3">
                            <button id="btnConvertAll" class="cu-btn primary"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Converter tudo</button>
                            <a href="#" id="btnExportAll" class="cu-btn"><i class="fa-solid fa-download mr-2"></i>Baixar tudo</a>
                        </div>
                    </div>

                    <div id="dropzone" class="dropzone cu-panel bg-transparent p-5 text-center">
                        <input id="fileInput" type="file" multiple class="absolute inset-0 opacity-0 cursor-pointer" />
                        <p class="text-cu-text-dim"><i class="fa-solid fa-cloud-arrow-up mr-2"></i>Arraste e solte ou <span class="underline">clique para selecionar</span>.</p>
                    </div>

                    <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

                    <template id="cardTmpl">
                        <div class="grid-card">
                            <div class="aspect-video bg-black/30 grid place-items-center overflow-hidden"><img class="preview max-h-full"/><span class="icon-placeholder text-4xl"></span></div>
                            <div class="p-4 space-y-2 text-sm">
                                <div class="flex justify-between"><div class="truncate filename"></div><span class="format badge"></span></div>
                                <div class="text-xs text-cu-text-dim dims"></div>
                                <div class="flex gap-2 pt-1">
                                    <button class="btnConvert cu-btn primary text-sm"><i class="fa-solid fa-repeat mr-2"></i>Converter</button>
                                    <a class="btnDownload cu-btn text-sm" download><i class="fa-solid fa-download mr-2"></i>Baixar</a>
                                </div>
                                <div class="text-xs text-cu-text-dim status"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </section>
        </main>
    </div>

    <script>
        const $ = sel => document.querySelector(sel), $$ = sel => Array.from(document.querySelectorAll(sel));
        const state = { fmt: 'image/png', quality: 0.9, maxW: null, maxH: null, files: [] };

        function setFmt(fmt) {
            state.fmt = fmt;
            $$('.btnfmt').forEach(b => b.classList.toggle('primary', b.dataset.format === fmt));
        }

        async function convertFile(file, filename) {
            if (state.fmt.startsWith('image/')) {
                if (!file.type.startsWith('image/')) throw new Error('Apenas imagens podem ser convertidas.');
                const img = await createImageBitmap(file);
                const canvas = document.createElement('canvas');
                let { width, height } = img;
                if (state.maxW && width > state.maxW) { height *= state.maxW / width; width = state.maxW; }
                if (state.maxH && height > state.maxH) { width *= state.maxH / height; height = state.maxH; }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                return new Promise(resolve => canvas.toBlob(blob => resolve({ blob, outName: filename.replace(/\.[^.]+$/, `.${state.fmt.split('/')[1]}`), width, height }), state.fmt, state.fmt === 'image/png' ? undefined : state.quality));
            } else if (state.fmt === 'application/pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ unit: 'pt' });
                if (file.type.startsWith('image/')) {
                    const dataURL = await new Promise(r => { const reader = new FileReader(); reader.onload = () => r(reader.result); reader.readAsDataURL(file); });
                    const imgObj = await createImageBitmap(file);
                    pdf.addImage(dataURL, file.type.split('/')[1].toUpperCase(), 0, 0, imgObj.width, imgObj.height);
                } else {
                    pdf.text(await file.text(), 40, 40);
                }
                return { blob: pdf.output('blob'), outName: filename.replace(/\.[^.]+$/, '.pdf') };
            } else if (state.fmt === 'application/zip') {
                const zip = new JSZip();
                zip.file(filename, await file.arrayBuffer());
                return { blob: await zip.generateAsync({ type: 'blob' }), outName: filename.replace(/\.[^.]+$/, '.zip') };
            }
            throw new Error('Formato não suportado.');
        }

        function createCard(file) {
            const node = $('#cardTmpl').content.firstElementChild.cloneNode(true);
            $('.filename', node).textContent = file.name;
            $('.format', node).textContent = file.type || 'desconhecido';
            if (file.type.startsWith('image/')) {
                $('.preview', node).src = URL.createObjectURL(file);
                $('.icon-placeholder', node).remove();
            } else {
                $('.preview', node).remove();
                $('.icon-placeholder', node).innerHTML = '<i class="fas fa-file"></i>';
            }
            $('.btnConvert', node).onclick = async () => {
                const status = $('.status', node); status.textContent = 'Convertendo...';
                try {
                    const result = await convertFile(file, file.name);
                    const url = URL.createObjectURL(result.blob);
                    const btnDown = $('.btnDownload', node); btnDown.href = url; btnDown.download = result.outName;
                    status.textContent = `Pronto: ${result.outName}`;
                } catch (err) { status.textContent = err.message; }
            };
            return node;
        }

        function addFiles(files) {
            state.files.push(...files);
            files.forEach(f => $('#grid').appendChild(createCard(f)));
        }

        document.addEventListener('DOMContentLoaded', () => {
            setFmt(state.fmt);
            $('#quality').oninput = e => { state.quality = +e.target.value; $('#qval').textContent = state.quality.toFixed(2); };
            $('#maxW').onchange = () => state.maxW = parseInt($('#maxW').value) || null;
            $('#maxH').onchange = () => state.maxH = parseInt($('#maxH').value) || null;
            $$('.btnfmt').forEach(b => b.onclick = () => setFmt(b.dataset.format));
            $('#dropzone').onclick = () => $('#fileInput').click();
            $('#fileInput').onchange = e => addFiles(e.target.files);
            const dz = $('#dropzone');
            ['dragenter', 'dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('dragover'); }));
            ['dragleave', 'drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('dragover'); }));
            dz.addEventListener('drop', e => addFiles(e.dataTransfer.files));
            $('#btnConvertAll').onclick = () => $$('#grid .btnConvert').forEach(btn => btn.click());
            $('#btnExportAll').onclick = () => $$('#grid .btnDownload[href]').forEach((link, i) => setTimeout(() => link.click(), i * 200));
        });
    </script>
</body>
</html>

