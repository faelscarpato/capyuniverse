<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CapyEscreve — Escrita Assistida</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png" />
  <link rel="stylesheet" href="cu-style.css" />
  <script src="cu-navigation.js" defer></script>

<!-- gtag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3FFD7ZEBN1"></script>
  <script>
    window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}
    gtag('js', new Date()); gtag('config','G-3FFD7ZEBN1',{page_path:location.pathname});
  </script>

</head>
<body class="min-h-screen flex flex-col">
  <header class="cu-header">
    <div class="cu-brand">
        <a href="index.html" class="flex items-center gap-2 group">
            <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png" alt="CapyUniverse logo"></div>
            <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
        </a>
        <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyEscreve</span>
    </div>
    <div class="flex items-center gap-2">
        <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
    </div>
  </header>
  
  <div class="flex flex-1">
    <aside id="sidebar" class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin">
      <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
    </aside>
  
    <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
      <section class="cu-panel p-4 sm:p-6 flex flex-col space-y-6">
        <div class="text-center">
          <h1 class="text-2xl sm:text-3xl font-bold" style="color: var(--cu-sky);">CapyEscreve ✍️</h1>
          <p class="text-cu-text-dim mt-1">Crie textos com auxílio de IA: dite, gere seções e revise.</p>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-[400px,1fr] gap-6">
          <aside class="cu-panel bg-transparent p-4 space-y-4">
            <div>
              <label class="block text-sm text-cu-text-dim mb-1" for="writeInput">Esboço</label>
              <textarea id="writeInput" rows="7" class="cu-textarea" placeholder="Digite ou dite suas ideias..."></textarea>
            </div>
            <div class="flex items-center gap-3"><button id="btnWriteRecord" class="cu-btn flex-1"><i class="fas fa-microphone"></i> Ditar</button><button id="btnWriteClear" class="cu-btn"><i class="fas fa-eraser"></i></button></div>
            <div>
              <label class="block text-sm text-cu-text-dim mb-1" for="writeCommand">Comando IA</label>
              <input id="writeCommand" class="cu-input" placeholder="Ex: 3 títulos sobre capivaras" />
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="btnWriteTitles" class="cu-btn text-xs">Títulos</button>
              <button id="btnWriteIntro" class="cu-btn text-xs">Introdução</button>
              <button id="btnWriteSection" class="cu-btn text-xs">Seção</button>
              <button id="btnWriteConclusion" class="cu-btn text-xs">Conclusão</button>
              <button id="btnWriteReview" class="cu-btn text-xs">Revisão</button>
            </div>
            <button id="btnWriteCustom" class="cu-btn primary w-full"><i class="fas fa-magic"></i> Executar</button>
          </aside>
          <section class="cu-panel bg-transparent p-4 flex flex-col">
            <label class="block text-sm text-cu-text-dim mb-1" for="writeResult">Resultado</label>
            <textarea id="writeResult" rows="12" class="cu-textarea flex-1" readonly></textarea>
            <div class="flex items-center gap-3 mt-4">
              <button id="btnWriteOuvir" class="cu-btn" disabled><i class="fas fa-volume-high"></i></button>
              <button id="btnWriteCopy" class="cu-btn" disabled><i class="fas fa-copy"></i></button>
              <button id="btnWriteExport" class="cu-btn" disabled><i class="fas fa-download"></i></button>
            </div>
          </section>
        </div>
      </section>
    </main>
  </div>
  
  <script>
    // Configuração geral
    const API_KEY_STORAGE_KEY = 'capyUniverseApiKey_gemini';
    let apiKey = localStorage.getItem(API_KEY_STORAGE_KEY) || '';
    let recognition;
    let recording = false;
    
    // Mapear elementos
    const dom = {
      writeInput: document.getElementById('writeInput'),
      writeCommand: document.getElementById('writeCommand'),
      writeResult: document.getElementById('writeResult'),
      btnWriteRecord: document.getElementById('btnWriteRecord'),
      btnWriteClear: document.getElementById('btnWriteClear'),
      btnWriteTitles: document.getElementById('btnWriteTitles'),
      btnWriteIntro: document.getElementById('btnWriteIntro'),
      btnWriteSection: document.getElementById('btnWriteSection'),
      btnWriteConclusion: document.getElementById('btnWriteConclusion'),
      btnWriteReview: document.getElementById('btnWriteReview'),
      btnWriteCustom: document.getElementById('btnWriteCustom'),
      btnWriteOuvir: document.getElementById('btnWriteOuvir'),
      btnWriteCopy: document.getElementById('btnWriteCopy'),
      btnWriteExport: document.getElementById('btnWriteExport'),
    };

    // Habilita botões de ação conforme há resultado
    function updateWriteButtons() {
      const hasResult = dom.writeResult.value.trim().length > 0;
      dom.btnWriteOuvir.disabled = !hasResult;
      dom.btnWriteCopy.disabled = !hasResult;
      dom.btnWriteExport.disabled = !hasResult;
    }

    // Inicia reconhecimento de voz
    function startWriteRecord() {
      if (!('webkitSpeechRecognition' in window)) {
        alert('Seu navegador não suporta reconhecimento de voz.');
        return;
      }
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.onresult = function(event) {
        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          finalTranscript += event.results[i][0].transcript;
        }
        dom.writeInput.value += (dom.writeInput.value ? ' ' : '') + finalTranscript.trim();
      };
      recognition.start();
      recording = true;
      dom.btnWriteRecord.innerHTML = '<i class="fas fa-stop"></i> Parar';
    }

    // Encerra reconhecimento de voz
    function stopWriteRecord() {
      if (recognition) {
        recognition.stop();
      }
      recording = false;
      dom.btnWriteRecord.innerHTML = '<i class="fas fa-microphone"></i> Ditar';
    }

    // Prepara prompt de acordo com tipo
    function buildWritePrompt(type) {
      const mainText = dom.writeInput.value.trim();
      const cmdText = dom.writeCommand.value.trim();
      let subject = cmdText || mainText;
      if (!subject && type !== 'review') {
        return null;
      }
      const lines = [
        'Você é o CapyEscreve, um assistente de escrita criativo em português do Brasil.',
        'Ajuste o estilo e o formato conforme solicitado abaixo.',
        '',
      ];
      if (type === 'titles') {
        lines.push('Gere três títulos criativos e cativantes para o tema a seguir.');
        lines.push('Os títulos devem ser curtos, impactantes e feitos para chamar a atenção do leitor.');
      } else if (type === 'intro') {
        lines.push('Escreva uma introdução interessante para o tema a seguir, com ao menos dois parágrafos.');
        lines.push('A introdução deve despertar a curiosidade do leitor e contextualizar o assunto.');
      } else if (type === 'section') {
        lines.push('Escreva uma seção de desenvolvimento aprofundada sobre o tema a seguir.');
        lines.push('Inclua detalhes, dados ou exemplos e utilize ao menos dois parágrafos para desenvolver a ideia.');
      } else if (type === 'conclusion') {
        lines.push('Escreva uma conclusão que sintetize o tema, reforçando os principais pontos e convidando o leitor à reflexão ou ação.');
      } else if (type === 'review') {
        lines.push('Revise o texto fornecido, melhorando gramática, clareza e fluidez, sem alterar o conteúdo ou o estilo do autor.');
      } else {
        lines.push('Siga o comando a seguir da melhor forma possível.');
      }
      lines.push('');
      if (type === 'review') {
        lines.push('Texto original:');
        lines.push(mainText || '(nenhum texto)');
      } else {
        lines.push('Tema ou comando:');
        lines.push('"' + subject + '"');
      }
      lines.push('');
      lines.push('Separe parágrafos com uma linha em branco e use Markdown apenas se desejar usar cabeçalhos ou listas.');
      return lines.join('\n');
    }

    // Executa a geração de texto
    async function handleGenerateWrite(type) {
      if (!apiKey) {
        alert('Configure a chave API do Gemini.');
        return;
      }
      const prompt = buildWritePrompt(type);
      if (prompt === null) {
        alert('Insira um texto ou comando para gerar conteúdo.');
        return;
      }
      // desabilita botões de IA para evitar múltiplos envios
      dom.btnWriteCustom.disabled = true;
      dom.btnWriteTitles.disabled = true;
      dom.btnWriteIntro.disabled = true;
      dom.btnWriteSection.disabled = true;
      dom.btnWriteConclusion.disabled = true;
      dom.btnWriteReview.disabled = true;
      dom.writeResult.value = 'Gerando...';
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [ { parts: [ { text: prompt } ] } ] })
          }
        );
        if (!response.ok) throw new Error(`Erro na API: ${response.status}`);
        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.map(p => p.text || '').join('\n').trim() || '';
        dom.writeResult.value = text;
      } catch (error) {
        alert('Erro ao gerar texto: ' + error.message);
        dom.writeResult.value = '';
      } finally {
        // reabilita botões
        dom.btnWriteCustom.disabled = false;
        dom.btnWriteTitles.disabled = false;
        dom.btnWriteIntro.disabled = false;
        dom.btnWriteSection.disabled = false;
        dom.btnWriteConclusion.disabled = false;
        dom.btnWriteReview.disabled = false;
        updateWriteButtons();
      }
    }

    // Text-to-speech
    function handleListen() {
      const text = dom.writeResult.value.trim();
      if (!text) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'pt-BR';
      speechSynthesis.speak(utterance);
    }

    // Copiar resultado para clipboard
    function handleCopy() {
      const text = dom.writeResult.value.trim();
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => alert('Texto copiado!'));
    }

    // Exportar resultado como arquivo
    function handleExport() {
      const text = dom.writeResult.value.trim();
      if (!text) return;
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'texto-capyescreve.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Limpa o esboço
    function clearWriteInput() {
      dom.writeInput.value = '';
      dom.writeCommand.value = '';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const savedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
      if (savedKey) apiKey = savedKey;
      updateWriteButtons();
      // Gravador de voz
      dom.btnWriteRecord.addEventListener('click', () => {
        if (!recording) {
          startWriteRecord();
        } else {
          stopWriteRecord();
        }
      });
      dom.btnWriteClear.addEventListener('click', () => {
        clearWriteInput();
      });
      dom.btnWriteTitles.addEventListener('click', () => handleGenerateWrite('titles'));
      dom.btnWriteIntro.addEventListener('click', () => handleGenerateWrite('intro'));
      dom.btnWriteSection.addEventListener('click', () => handleGenerateWrite('section'));
      dom.btnWriteConclusion.addEventListener('click', () => handleGenerateWrite('conclusion'));
      dom.btnWriteReview.addEventListener('click', () => handleGenerateWrite('review'));
      dom.btnWriteCustom.addEventListener('click', () => handleGenerateWrite('custom'));
      dom.btnWriteOuvir.addEventListener('click', handleListen);
      dom.btnWriteCopy.addEventListener('click', handleCopy);
      dom.btnWriteExport.addEventListener('click', handleExport);
      // Atalhos: Ctrl+Enter ou Cmd+Enter no esboço para enviar comando custom
      dom.writeCommand.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          handleGenerateWrite('custom');
        }
      });
      // Render sidebar se disponível
      if (window.CU_NAVIGATION && !window.CU_NAVIGATION.isInitialized) {
        window.CU_NAVIGATION.init();
        window.CU_NAVIGATION.isInitialized = true;
      }
      if (window.CU_NAVIGATION && window.CU_NAVIGATION.renderSidebar) {
        window.CU_NAVIGATION.renderSidebar('CapyEscreve');
      }
    });
  </script>
</body>
</html>