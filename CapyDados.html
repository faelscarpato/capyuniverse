<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CapyDoc - Analisador de Documentos IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="cu-style.css">
    <script src="cu-navigation.js" defer></script>

    <style>
        .font-jetbrains { font-family: 'JetBrains Mono', monospace; }
        .loader { border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Markdown styles adapted for UI 3.0 */
        .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4 {
            font-weight: 600; margin-top: 0.75em; margin-bottom: 0.25em; color: var(--cu-text);
        }
        .markdown-content h2 { font-size: 1.5em; border-bottom: 1px solid var(--cu-grid); padding-bottom: 0.2em; }
        .markdown-content h3 { font-size: 1.25em; }
        .markdown-content p { margin-bottom: 0.6em; line-height: 1.65; color: var(--cu-text-dim); }
        .markdown-content ul, .markdown-content ol { margin-left: 1.75em; margin-bottom: 0.6em; list-style-position: outside; color: var(--cu-text-dim); }
        .markdown-content strong { font-weight: 700; color: var(--cu-text); }
        .markdown-content code { background-color: #00000033; padding: 0.1em 0.3em; border-radius: 4px; font-family: 'JetBrains Mono', monospace; }
        .markdown-content pre { background-color: #00000055; padding: 0.75em; border-radius: 8px; overflow-x: auto; margin-bottom: 0.75em; }
        .markdown-content a { color: var(--cu-cyan); text-decoration: underline; }

        .chat-message { padding: 10px 14px; border-radius: 12px; margin-bottom: 10px; max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background: var(--premium-gradient); color: white; align-self: flex-end; margin-left: auto; }
        .ia-message { background: var(--cu-bg-1); color: var(--cu-text); align-self: flex-start; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="cu-header">
        <div class="cu-brand">
            <a href="index.html" class="flex items-center gap-2 group">
                <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png"></div>
                <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
            </a>
            <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyDoc</span>
        </div>
        <div class="flex items-center gap-2">
            <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
        </div>
    </header>

    <div id="notificationArea"></div>

    <div class="flex flex-1">
        <aside id="sidebar" class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin">
            <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
        </aside>

        <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
            <section class="cu-panel p-4 sm:p-6 flex flex-col h-full max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 text-purple-400 mb-2"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v3"/><path d="M14 2v6h6"/><circle cx="12.5" cy="15.5" r="2.5"/><path d="m14.5 17.5 2 2"/></svg>
                    <h2 class="text-3xl font-bold text-purple-400">CapyDoc</h2>
                    <p class="text-md text-cu-text-dim mt-1">Analise documentos (.pdf, .docx, .txt) com IA.</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="fileInputDoc" class="block text-sm font-semibold mb-2 text-cu-text-dim">1. Envie o documento (.pdf, .docx ou .txt):</label>
                        <input type="file" id="fileInputDoc" accept=".pdf,.docx,.txt" class="cu-input file:mr-3 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-white/10 file:text-white hover:file:bg-white/20"/>
                        <div id="fileLoadingStatusDoc" class="text-xs mt-2 text-cu-text-dim"></div>
                    </div>
                    <div>
                        <label for="docTextExtracted" class="block text-sm font-semibold mb-2 text-cu-text-dim">2. Conteúdo extraído (Pré-visualização)</label>
                        <textarea id="docTextExtracted" rows="8" class="cu-textarea font-jetbrains" readonly placeholder="O conteúdo do documento aparecerá aqui..."></textarea>
                    </div>
                    <div>
                        <label for="analiseTipoDoc" class="block text-sm font-semibold mb-2 text-cu-text-dim">3. O que você quer analisar?</label>
                        <input type="text" id="analiseTipoDoc" placeholder="Ex: Resumir, encontrar cláusulas, verificar erros..." class="cu-input font-jetbrains">
                    </div>
                    <button id="analisarDocButton" class="cu-btn primary w-full text-lg">
                        <span class="btn-text">Analisar Documento</span>
                        <span class="loader hidden ml-2"></span>
                    </button>
                </div>

                <div id="mainAnalysisResultSection" class="hidden mt-6 space-y-6">
                    <div class="cu-panel bg-transparent p-4">
                        <h3 class="text-lg font-semibold text-cu-text mb-2">4. Análise Gerada pela IA</h3>
                        <div id="resultadoDoc" class="markdown-content text-sm min-h-[150px]">A análise do documento aparecerá aqui...</div>
                    </div>
                    
                    <div id="docFeaturesSection" class="cu-panel bg-transparent p-4 space-y-3">
                        <h4 class="text-md font-semibold text-purple-300 mb-2">Ações Adicionais com IA:</h4>
                        <button id="analisarSentimentoDocButton" class="cu-btn w-full">
                            <span class="btn-text">Analisar Sentimento do Documento ✨</span>
                            <span class="loader hidden ml-2"></span>
                        </button>
                        <div id="resultadoAnaliseSentimentoDoc" class="markdown-content text-sm min-h-[50px] hidden"></div>
                    </div>

                    <div id="chatWithDocSection" class="cu-panel bg-transparent p-4">
                        <h3 class="text-lg font-semibold text-cu-text mb-2">5. Converse com o Documento ✨</h3>
                        <div class="flex-grow flex flex-col bg-[var(--cu-bg-1)] rounded-lg border border-white/10 overflow-hidden min-h-[300px] max-h-[calc(100vh-30rem)]">
                            <div id="chatBoxDoc" class="flex-grow p-4 space-y-3 overflow-y-auto flex flex-col markdown-content scrollbar-thin">
                                <div class="ia-message chat-message">Após a análise, faça perguntas específicas sobre o conteúdo aqui.</div>
                            </div>
                            <div class="p-2 border-t border-white/10">
                                <div class="flex">
                                    <input type="text" id="userInputDocChat" placeholder="Pergunte sobre o documento..." class="cu-input flex-1 rounded-r-none">
                                    <button id="sendDocChatButton" class="cu-btn primary rounded-l-none">
                                        <span class="btn-text">Enviar</span>
                                        <span class="loader hidden ml-2"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const dom = {
            sidebar: document.getElementById('sidebar'),
            notificationArea: document.getElementById('notificationArea'),
            fileInputDoc: document.getElementById('fileInputDoc'),
            docTextExtracted: document.getElementById('docTextExtracted'),
            analiseTipoDoc: document.getElementById('analiseTipoDoc'),
            analisarDocButton: document.getElementById('analisarDocButton'),
            resultadoDoc: document.getElementById('resultadoDoc'),
            mainAnalysisResultSection: document.getElementById('mainAnalysisResultSection'),
            docFeaturesSection: document.getElementById('docFeaturesSection'),
            analisarSentimentoDocButton: document.getElementById('analisarSentimentoDocButton'),
            resultadoAnaliseSentimentoDoc: document.getElementById('resultadoAnaliseSentimentoDoc'),
            chatWithDocSection: document.getElementById('chatWithDocSection'),
            chatBoxDoc: document.getElementById('chatBoxDoc'),
            userInputDocChat: document.getElementById('userInputDocChat'),
            sendDocChatButton: document.getElementById('sendDocChatButton'),
            fileLoadingStatusDoc: document.getElementById('fileLoadingStatusDoc')
        };

        let apiKey = localStorage.getItem('capyUniverseApiKey_gemini') || '';
        let extractedTexts = { doc: '' };
        let chatConversationHistoryDoc = [];

        function showLoading(buttonElement, show = true) {
            const btnText = buttonElement.querySelector('.btn-text');
            const loader = buttonElement.querySelector('.loader');
            buttonElement.disabled = show;
            if (show) {
                if(btnText) btnText.classList.add('hidden');
                if(loader) loader.classList.remove('hidden');
            } else {
                if(btnText) btnText.classList.remove('hidden');
                if(loader) loader.classList.add('hidden');
            }
        }

        async function callGeminiAPI(prompt, buttonElement, resultElementOrCb, isChatFeature = false) {
            if (!apiKey) {
                alert("API Key do Gemini não configurada.");
                if(buttonElement) showLoading(buttonElement, false);
                return null;
            }
            if(buttonElement) showLoading(buttonElement, true);
            if (typeof resultElementOrCb !== 'function' && resultElementOrCb && !isChatFeature) {
                resultElementOrCb.innerHTML = `<div class="flex items-center justify-center p-4 text-cu-text-dim"><span class="loader mr-2"></span>Analisando...</div>`;
                resultElementOrCb.classList.remove('hidden');
            }
            try {
                const payload = { contents: isChatFeature ? [...chatConversationHistoryDoc, {role: "user", parts: [{text: prompt}]}] : [{ parts: [{ text: prompt }] }] };
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload) 
                });
                if (!res.ok) throw new Error((await res.json())?.error?.message || `Erro ${res.status}`);
                const data = await res.json();
                if (data.promptFeedback?.blockReason) throw new Error(`Conteúdo bloqueado: ${data.promptFeedback.blockReason}`);
                const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (textResponse === undefined) throw new Error("Resposta da IA vazia.");
                
                if (typeof resultElementOrCb === 'function') resultElementOrCb(textResponse);
                else if (resultElementOrCb) resultElementOrCb.innerHTML = marked.parse(textResponse);
                
                if (isChatFeature) {
                    chatConversationHistoryDoc.push({role: "user", parts: [{text: prompt}]});
                    chatConversationHistoryDoc.push({role: "model", parts: [{text: textResponse}]});
                }
                return textResponse;
            } catch (err) {
                const errorMsg = err.message || "Erro desconhecido.";
                if (typeof resultElementOrCb === 'function') resultElementOrCb(`Erro: ${errorMsg}`);
                else if (resultElementOrCb) resultElementOrCb.innerHTML = `<p class="text-red-400">Erro: ${errorMsg}</p>`;
                return null;
            } finally {
                if(buttonElement) showLoading(buttonElement, false);
            }
        }

        async function processFile(file, statusEl, outputEl, key) {
            statusEl.innerHTML = '<span class="loader inline-block mr-2"></span>Processando...';
            outputEl.value = '';
            extractedTexts[key] = '';
            [dom.mainAnalysisResultSection, dom.docFeaturesSection, dom.chatWithDocSection, dom.resultadoAnaliseSentimentoDoc].forEach(el => el.classList.add('hidden'));
            chatConversationHistoryDoc = [];

            if (!file) {
                statusEl.textContent = 'Nenhum arquivo selecionado.';
                return;
            }
            try {
                let text = '';
                if (file.name.endsWith('.pdf')) {
                    const typedarray = new Uint8Array(await file.arrayBuffer());
                    const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + '\n\n';
                    }
                } else if (file.name.endsWith('.docx')) {
                    const result = await mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
                    text = result.value;
                } else if (file.name.endsWith('.txt')) {
                    text = await file.text();
                }
                outputEl.value = text.substring(0, 5000) + (text.length > 5000 ? "..." : "");
                statusEl.textContent = `Arquivo "${file.name}" processado.`;
                extractedTexts[key] = text;
            } catch (err) {
                statusEl.textContent = "Erro ao processar: " + err.message;
            }
        }

        dom.fileInputDoc.addEventListener('change', (e) => processFile(e.target.files[0], dom.fileLoadingStatusDoc, dom.docTextExtracted, 'doc'));

        dom.analisarDocButton.addEventListener('click', async () => {
            const textoDoc = extractedTexts.doc;
            const analiseTipo = dom.analiseTipoDoc.value.trim() || "faça uma análise completa, identificando o tipo de documento, um resumo conciso, os tópicos mais importantes, e aponte cláusulas ou informações que mereçam atenção especial.";
            if (!textoDoc) { alert("Por favor, envie um documento."); return; }
            
            dom.mainAnalysisResultSection.classList.remove('hidden');
            [dom.docFeaturesSection, dom.chatWithDocSection, dom.resultadoAnaliseSentimentoDoc].forEach(el => el.classList.add('hidden'));
            
            const prompt = `Analise o seguinte documento com a instrução: "${analiseTipo}".\n\nDocumento (primeiros 15000 caracteres):\n---\n${textoDoc.substring(0, 15000)}\n---
`;
            const success = await callGeminiAPI(prompt, dom.analisarDocButton, dom.resultadoDoc);
            if (success) {
                dom.docFeaturesSection.classList.remove('hidden');
                dom.chatWithDocSection.classList.remove('hidden');
                chatConversationHistoryDoc = [{role: "model", parts: [{text: `Análise Inicial do Documento:\n${dom.resultadoDoc.innerText}`}]}];
            }
        });

        dom.analisarSentimentoDocButton.addEventListener('click', async () => {
            const textoDoc = extractedTexts.doc;
            if (!textoDoc) { alert("Nenhum documento processado."); return; }
            dom.resultadoAnaliseSentimentoDoc.classList.remove('hidden');
            const promptSentimento = `Analise o sentimento do documento a seguir e responda com "Sentimento: [Positivo/Negativo/Neutro]" e uma breve justificativa.\n\nDocumento (primeiros 5000 caracteres):\n---\n${textoDoc.substring(0, 5000)}\n---
`;
            await callGeminiAPI(promptSentimento, dom.analisarSentimentoDocButton, dom.resultadoAnaliseSentimentoDoc, true);
        });

        function addMessageToDocChat(message, sender = 'ia', isMarkdown = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender === 'user' ? 'user-message' : 'ia-message'}`;
            messageDiv.innerHTML = isMarkdown ? marked.parse(message) : message;
            dom.chatBoxDoc.appendChild(messageDiv);
            dom.chatBoxDoc.scrollTop = dom.chatBoxDoc.scrollHeight;
        }

        dom.sendDocChatButton.addEventListener('click', async () => {
            const userQuery = dom.userInputDocChat.value.trim();
            if (!userQuery || !extractedTexts.doc) return;
            addMessageToDocChat(userQuery, 'user');
            dom.userInputDocChat.value = '';
            const iaResponseText = await callGeminiAPI(userQuery, dom.sendDocChatButton, null, true);
            if(iaResponseText) addMessageToDocChat(iaResponseText, 'ia', true);
        });

        dom.userInputDocChat.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); dom.sendDocChatButton.click(); }
        });

        // Load API key on start
        window.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('capyUniverseApiKey_gemini');
            if (savedKey) apiKey = savedKey;
        });
    </script>
</body>
</html>

