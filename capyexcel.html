<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapyExcel - Seu Tutor IA de Excel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5rLesXWW/sGuLqc1DkBSFSQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" xintegrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; /* gray-900 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        .loader {
            border: 4px solid #f3f3f3; /* light grey */
            border-top: 4px solid #10b981; /* Cor emerald-500 para CapyExcel */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .category-content.expanded {
            max-height: 1000px; 
        }
        .sidebar-link.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 600;
        }
        /* Estilos para a área de resposta da IA */
        .excel-instructions {
            background-color: #1f2937; /* gray-800 */
            border-radius: 0.5rem;
            padding: 1.5rem; /* Aumentado o padding */
            border: 1px solid #374151; /* gray-700 */
        }
        .excel-instructions h2 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: bold;
            color: #34d399; /* emerald-400 */
            margin-bottom: 1rem;
        }
        .excel-instructions h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* semibold */
            color: #6ee7b7; /* emerald-300 */
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #4b5563; /* gray-600 */
            padding-bottom: 0.25rem;
        }
        .excel-instructions p, .excel-instructions li {
            margin-bottom: 0.75rem;
            line-height: 1.6;
            color: #d1d5db; /* gray-300 */
        }
        .excel-instructions ul {
            list-style-type: disc;
            margin-left: 1.5rem;
        }
        .excel-instructions strong {
            color: #a7f3d0; /* emerald-200 */
            font-weight: 600;
        }
        .excel-instructions code {
            background-color: #374151; /* gray-700 */
            color: #f3f4f6; /* gray-100 */
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }
        .excel-instructions pre {
            background-color: #111827; /* gray-900 */
            color: #e5e7eb; /* gray-200 */
            padding: 1rem;
            border-radius: 0.375rem; /* rounded-md */
            overflow-x: auto;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem; /* text-sm */
        }
        .excel-instructions pre code {
            background-color: transparent;
            padding: 0;
        }
        .excel-instructions img { 
            max-width: 100%;
            height: auto;
            border-radius: 0.375rem; 
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #4b5563; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .excel-instructions table {
            width: auto; 
            min-width: 50%; 
            margin-top: 0.75rem; 
            margin-bottom: 1rem;
            font-size: 0.875rem;
            border-collapse: collapse;
            background-color: #374151; 
            border-radius: 0.375rem;
            overflow: hidden; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .excel-instructions th, .excel-instructions td {
            border: 1px solid #4b5563; 
            padding: 0.5rem 0.75rem; 
            text-align: left;
        }
        .excel-instructions th {
            background-color: #4b5563; 
            color: #e5e7eb; 
            font-weight: 600;
        }
        .excel-instructions td {
            color: #d1d5db; 
        }
        .excel-instructions .table-caption { 
            font-size: 0.8rem;
            color: #9ca3af; /* gray-400 */
            margin-bottom: 0.25rem;
            text-align: center;
        }
        .export-button {
            background-color: #059669; /* emerald-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            transition: background-color 0.2s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .export-button:hover {
            background-color: #047857; /* emerald-700 */
        }
        .export-button svg {
            width: 1rem; /* w-4 */
            height: 1rem; /* h-4 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

    <header class="bg-gray-800 p-3 shadow-lg flex justify-between items-center fixed top-0 left-0 right-0 z-40 h-16">
        <div class="flex items-center">
            <button id="sidebarToggleBtn" class="lg:hidden mr-3 p-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-purple-500">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <a href="index.html" class="text-xl sm:text-2xl font-bold hover:text-purple-400 transition-colors">CapyUniverse IA</a>
        </div>
        <div class="flex items-center">
            <button id="openApiKeysModalButton" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-md text-sm font-semibold text-white">Chaves API IA's</button>
        </div>
    </header>

    <div id="notificationArea" class="fixed top-20 right-4 z-[60] space-y-2 w-full max-w-xs sm:max-w-sm">
    </div>

    <div class="flex flex-1 pt-16">
        <aside id="sidebar" class="bg-gray-800 text-gray-300 w-64 space-y-2 p-4 fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 lg:static lg:inset-0 transition-transform duration-300 ease-in-out z-30 shadow-lg overflow-y-auto pt-20 lg:pt-4">
        </aside>
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>

        <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
            <div class="space-y-6 bg-gray-800 p-6 rounded-xl shadow-2xl max-w-4xl mx-auto">
                <div class="text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 text-emerald-400 mb-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <h2 class="text-3xl font-bold text-emerald-400">CapyExcel</h2>
                    <p class="text-md text-gray-400 mt-1">Seu tutor IA para dominar o Excel, passo a passo.</p>
                </div>
                
                <div>
                    <label for="excelTaskInput" class="block text-sm font-medium text-gray-300 mb-1">O que você gostaria de aprender ou fazer no Excel?</label>
                    <textarea id="excelTaskInput" rows="4" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 resize-y shadow-sm" placeholder="Ex: Como criar um gráfico de barras mostrando as vendas mensais? ou Como usar a função SOMASES?"></textarea>
                </div>
                
                <button id="getInstructionsButton" class="w-full bg-emerald-500 hover:bg-emerald-600 disabled:opacity-75 disabled:cursor-not-allowed px-6 py-3 rounded-md text-lg font-semibold text-gray-900 shadow-md transition-colors duration-150 flex items-center justify-center">
                    <span class="btn-text">Obter Instruções</span>
                    <span class="loader hidden ml-2"></span>
                </button>
                
                <div id="excelInstructionsArea" class="mt-6 space-y-4">
                    <div id="aiResponseDiv" class="excel-instructions min-h-[200px]">
                        <p class="text-gray-500 text-center py-8">As instruções aparecerão aqui...</p>
                    </div>
                    <div id="exportButtonsContainer" class="mt-4 flex flex-wrap gap-3 hidden">
                        <button id="exportToPdfButton" class="export-button">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.914a1.5 1.5 0 00-.44-1.06L13.147 3.44A1.5 1.5 0 0012.086 3H4.5zm7.5.75V6.5h2.25A.75.75 0 0015 5.75V3.75h-3zm-3.75 8a.75.75 0 01.75-.75h4.5a.75.75 0 010 1.5h-4.5a.75.75 0 01-.75-.75zm0 3a.75.75 0 01.75-.75h4.5a.75.75 0 010 1.5h-4.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>
                            Exportar para PDF
                        </button>
                        <button id="exportTablesToCsvButton" class="export-button">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3.5A1.5 1.5 0 013.5 2h13A1.5 1.5 0 0118 3.5v13a1.5 1.5 0 01-1.5 1.5h-13A1.5 1.5 0 012 16.5v-13zM7.5 4a.5.5 0 00-.5.5v11a.5.5 0 00.5.5h5a.5.5 0 00.5-.5v-11a.5.5 0 00-.5-.5h-5zM5 7.25a.75.75 0 000 1.5h.5a.75.75 0 000-1.5h-.5zm0 3a.75.75 0 000 1.5h.5a.75.75 0 000-1.5h-.5zm0 3a.75.75 0 000 1.5h.5a.75.75 0 000-1.5h-.5zm10-5.25a.75.75 0 00-.75-.75h-.5a.75.75 0 000 1.5h.5a.75.75 0 00.75-.75zm-.75 2.25a.75.75 0 010 1.5h-.5a.75.75 0 010-1.5h.5zm0 3a.75.75 0 010 1.5h-.5a.75.75 0 010-1.5h.5z" /></svg>
                            Exportar Tabelas (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer class="bg-gray-800 text-center p-4 text-sm text-gray-500 mt-auto">
        CapyUniverse IA &copy; 2025
    </footer>

    <div id="apiKeysModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-purple-400">Gerenciar Chaves de API</h2>
                <button id="closeApiKeysModalButton" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="p-4 border border-gray-700 rounded-md bg-gray-850">
                    <h3 class="text-lg font-medium text-sky-400 mb-2">Google Gemini</h3>
                    <label for="geminiApiKeyInputModal" class="block text-sm font-medium text-gray-300 mb-1">API Key Gemini:</label>
                    <div class="flex">
                        <input id="geminiApiKeyInputModal" type="password" placeholder="Sua API Key Gemini" class="p-2 text-sm text-black flex-grow rounded-l-md focus:ring-2 focus:ring-sky-500 outline-none"/>
                        <button data-provider="gemini" class="save-key-modal-button bg-sky-500 hover:bg-sky-600 px-3 py-2 rounded-r-md text-sm">Salvar</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Obtenha sua chave em <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-sky-400 hover:underline">Google AI Studio</a>.<br>O Gemini 1.5 Flash (usado aqui) possui um nível gratuito generoso.</p>
                </div>
                <div class="p-4 border border-gray-700 rounded-md bg-gray-850">
                    <h3 class="text-lg font-medium text-emerald-400 mb-2">OpenAI (Modelos GPT)</h3>
                    <label for="openaiApiKeyInputModal" class="block text-sm font-medium text-gray-300 mb-1">API Key OpenAI:</label>
                    <div class="flex">
                        <input id="openaiApiKeyInputModal" type="password" placeholder="Sua API Key OpenAI (sk-...)" class="p-2 text-sm text-black flex-grow rounded-l-md focus:ring-2 focus:ring-emerald-500 outline-none"/>
                        <button data-provider="openai" class="save-key-modal-button bg-emerald-500 hover:bg-emerald-600 px-3 py-2 rounded-r-md text-sm">Salvar</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Para usar modelos como GPT-3.5-turbo, GPT-4, etc. Requer créditos na <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer" class="text-emerald-400 hover:underline">plataforma OpenAI</a>.</p>
                </div>
                <div class="p-4 border border-gray-700 rounded-md bg-gray-850">
                    <h3 class="text-lg font-medium text-orange-400 mb-2">Anthropic Claude</h3>
                    <label for="claudeApiKeyInputModal" class="block text-sm font-medium text-gray-300 mb-1">API Key Claude:</label>
                    <div class="flex">
                        <input id="claudeApiKeyInputModal" type="password" placeholder="Sua API Key Claude" class="p-2 text-sm text-black flex-grow rounded-l-md focus:ring-2 focus:ring-orange-500 outline-none"/>
                        <button data-provider="claude" class="save-key-modal-button bg-orange-500 hover:bg-orange-600 px-3 py-2 rounded-r-md text-sm">Salvar</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Para usar modelos Claude. Verifique a disponibilidade e chaves na <a href="https://console.anthropic.com/" target="_blank" rel="noopener noreferrer" class="text-orange-400 hover:underline">Anthropic Console</a>.</p>
                </div>
                <div class="p-4 border border-gray-700 rounded-md bg-gray-850">
                    <h3 class="text-lg font-medium text-violet-400 mb-2">Perplexity AI</h3>
                    <label for="perplexityApiKeyInputModal" class="block text-sm font-medium text-gray-300 mb-1">API Key Perplexity (Opcional):</label>
                    <div class="flex">
                        <input id="perplexityApiKeyInputModal" type="password" placeholder="Sua API Key Perplexity" class="p-2 text-sm text-black flex-grow rounded-l-md focus:ring-2 focus:ring-violet-500 outline-none"/>
                        <button data-provider="perplexity" class="save-key-modal-button bg-violet-500 hover:bg-violet-600 px-3 py-2 rounded-r-md text-sm">Salvar</button>
                    </div>
                     <p class="text-xs text-gray-400 mt-2">Se disponível, para modelos Perplexity.</p>
                </div>
            </div>
            <div class="mt-8 text-center">
                <p class="text-sm text-gray-400 mb-3"><strong>Recomendamos usar uma chave API do Google Gemini (gratuita para começar) para a melhor experiência com as ferramentas CapyUniverse.</strong></p>
                <button id="continueWithoutKeyButtonModal" class="bg-gray-600 hover:bg-gray-500 px-6 py-2.5 rounded-md text-sm font-semibold">Continuar sem Chave (Funcionalidade Limitada)</button>
            </div>
        </div>
    </div>

    <script>
        let apiKeys = { gemini: '', openai: '', claude: '', perplexity: '' };
        let apiKey = ''; 
        const GEMINI_API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=";
        const currentPageId = 'CapyExcel'; 
        const API_KEY_STORAGE_PREFIX = 'capyUniverseApiKey_';

        const notificationArea = document.getElementById('notificationArea');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        
        const excelTaskInput = document.getElementById('excelTaskInput');
        const getInstructionsButton = document.getElementById('getInstructionsButton');
        const aiResponseDiv = document.getElementById('aiResponseDiv');
        const exportButtonsContainer = document.getElementById('exportButtonsContainer');
        const exportToPdfButton = document.getElementById('exportToPdfButton');
        const exportTablesToCsvButton = document.getElementById('exportTablesToCsvButton');


        const tools = [
            { id: 'CapyExcel', title: 'Tutor de Excel', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>', category: 'Aprendizagem e Educação', pageUrl: 'capyexcel.html', color: 'emerald' },
            { id: 'CapyValor', title: 'Precificador Inteligente', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2z"></path><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>', category: 'Produtividade e Organização', pageUrl: 'capyvalor.html', color: 'lime' },
            { id: 'CapyResumo', title: 'Resumir Textos', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><line x1="10" y1="9" x2="8" y2="9" /></svg>', category: 'Análise e Compreensão', pageUrl: 'capyresumo.html', color: 'blue' },
            { id: 'CapyExplica', title: 'Explicar Textos', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></svg>', category: 'Análise e Compreensão', pageUrl: 'capyexplica.html', color: 'yellow' },
            { id: 'CapyDetector', title: 'Detector de IA', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></svg>', category: 'Análise e Compreensão', pageUrl: 'capydetector.html', color: 'purple'},
            { id: 'CapyEmail', title: 'Gerar E-mails', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2" /><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" /></svg>', category: 'Criação e Edição', pageUrl: 'capyemail.html', color: 'pink' },
            { id: 'CapyTone', title: 'Humanizar Texto', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9a9 9 0 1 1-9-9Z"/><path d="M18 13a6 6 0 0 0-9-9"/><path d="m6 21 6-6"/><path d="m3 3 3 3"/><path d="M15 6l3.4-3.4"/><path d="M10.2 3.8 12 2"/><path d="M21 12a9 9 0 0 0-9-9"/></svg>', category: 'Criação e Edição', pageUrl: 'capytone.html', color: 'lime' }, 
            { id: 'CapyEscritor', title: 'Assistente de Escrita', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path><polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon></svg>', category: 'Criação e Edição', pageUrl: 'capyescritor.html', color: 'rose' },
            { id: 'CapyDiscurso', title: 'Gerador de Discursos', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>', category: 'Criação e Edição', pageUrl: 'capydiscurso.html', color: 'fuchsia' },
            { id: 'CapyRoteiro', title: 'Gerador de Roteiros', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>', category: 'Criação e Edição', pageUrl: 'capyroteiro.html', color: 'orange' },
            { id: 'CapyDoc', title: 'Analisar Documentos', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v3"/><path d="M14 2v6h6"/><circle cx="12.5" cy="15.5" r="2.5"/><path d="m14.5 17.5 2 2"/></svg>', category: 'Documentos e PDFs', pageUrl: 'capydoc.html', color: 'indigo' },
            { id: 'CapyVagaMatch', title: 'Match Currículo-Vaga', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>', category: 'Documentos e PDFs', pageUrl: 'capyvagamatch.html', color: 'green' },
            { id: 'CapyPDF', title: 'Chat com PDF', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2z" /><polyline points="14 2 14 8 20 8" /><path d="m10 13-2 2 2 2" /><path d="m14 13 2 2-2 2" /></svg>', category: 'Documentos e PDFs', pageUrl: 'capypdf.html', color: 'teal' },
            { id: 'CapyMinuta', title: 'Gerador de Atas', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>', category: 'Documentos e PDFs', pageUrl: 'capyminuta.html', color: 'slate' },
            { id: 'CapyChat', title: 'Chat Geral', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>', category: 'Chatbots Especializados', pageUrl: 'capychat.html', color: 'sky' },
            { id: 'CapyPsico', title: 'Chat Psicólogo IA', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="M9 12h.01"></path><path d="M15 12h.01"></path><path d="M10 16s.5-1 2-1 2 1 2 1"></path></svg>', category: 'Chatbots Especializados', pageUrl: 'capypsico.html', color: 'emerald' },
            { id: 'CapyHistoriador', title: 'Chat Historiador IA', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>', category: 'Chatbots Especializados', pageUrl: 'capyhistoriador.html', color: 'amber' },
            { id: 'CapyPlanner', title: 'Planejador Inteligente', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>', category: 'Produtividade e Organização', pageUrl: 'capyplanner.html', color: 'cyan' },
            { id: 'CapyMetas', title: 'Definidor de Metas', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>', category: 'Produtividade e Organização', pageUrl: 'capymetas.html', color: 'orange' }, 
            { id: 'CapyDiario', title: 'Diário Inteligente', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>', category: 'Produtividade e Organização', pageUrl: 'capydiario.html', color: 'blue' },
            { id: 'CapyDidatica', title: 'Planos de Aula', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="M12 14l6-3-6-3-6 3 6 3z"></path><path d="M12 14v7"></path><path d="M6 12.5L12 17l6-4.5"></path></svg>', category: 'Aprendizagem e Educação', pageUrl: 'capydidatica.html', color: 'emerald' },
            { id: 'CapyQuiz', title: 'Gerador de Quizzes', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="M12 11.17L12 8"></path><path d="M12 15h.01"></path></svg>', category: 'Aprendizagem e Educação', pageUrl: 'capyquiz.html', color: 'fuchsia' }, 
            { id: 'CapyTradutor', title: 'Tradutor Inteligente', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"></path><path d="M12 19l-7-7 7-7"></path></svg>', category: 'Aprendizagem e Educação', pageUrl: 'capytradutor.html', color: 'red' },
            { id: 'CapyDebate', title: 'Simulador de Debates', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path><path d="M3 15a2 2 0 0 0 2 2h12l4 4V9a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2z"></path></svg>', category: 'Aprendizagem e Educação', pageUrl: 'capydebate.html', color: 'violet' }, 
            { id: 'CapySolucao', title: 'Professor de Matemática', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path><line x1="12" y1="22" x2="12" y2="17"></line><line x1="12" y1="12" x2="20" y2="8"></line><line x1="12" y1="12" x2="4" y2="8"></line></svg>', category: 'Aprendizagem e Educação', pageUrl: 'capysolucao.html', color: 'red' },
            { id: 'CapyTeste', title: 'Gerador de Avaliações', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline><path d="m9 14 2 2 4-4"></path></svg>', category: 'Aprendizagem e Educação', pageUrl: 'capyteste.html', color: 'purple' },
            { id: 'CapyTCC', title: 'Tutor de TCC', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path><path d="M12 13L12 7"></path><path d="M9 10L15 10"></path></svg>', category: 'Aprendizagem e Educação', pageUrl: 'capytcc.html', color: 'indigo' },
            { id: 'CapyChart', title: 'Visualizador de Dados', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>', category: 'Análise de Dados', pageUrl: 'capychart.html', color: 'teal' },
            { id: 'CapyDados', title: 'Analisador de Dados', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>', category: 'Análise de Dados', pageUrl: 'capydados.html', color: 'blue' },
            { id: 'CapyFiscal', title: 'Assistente Fiscal', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>', category: 'Análise de Dados', pageUrl: 'capyfiscal.html', color: 'green' },
            { id: 'CapyMeditacao', title: 'Guia de Meditação', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M7 12c0-1.18.42-2.24 1.12-3.05a4.29 4.29 0 0 1 6.76 0A4.208 4.208 0 0 1 17 12"/><path d="M9.5 15a5.14 5.14 0 0 0 5 0"/></svg>', category: 'Bem-Estar e Mindfulness', pageUrl: 'capymeditacao.html', color: 'cyan' },
            { id: 'CapyPrompt', title: 'Engenheiro de Prompt', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 00-7.071 17.071A9.957 9.957 0 0012 22a10 10 0 007.071-2.929A9.957 9.957 0 0012 2z"/><path d="M12 6v1m0 2v1m0 2v1m0 2v1m0 2v1"/><path d="M12 10a2 2 0 100-4 2 2 0 000 4z"/><path d="M12 18a2 2 0 100-4 2 2 0 000 4z" opacity="0.6"/></svg>', category: 'Ferramentas IA Avançadas', pageUrl: 'capyprompt.html', color: 'purple' },
            { id: 'CapyFlashCard', title: 'Gerador de FlashCards', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="M12 14l6-3-6-3-6 3 6 3z"></path><path d="M12 14v7"></path><path d="M6 12.5L12 17l6-4.5"></path></svg>', category: 'Aprendizagem e Educação', pageUrl: 'capyflashcard.html', color: 'yellow' },
        ];

        function addNotification(message, type = 'info') {
            const notificationId = 'notif-' + Date.now();
            const typeClasses = {
                error: 'bg-red-600 text-white',
                success: 'bg-green-600 text-white',
                info: 'bg-blue-600 text-white',
                warning: 'bg-yellow-500 text-black'
            };
            const notificationHTML = `
                <div id="${notificationId}" class="p-4 rounded-lg shadow-xl text-sm ${typeClasses[type] || typeClasses.info} flex justify-between items-center transition-all duration-300 opacity-0 transform translate-x-full">
                    <span>${message}</span>
                    <button onclick="removeNotification('${notificationId}')" class="ml-3 font-bold text-lg leading-none">&times;</button>
                </div>`;
            notificationArea.insertAdjacentHTML('beforeend', notificationHTML);
            const newNotification = document.getElementById(notificationId);
            void newNotification.offsetWidth; 
            requestAnimationFrame(() => {
                newNotification.classList.remove('opacity-0', 'translate-x-full');
                newNotification.classList.add('opacity-100', 'translate-x-0');
            });
            setTimeout(() => removeNotification(notificationId), 6000);
        }
        window.removeNotification = (id) => { 
            const el = document.getElementById(id);
            if (el) {
                el.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => el.remove(), 300);
            }
        };

        function loadApiKeysFromStorage() {
            Object.keys(apiKeys).forEach(provider => {
                const storedKey = localStorage.getItem(API_KEY_STORAGE_PREFIX + provider);
                if (storedKey) {
                    apiKeys[provider] = storedKey;
                    const modalInput = document.getElementById(provider + 'ApiKeyInputModal');
                    if (modalInput) modalInput.value = storedKey; 
                }
            });
            apiKey = apiKeys.gemini || ''; 
        }

        function saveApiKeyToStorage(provider, key) {
            if (key) {
                apiKeys[provider] = key;
                localStorage.setItem(API_KEY_STORAGE_PREFIX + provider, key);
                addNotification(`API Key ${provider.charAt(0).toUpperCase() + provider.slice(1)} guardada!`, 'success');
                if (provider === 'gemini') apiKey = key; 
            } else {
                apiKeys[provider] = '';
                localStorage.removeItem(API_KEY_STORAGE_PREFIX + provider);
                addNotification(`API Key ${provider.charAt(0).toUpperCase() + provider.slice(1)} removida.`, 'warning');
                if (provider === 'gemini') apiKey = ''; 
            }
        }

        function renderSidebar() {
            const categories = {};
            tools.forEach(tool => {
                if (!categories[tool.category]) {
                    categories[tool.category] = [];
                }
                categories[tool.category].push(tool);
            });

            sidebar.innerHTML = ''; 

            for (const categoryName in categories) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-2';

                const categoryButton = document.createElement('button');
                categoryButton.className = 'w-full flex justify-between items-center p-3 text-left text-gray-200 hover:bg-gray-700 rounded-md focus:outline-none';
                categoryButton.innerHTML = `
                    <span class="font-semibold">${categoryName}</span>
                    <svg class="w-5 h-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                `;
                
                const categoryContent = document.createElement('div');
                categoryContent.className = 'category-content pl-3 pt-1 space-y-1';

                categories[categoryName].forEach(tool => {
                    const link = document.createElement('a');
                    link.href = tool.pageUrl;
                    const isActive = tool.id === currentPageId;
                    link.className = `sidebar-link w-full flex items-center space-x-3 p-2.5 rounded-md text-sm hover:bg-gray-600 transition-colors duration-150 ${isActive ? 'active bg-indigo-600 text-white font-semibold' : 'text-gray-300 hover:text-white'}`;
                    
                    let iconHtml = tool.icon;
                    if (tool.color && iconHtml.includes('currentColor')) {
                        const colorMapping = {
                            blue: 'text-blue-400', yellow: 'text-yellow-400', purple: 'text-purple-400',
                            pink: 'text-pink-400', rose: 'text-rose-400', teal: 'text-teal-400',
                            cyan: 'text-cyan-400', orange: 'text-orange-400', amber: 'text-amber-400',
                            green: 'text-green-400', indigo: 'text-indigo-400', red: 'text-red-400',
                            lime: 'text-lime-400', emerald: 'text-emerald-400', violet: 'text-violet-400',
                            trueGray: 'text-gray-400', lightBlue: 'text-sky-400', warmGray: 'text-stone-400',
                            coolGray: 'text-slate-400', sky: 'text-sky-400', slate: 'text-slate-400'
                        };
                        iconHtml = iconHtml.replace('currentColor', colorMapping[tool.color] || 'text-gray-400');
                    }
                    link.innerHTML = `${iconHtml} <span class="${isActive ? 'text-white' : 'text-gray-300'}">${tool.title}</span>`;
                    categoryContent.appendChild(link);
                });

                categoryButton.addEventListener('click', () => {
                    categoryContent.classList.toggle('expanded');
                    categoryButton.querySelector('svg').classList.toggle('rotate-180');
                });
                
                if (categories[categoryName].some(tool => tool.id === currentPageId)) {
                    categoryContent.classList.add('expanded');
                    categoryButton.querySelector('svg').classList.add('rotate-180');
                }

                categoryDiv.appendChild(categoryButton);
                categoryDiv.appendChild(categoryContent);
                sidebar.appendChild(categoryDiv);
            }
        }

        sidebarToggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        });
        sidebarOverlay.addEventListener('click', () => { 
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });

        const openApiKeysModalButton = document.getElementById('openApiKeysModalButton');
        const apiKeysModal = document.getElementById('apiKeysModal');
        const closeApiKeysModalButton = document.getElementById('closeApiKeysModalButton');
        const continueWithoutKeyButtonModal = document.getElementById('continueWithoutKeyButtonModal');

        if (openApiKeysModalButton) {
            openApiKeysModalButton.addEventListener('click', () => {
                if (apiKeysModal) {
                    apiKeysModal.classList.remove('hidden');
                    Object.keys(apiKeys).forEach(provider => {
                        const modalInput = document.getElementById(provider + 'ApiKeyInputModal');
                        if (modalInput) modalInput.value = apiKeys[provider] || '';
                    });
                }
            });
        }
        if (closeApiKeysModalButton) closeApiKeysModalButton.addEventListener('click', () => apiKeysModal && apiKeysModal.classList.add('hidden'));
        if (continueWithoutKeyButtonModal) {
            continueWithoutKeyButtonModal.addEventListener('click', () => {
                if (apiKeysModal) apiKeysModal.classList.add('hidden');
                addNotification('Continuando sem chave de API. Funcionalidades podem ser limitadas ou indisponíveis.', 'info');
            });
        }
        document.querySelectorAll('.save-key-modal-button').forEach(button => {
            button.addEventListener('click', () => {
                const provider = button.dataset.provider;
                const inputElement = document.getElementById(provider + 'ApiKeyInputModal');
                if (inputElement) saveApiKeyToStorage(provider, inputElement.value.trim());
            });
        });

        function showLoading(buttonElement, show = true, defaultText = null) {
            const btnText = buttonElement.querySelector('.btn-text');
            const loader = buttonElement.querySelector('.loader');
            if (show) {
                if(btnText) btnText.classList.add('hidden');
                if(loader) loader.classList.remove('hidden');
                buttonElement.disabled = true;
            } else {
                if(btnText) {
                     btnText.classList.remove('hidden');
                     if(defaultText) btnText.textContent = defaultText;
                }
                if(loader) loader.classList.add('hidden');
                buttonElement.disabled = false;
            }
        }

        async function callGeminiAPI_getExcelInstructions(prompt, buttonElement, resultElement) {
            if (!apiKey) { 
                addNotification("API Key Gemini não configurada. Por favor, adicione sua chave no menu 'Chaves API IA's'.", "error");
                if(buttonElement) showLoading(buttonElement, false, "Obter Instruções");
                resultElement.innerHTML = `<p class="text-red-400 text-center py-8">Por favor, configure sua API Key Gemini para usar esta ferramenta.</p>`;
                exportButtonsContainer.classList.add('hidden'); // Esconde botões de exportação
                return;
            }
            if (!prompt || (typeof prompt === 'string' && !prompt.trim())) {
                 addNotification("Por favor, descreva a tarefa ou faça uma pergunta sobre Excel.", "warning");
                 if(buttonElement) showLoading(buttonElement, false, "Obter Instruções");
                return;
            }

            if(buttonElement) showLoading(buttonElement, true);
            resultElement.innerHTML = `<div class="flex items-center justify-center p-8 text-gray-400"><span class="loader mr-3"></span>Gerando instruções... Por favor, aguarde.</div>`;
            exportButtonsContainer.classList.add('hidden'); // Esconde botões de exportação enquanto carrega
            
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const currentApiKey = apiKey; 

            try {
                const res = await fetch(`${GEMINI_API_URL_BASE}${currentApiKey}`, { 
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const data = await res.json(); 

                if (!res.ok) {
                    let msg = `Erro ${res.status}: ${data?.error?.message || res.statusText}`;
                    if (res.status === 400 && msg.toLowerCase().includes("api key not valid")) { 
                        msg = "Erro: API Key Gemini inválida ou mal formatada. Verifique a chave.";
                    } else if (res.status === 403 ) { 
                        msg = "Erro 403: Acesso negado. Verifique sua API Key, habilitações e faturamento do projeto Google Cloud.";
                    }
                    throw new Error(msg);
                }
                
                if (data.promptFeedback?.blockReason) { 
                    throw new Error(`Conteúdo bloqueado pela API: ${data.promptFeedback.blockReason}. Tente reformular sua solicitação.`);
                }

                const htmlResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (htmlResponse === undefined) { 
                    throw new Error("Resposta da IA vazia ou em formato inesperado. A IA deveria retornar HTML.");
                }
                
                resultElement.innerHTML = htmlResponse; 
                addNotification("Instruções geradas!", "success");
                exportButtonsContainer.classList.remove('hidden'); // Mostra botões de exportação

            } catch (err) {
                console.error("Falha na chamada da API (Excel Instructions):", err);
                const errorMsg = err.message || "Erro desconhecido ao contatar a API.";
                resultElement.innerHTML = `<p class="text-red-400 text-center py-8">Erro ao gerar instruções: ${errorMsg}</p>`;
                addNotification(errorMsg, "error");
                exportButtonsContainer.classList.add('hidden');
            } finally {
                if(buttonElement) showLoading(buttonElement, false, "Obter Instruções");
            }
        }
        
        // Função para exportar para PDF
        function exportInstructionsToPDF() {
            const element = document.getElementById('aiResponseDiv');
            if (!element || element.textContent.trim() === "As instruções aparecerão aqui...") {
                addNotification("Nenhum conteúdo para exportar para PDF.", "warning");
                return;
            }
            const filename = `CapyExcel_Instrucoes_${new Date().toISOString().slice(0,10)}.pdf`;
            
            // Opções para html2pdf para melhor qualidade e ajuste de página
            const opt = {
              margin:       [10, 10, 15, 10], // top, left, bottom, right in mm
              filename:     filename,
              image:        { type: 'jpeg', quality: 0.98 }, // Imagens de alta qualidade
              html2canvas:  { scale: 2, logging: false, useCORS: true, letterRendering: true }, // Escala para melhor resolução
              jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
              pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] } // Tenta evitar quebras ruins
            };

            html2pdf().set(opt).from(element).save().then(() => {
                addNotification("PDF gerado com sucesso!", "success");
            }).catch(err => {
                addNotification("Erro ao gerar PDF: " + err.message, "error");
                console.error("Erro ao gerar PDF:", err);
            });
        }

        // Função para converter tabela HTML para CSV
        function tableToCSV(tableElement) {
            let csv = [];
            const rows = tableElement.querySelectorAll("tr");
            
            for (const row of rows) {
                const rowData = [];
                const cols = row.querySelectorAll("td, th");
                for (const col of cols) {
                    // Limpa o texto, remove múltiplas novas linhas/espaços e escapa aspas duplas
                    let data = col.innerText.replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, " ").trim();
                    data = data.replace(/"/g, '""'); // Escapa aspas duplas internas
                    rowData.push(`"${data}"`); // Coloca todas as células entre aspas
                }
                csv.push(rowData.join(","));
            }
            return csv.join("\n");
        }

        // Função para exportar todas as tabelas para CSV (cada uma como um arquivo separado ou concatenado)
        function exportAllTablesToCSV() {
            const tables = aiResponseDiv.querySelectorAll("table");
            if (tables.length === 0) {
                addNotification("Nenhuma tabela encontrada para exportar.", "warning");
                return;
            }

            tables.forEach((table, index) => {
                const csvData = tableToCSV(table);
                if (csvData) {
                    const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    const filename = `CapyExcel_Tabela_${index + 1}_${new Date().toISOString().slice(0,10)}.csv`;
                    
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    addNotification(`Tabela ${index + 1} exportada como CSV!`, "success");
                }
            });
             if (tables.length === 0) {
                addNotification("Nenhuma tabela encontrada para exportar.", "warning");
            }
        }


        if (getInstructionsButton) {
            getInstructionsButton.addEventListener('click', () => {
                const userQuery = excelTaskInput.value.trim();

                if (!userQuery) {
                    addNotification("Por favor, insira sua dúvida ou tarefa do Excel.", "warning");
                    return;
                }

                const promptForExcelTutor = `
Você é CapyExcel, um instrutor de Excel especializado em ajudar usuários iniciantes.
A pergunta/tarefa do usuário é: "${userQuery}"

Sua tarefa é gerar uma resposta em **HTML formatado**, com instruções passo a passo detalhadas, assumindo que o usuário **não possui nenhum conhecimento prévio de Excel**.
A resposta deve ser clara, concisa, evitar jargões técnicos e incluir exemplos práticos.

**Formato da Resposta HTML (Obrigatório):**
Use as seguintes classes CSS para estilização (já definidas na página):
- Container principal: \`<div class="excel-instructions p-4 bg-gray-700 rounded-lg">\` (A IA NÃO deve gerar esta div externa, apenas o conteúdo interno dela).
- Título principal da instrução: \`<h2 class="text-2xl font-bold text-emerald-400 mb-4">Título da Tarefa/Pergunta</h2>\`
- Títulos de cada passo: \`<h3 class="text-xl font-semibold text-emerald-300 mt-4 mb-2">Passo X: Descrição do Passo</h3>\`
- Parágrafos de texto: \`<p class="mb-2">Seu texto aqui...</p>\`
- Listas: \`<ul><li class="mb-1">Item 1</li></ul>\`
- Termos importantes ou cliques: \`<strong>Termo Importante</strong>\` ou \`<code>Nome da Guia/Botão</code>\`
- **Representação Visual com Tabelas HTML:** Em vez de imagens, quando precisar ilustrar dados, uma seleção de células, ou uma pequena parte da interface do Excel (como um menu simples ou uma caixa de diálogo com poucas opções), use uma tabela HTML.
    - Adicione uma legenda acima da tabela usando: \`<p class="table-caption">Legenda descritiva da tabela.</p>\`
    - Use a estrutura HTML de tabela padrão (\`<table>\`, \`<thead>\`, \`<tbody>\`, \`<tr>\`, \`<th>\`, \`<td>\`) com as classes CSS fornecidas no \`<style>\` da página CapyExcel (excel-instructions table, th, td).
    - Mantenha as tabelas simples e focadas no ponto que está a ser ilustrado. Por exemplo, para mostrar dados de vendas:
        <p class="table-caption">Exemplo de dados de vendas mensais:</p>
        <table>
            <thead>
                <tr><th>Mês</th><th>Vendas (R$)</th></tr>
            </thead>
            <tbody>
                <tr><td>Janeiro</td><td>1500</td></tr>
                <tr><td>Fevereiro</td><td>1800</td></tr>
                <tr><td>Março</td><td>1650</td></tr>
            </tbody>
        </table>
    - Para simular uma seleção de células, pode usar uma tabela onde algumas células têm um fundo diferente ou borda mais espessa (embora a estilização avançada de células individuais via classes CSS não seja diretamente suportada pelo prompt, a IA pode descrever a seleção e a tabela pode mostrar os dados relevantes).
- Código VBA (se estritamente necessário e útil para automatizar):
  \`<h3 class="text-xl font-semibold text-emerald-300 mt-4 mb-2">Código VBA (Opcional)</h3>\`
  \`<p class="mb-2">Se desejar automatizar, você pode usar o seguinte código VBA:</p>\`
  \`<pre><code class="language-vba">' Seu código VBA aqui...\nSub Exemplo()\n  MsgBox "Olá do CapyExcel!"\nEnd Sub</code></pre>\`
  \`<p class="mb-2">Para usar este código: 1. Pressione ALT + F11 para abrir o editor VBA. 2. Insira um novo módulo (Inserir > Módulo). 3. Cole o código. 4. Feche o editor e execute a macro.</p>\`

**Exemplo de Passo com Tabela:**
<h3 class="text-xl font-semibold text-emerald-300 mt-4 mb-2">Passo 2: Inserir os Dados</h3>
<p class="mb-2">Agora, vamos inserir os dados de vendas na sua planilha. Clique na célula <strong>A1</strong> (a primeira célula no canto superior esquerdo) e digite "Mês". Pressione Enter ou Tab para ir para a célula <strong>B1</strong> e digite "Vendas (R$)".</p>
<p class="mb-2">Depois, preencha os meses e os valores correspondentes abaixo, como no exemplo:</p>
<p class="table-caption">Dados de Vendas para o Gráfico:</p>
<table>
    <thead>
        <tr><th>Célula A</th><th>Célula B</th></tr>
    </thead>
    <tbody>
        <tr><td>Mês</td><td>Vendas (R$)</td></tr>
        <tr><td>Janeiro</td><td>1200</td></tr>
        <tr><td>Fevereiro</td><td>1500</td></tr>
        <tr><td>Março</td><td>1350</td></tr>
        <tr><td>Abril</td><td>1600</td></tr>
    </tbody>
</table>
<p class="mb-2">Certifique-se de que os seus dados estão organizados em colunas, uma para os meses (ou categorias) e outra para os valores numéricos.</p>

**Restrições:**
- A resposta DEVE ser apenas o conteúdo HTML para ser injetado dentro da \`<div id="aiResponseDiv" class="excel-instructions ...">\`. Não inclua \`<html>\`, \`<head>\`, ou \`<body>\` tags.
- Mantenha a resposta concisa, clara e focada na pergunta do usuário. O conteúdo HTML gerado não deve exceder 1200 palavras.
- Se a pergunta for muito vaga ou complexa para uma resposta passo a passo simples, peça educadamente por mais detalhes ou sugira dividir a tarefa em partes menores. Não tente responder se não puder fornecer instruções claras para um iniciante.

Comece a resposta HTML diretamente com o título principal da tarefa.
`;
                callGeminiAPI_getExcelInstructions(promptForExcelTutor, getInstructionsButton, aiResponseDiv);
            });
        }
        
        if (exportToPdfButton) {
            exportToPdfButton.addEventListener('click', exportInstructionsToPDF);
        }
        if (exportTablesToCsvButton) {
            exportTablesToCsvButton.addEventListener('click', exportAllTablesToCSV);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKeysFromStorage(); 
            renderSidebar();
        });
    </script>
</body>
</html>

