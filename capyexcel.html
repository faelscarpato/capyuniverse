<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CapyExcel - Tutor de Excel com IA</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png">
  <link rel="stylesheet" href="cu-style.css">
  <script src="cu-navigation.js" defer></script>

  <style>
    .font-jetbrains { font-family: 'JetBrains Mono', monospace; }
    .loader {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .markdown-output ul { list-style-type: disc; margin-left: 1.5rem; }
    .markdown-output code {
      background-color: #00000033;
      padding: 0.1em 0.3em;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85em;
    }
  </style>

<!-- gtag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3FFD7ZEBN1"></script>
  <script>
    window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}
    gtag('js', new Date()); gtag('config','G-3FFD7ZEBN1',{page_path:location.pathname});
  </script>

</head>
<body class="min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="cu-header">
    <div class="cu-brand">
      <a href="index.html" class="flex items-center gap-2 group">
        <div class="cu-logo flex-shrink-0">
          <img src="icons/icon-512.png" alt="CapyUniverse logo">
        </div>
        <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
      </a>
      <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyExcel</span>
    </div>
    <div class="flex items-center gap-2">
      <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
    </div>
  </header>

  <div id="notificationArea"></div>

  <div class="flex flex-1">
    <!-- SIDEBAR -->
    <aside
      id="sidebar"
      class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin"
    >
      <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
      <section class="cu-panel p-4 sm:p-6 flex flex-col h-full max-w-3xl mx-auto">
        <!-- T√çTULO -->
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold" style="color: var(--cu-emerald-400);">
            CapyExcel üìä
          </h1>
          <p class="text-cu-text-dim mt-1">
            Seu tutor especialista em Excel e Google Sheets, em modo aula particular.
          </p>
          <p class="text-xs text-cu-text-dim mt-1">
            Dica: use <span class="font-jetbrains">Ctrl + Enter</span> para enviar mais r√°pido.
          </p>
        </div>

        <!-- FORM / CONTROLES -->
        <div class="space-y-4 mb-6">
          <div class="cu-panel bg-transparent p-4 space-y-3">
            <div>
              <label for="excel-query" class="block text-sm font-semibold mb-1 text-cu-text-dim">
                Sua D√∫vida ou Tarefa:
              </label>
              <textarea
                id="excel-query"
                rows="5"
                placeholder="Ex: Como criar uma tabela din√¢mica a partir de uma base de vendas mensais?"
                class="cu-textarea w-full"
              ></textarea>
            </div>

            <!-- PRESETS -->
            <div>
              <p class="text-xs font-medium text-cu-text-dim mb-1">
                Sugest√µes r√°pidas (clique para preencher o campo acima):
              </p>
              <div class="flex flex-wrap gap-2">
                <button
                  type="button"
                  class="preset-btn text-xs px-3 py-1 rounded-full border border-zinc-700/70 hover:border-emerald-400/80 hover:bg-zinc-900/70 transition-colors"
                  data-preset="Quero criar uma tabela din√¢mica que resuma vendas por m√™s e por vendedor, a partir de uma base de dados com colunas: Data, Vendedor, Produto, Quantidade e Valor."
                >
                  Tabela din√¢mica b√°sica
                </button>
                <button
                  type="button"
                  class="preset-btn text-xs px-3 py-1 rounded-full border border-zinc-700/70 hover:border-emerald-400/80 hover:bg-zinc-900/70 transition-colors"
                  data-preset="Preciso buscar o nome de um cliente a partir do c√≥digo dele em outra aba. Hoje uso PROCV, mas quero uma vers√£o mais moderna (tipo XLOOKUP) e entender a diferen√ßa entre elas."
                >
                  PROCV / XLOOKUP
                </button>
                <button
                  type="button"
                  class="preset-btn text-xs px-3 py-1 rounded-full border border-zinc-700/70 hover:border-emerald-400/80 hover:bg-zinc-900/70 transition-colors"
                  data-preset="Quero somar o total de vendas filtrando por m√™s e por vendedor, usando SOMASES, e entender como montar os intervalos corretamente."
                >
                  SOMASES com filtros
                </button>
                <button
                  type="button"
                  class="preset-btn text-xs px-3 py-1 rounded-full border border-zinc-700/70 hover:border-emerald-400/80 hover:bg-zinc-900/70 transition-colors"
                  data-preset="Preciso criar um gr√°fico din√¢mico que se atualize automaticamente quando eu adicionar novas linhas na minha tabela de vendas."
                >
                  Gr√°fico din√¢mico
                </button>
                <button
                  type="button"
                  class="preset-btn text-xs px-3 py-1 rounded-full border border-zinc-700/70 hover:border-emerald-400/80 hover:bg-zinc-900/70 transition-colors"
                  data-preset="Quero montar uma planilha de lan√ßamento de despesas com valida√ß√£o de dados (lista suspensa para categoria) e formata√ß√£o condicional para destacar valores acima de um limite."
                >
                  Valida√ß√£o + formata√ß√£o condicional
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="experience-level" class="block text-sm font-semibold mb-1 text-cu-text-dim">
                  Seu N√≠vel:
                </label>
                <select id="experience-level" class="cu-select w-full">
                  <option>Iniciante</option>
                  <option>Intermedi√°rio</option>
                  <option>Avan√ßado</option>
                </select>
              </div>
              <div>
                <label for="software-type" class="block text-sm font-semibold mb-1 text-cu-text-dim">
                  Software:
                </label>
                <select id="software-type" class="cu-select w-full">
                  <option>Ambos</option>
                  <option>Excel</option>
                  <option>Google Sheets</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- BOT√ÉO PRINCIPAL -->
        <button id="get-help-button" class="cu-btn primary w-full text-lg flex items-center justify-center gap-2">
          <span class="btn-text">Pedir Ajuda</span>
          <div class="loader hidden"></div>
        </button>

        <!-- SA√çDA / RESPOSTA -->
        <div id="output-section" class="cu-panel bg-transparent p-4 mt-6 hidden">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold text-emerald-300">Solu√ß√£o da IA:</h3>
            <button
              id="copy-output-button"
              class="cu-btn text-xs px-3 py-1 hidden"
            >
              <i class="fas fa-copy mr-1"></i> Copiar texto
            </button>
          </div>
          <div
            id="excel-output"
            class="markdown-output text-sm mt-2 max-h-[400px] overflow-y-auto scrollbar-thin leading-relaxed space-y-2"
          ></div>
        </div>

        <!-- HIST√ìRICO -->
        <section id="history-section" class="cu-panel bg-transparent p-4 mt-4 hidden">
          <div class="flex items-center justify-between mb-1">
            <h3 class="text-sm font-semibold text-cu-text">Hist√≥rico de d√∫vidas</h3>
            <button
              id="clear-history-button"
              class="text-xs text-cu-text-dim hover:text-red-400 transition-colors"
            >
              Limpar hist√≥rico
            </button>
          </div>
          <p class="text-xs text-cu-text-dim mb-2">
            Clique em uma d√∫vida para reabrir a explica√ß√£o sem gastar nova chamada na IA.
          </p>
          <div id="history-list" class="space-y-2 text-xs"></div>
        </section>
      </section>
    </main>
  </div>

  <!-- SCRIPT PRINCIPAL -->
  <script>
  // Chaves de armazenamento
  const API_KEY_STORAGE_KEY = 'capyUniverseApiKey_gemini';
  const HISTORY_STORAGE_KEY = 'capyExcelHistory_v1';

  let apiKey = localStorage.getItem(API_KEY_STORAGE_KEY) || '';
  let historyEntries = [];

  // =========================
  // UI: LOADING DO BOT√ÉO
  // =========================
  function toggleLoading(isLoading) {
    var btn = document.getElementById('get-help-button');
    if (!btn) return;

    var loader = btn.querySelector('.loader');
    var textSpan = btn.querySelector('.btn-text');

    if (isLoading) {
      btn.disabled = true;
      btn.classList.add('opacity-60', 'cursor-not-allowed');
      if (loader) loader.classList.remove('hidden');
      if (textSpan) textSpan.textContent = 'Consultando o CapyExcel...';
    } else {
      btn.disabled = false;
      btn.classList.remove('opacity-60', 'cursor-not-allowed');
      if (loader) loader.classList.add('hidden');
      if (textSpan) textSpan.textContent = 'Pedir Ajuda';
    }
  }

  // =========================
  // MARKDOWN B√ÅSICO -> HTML
  // =========================
  function escapeHtml(str) {
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function applyInlineMarkdown(text) {
    var t = escapeHtml(text);

    // inline code
    t = t.replace(/`([^`]+)`/g, '<code>$1</code>');

    // bold
    t = t.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    t = t.replace(/__([^_]+)__/g, '<strong>$1</strong>');

    // italic
    t = t.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    t = t.replace(/_([^_]+)_/g, '<em>$1</em>');

    return t;
  }

  function markdownToHtml(md) {
    if (!md) return '';

    var lines = md.split(/\r?\n/);
    var html = '';
    var inList = false;

    for (var i = 0; i < lines.length; i++) {
      var rawLine = lines[i];
      var line = rawLine.trim();

      if (!line) {
        if (inList) {
          html += '</ul>';
          inList = false;
        }
        continue;
      }

      // T√≠tulos ##
      var headingMatch = line.match(/^(#{1,6})\s+(.*)$/);
      if (headingMatch) {
        var level = headingMatch[1].length;
        var content = applyInlineMarkdown(headingMatch[2]);
        if (inList) {
          html += '</ul>';
          inList = false;
        }
        html += '<h' + level + ' class="mt-3 mb-1 font-semibold text-emerald-200">' + content + '</h' + level + '>';
        continue;
      }

      // Listas
      if (/^[-*]\s+/.test(line)) {
        var liContent = applyInlineMarkdown(line.replace(/^[-*]\s+/, ''));
        if (!inList) {
          html += '<ul class="list-disc ml-4 mt-1 mb-1 space-y-1">';
          inList = true;
        }
        html += '<li>' + liContent + '</li>';
        continue;
      }

      if (inList) {
        html += '</ul>';
        inList = false;
      }

      html += '<p>' + applyInlineMarkdown(line) + '</p>';
    }

    if (inList) html += '</ul>';

    return html;
  }

  // =========================
  // HIST√ìRICO EM LOCALSTORAGE
  // =========================
  function loadHistory() {
    try {
      var raw = localStorage.getItem(HISTORY_STORAGE_KEY);
      if (!raw) {
        historyEntries = [];
      } else {
        historyEntries = JSON.parse(raw) || [];
      }
    } catch (e) {
      historyEntries = [];
    }
    renderHistory();
  }

  function saveHistory() {
    // mant√©m s√≥ os √∫ltimos 30
    var trimmed = historyEntries.slice(-30);
    historyEntries = trimmed;
    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(trimmed));
  }

  function addToHistory(entry) {
    historyEntries.push(entry);
    saveHistory();
    renderHistory();
  }

  function clearHistory() {
    historyEntries = [];
    saveHistory();
    renderHistory();
  }

  function renderHistory() {
    var section = document.getElementById('history-section');
    var listEl = document.getElementById('history-list');
    if (!section || !listEl) return;

    listEl.innerHTML = '';

    if (!historyEntries.length) {
      section.classList.add('hidden');
      return;
    }

    section.classList.remove('hidden');

    // mostrar mais recentes primeiro
    var entriesToShow = historyEntries.slice().reverse();

    entriesToShow.forEach(function (item) {
      var wrapper = document.createElement('button');
      wrapper.type = 'button';
      wrapper.className =
        'w-full text-left px-3 py-2 rounded-md border border-zinc-700/70 bg-zinc-900/60 hover:border-emerald-400/80 hover:bg-zinc-900 transition-colors';

      var date = new Date(item.createdAt);
      var timeStr = date.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });

      var preview =
        item.query.length > 90 ? item.query.slice(0, 90) + '...' : item.query;

      wrapper.innerHTML =
        '<div class="flex items-center justify-between gap-2 mb-1">' +
          '<span class="font-medium text-cu-text text-[0.78rem]">' + escapeHtml(preview) + '</span>' +
          '<span class="text-[0.7rem] text-cu-text-dim">' + escapeHtml(timeStr) + '</span>' +
        '</div>' +
        '<div class="flex flex-wrap gap-2 text-[0.68rem] text-cu-text-dim">' +
          '<span class="px-2 py-0.5 rounded-full border border-zinc-700/70">N√≠vel: ' + escapeHtml(item.level) + '</span>' +
          '<span class="px-2 py-0.5 rounded-full border border-zinc-700/70">Software: ' + escapeHtml(item.software) + '</span>' +
        '</div>';

      wrapper.addEventListener('click', function () {
        var queryEl = document.getElementById('excel-query');
        var levelEl = document.getElementById('experience-level');
        var softwareEl = document.getElementById('software-type');
        var outputEl = document.getElementById('excel-output');
        var outputSection = document.getElementById('output-section');
        var copyBtn = document.getElementById('copy-output-button');

        if (queryEl) queryEl.value = item.query;
        if (levelEl) levelEl.value = item.level;
        if (softwareEl) softwareEl.value = item.software;

        if (outputEl && outputSection && copyBtn && item.answerMarkdown) {
          outputEl.innerHTML = markdownToHtml(item.answerMarkdown);
          outputSection.classList.remove('hidden');
          copyBtn.classList.remove('hidden');
          outputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });

      listEl.appendChild(wrapper);
    });
  }

  // =========================
  // GEMINI: EXTRAIR TEXTO
  // =========================
  function extractTextFromGeminiResponse(result) {
    if (!result || !result.candidates || !result.candidates.length) return '';
    var content = result.candidates[0].content;
    if (!content || !content.parts || !content.parts.length) return '';
    var texts = [];
    for (var i = 0; i < content.parts.length; i++) {
      var part = content.parts[i];
      if (part && typeof part.text === 'string') {
        texts.push(part.text);
      }
    }
    return texts.join('\n');
  }

  // =========================
  // CHAMADA PRINCIPAL
  // =========================
  async function handleGetExcelHelp() {
    if (!apiKey) {
      alert("Configure a chave API do Gemini nas Chaves API do CapyUniverse.");
      return;
    }

    var queryEl = document.getElementById('excel-query');
    var levelEl = document.getElementById('experience-level');
    var softwareEl = document.getElementById('software-type');

    if (!queryEl) return;

    var query = queryEl.value.trim();
    if (!query) {
      alert("Descreva sua d√∫vida ou tarefa de Excel/Sheets.");
      return;
    }

    var level = levelEl ? levelEl.value : 'N√£o informado';
    var software = softwareEl ? softwareEl.value : 'Ambos';

    toggleLoading(true);

    // uso string normal + concatena√ß√£o para evitar problema com crases/backticks
    var promptLines = [
      'Voc√™ √© o CapyExcel, um tutor especialista em Excel e Google Sheets.',
      '',
      'Objetivo:',
      '- Ensinar o usu√°rio como se fosse uma aula particular, em portugu√™s do Brasil.',
      '- Adaptar explica√ß√µes ao n√≠vel do usu√°rio: ' + level + '.',
      '- Focar no software indicado: ' + software + ' (mas comentar diferen√ßas quando fizer sentido).',
      '',
      'Formate a resposta em Markdown, seguindo este esqueleto:',
      '',
      '## Vis√£o geral',
      'Explique em linguagem simples o que ser√° feito e em que situa√ß√£o essa t√©cnica √© √∫til.',
      '',
      '## Passo a passo',
      'Liste os passos numerados, de forma bem detalhada, como se o usu√°rio estivesse olhando para a planilha.',
      '',
      '## F√≥rmulas prontas',
      'Traga as f√≥rmulas necess√°rias, com explica√ß√£o de cada argumento.',
      '',
      '## Observa√ß√µes importantes',
      '- Pontos de aten√ß√£o',
      '- Erros comuns',
      '- Diferen√ßas entre Excel e Google Sheets (quando houver)',
      '',
      '## Exerc√≠cio guiado',
      'Monte um mini exerc√≠cio com dados de exemplo (pequena tabela) e proponha que o usu√°rio tente montar a solu√ß√£o passo a passo.',
      '',
      '## Desafio extra',
      'Sugira uma varia√ß√£o um pouco mais avan√ßada para quem quiser praticar mais.',
      '',
      'D√∫vida do usu√°rio:',
      '"' + query + '"'
    ];

    var prompt = promptLines.join('\n');

    try {
      var response = await fetch(
        'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [
              {
                parts: [
                  { text: prompt }
                ]
              }
            ]
          })
        }
      );

      if (!response.ok) {
        throw new Error('Erro na API: ' + response.status + ' ' + response.statusText);
      }

      var result = await response.json();
      var text = extractTextFromGeminiResponse(result);

      if (!text) {
        throw new Error('Resposta da IA veio vazia ou em formato inesperado.');
      }

      var outputEl = document.getElementById('excel-output');
      var outputSection = document.getElementById('output-section');
      var copyBtn = document.getElementById('copy-output-button');

      if (outputEl && outputSection && copyBtn) {
        outputEl.innerHTML = markdownToHtml(text);
        outputSection.classList.remove('hidden');
        copyBtn.classList.remove('hidden');
        outputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // salvar hist√≥rico
      addToHistory({
        id: Date.now(),
        query: query,
        level: level,
        software: software,
        createdAt: new Date().toISOString(),
        answerMarkdown: text
      });

    } catch (error) {
      console.error(error);
      alert('Erro ao consultar o CapyExcel: ' + error.message);
    } finally {
      toggleLoading(false);
    }
  }

  // =========================
  // BOOTSTRAP DOS EVENTOS
  // =========================
  document.addEventListener('DOMContentLoaded', function () {
    // recarrega key mais recente
    var savedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
    if (savedKey) apiKey = savedKey;

    loadHistory();

    var helpBtn = document.getElementById('get-help-button');
    var copyBtn = document.getElementById('copy-output-button');
    var clearHistoryBtn = document.getElementById('clear-history-button');
    var queryEl = document.getElementById('excel-query');

    if (helpBtn) {
      helpBtn.addEventListener('click', function () {
        handleGetExcelHelp();
      });
    }

    if (queryEl) {
      queryEl.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          handleGetExcelHelp();
        }
      });
    }

    if (copyBtn) {
      copyBtn.addEventListener('click', function () {
        var outputEl = document.getElementById('excel-output');
        if (!outputEl) return;
        var plainText = outputEl.innerText || '';
        navigator.clipboard
          .writeText(plainText)
          .then(function () {
            alert('Resposta copiada!');
          })
          .catch(function () {
            alert('N√£o foi poss√≠vel copiar o texto.');
          });
      });
    }

    if (clearHistoryBtn) {
      clearHistoryBtn.addEventListener('click', function () {
        if (confirm('Tem certeza que deseja limpar todo o hist√≥rico do CapyExcel?')) {
          clearHistory();
        }
      });
    }

    // Bot√µes de preset (se existirem no HTML atual)
    var presetButtons = document.querySelectorAll('.preset-btn');
    if (presetButtons && presetButtons.length) {
      presetButtons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var value = btn.getAttribute('data-preset') || '';
          var textarea = document.getElementById('excel-query');
          if (!textarea) return;
          textarea.value = value;
          textarea.focus();
          var len = textarea.value.length;
          textarea.setSelectionRange(len, len);
        });
      });
    }
  });
</script>
</body>
</html>