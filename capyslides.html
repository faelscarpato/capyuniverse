<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CapySlides — Ferramenta CapyUniverse (Responsivo + Export Fix)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Syne:wght@700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png">
  <!-- Libs para exportação -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>

  <style>
    /* ======== Tema/Glass/Gradientes (mesmo set pedido) ======== */
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --dark-gradient: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      --text-primary: #f8fafc; --text-secondary: #cbd5e1;
    }
    html { background: var(--dark-gradient); scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background: var(--dark-gradient); color: var(--text-primary); overflow-x: hidden; position: relative; }
    body::before { content:''; position:fixed; inset:0; pointer-events:none; z-index:-1;
      background: radial-gradient(circle at 20% 80%, rgba(139, 92, 246, .15) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(6, 182, 212, .15) 0%, transparent 50%),
                  radial-gradient(circle at 40% 40%, rgba(236, 72, 153, .10) 0%, transparent 50%);
    }
    .font-syne { font-family: 'Syne', sans-serif; }
    .glass { background: var(--glass-bg); backdrop-filter: blur(20px); border-radius: 1.25rem; box-shadow: var(--card-shadow); border: 1px solid var(--glass-border); }
    .sidebar-glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border-right: 1px solid var(--glass-border); }
    .global-header { background-color:#0b0b10cc; backdrop-filter: blur(10px); border-bottom:1px solid #1f2937; }
    .api-status-indicator { width:10px; height:10px; border-radius:50%; }
    .api-status-ok{ background:#22c55e } .api-status-unset{ background:#f59e0b } .api-status-error{ background:#ef4444 }

    /* ======== Slides 100% responsivos (um por linha) ======== */
    .slide-card { width: 100%; }
    .slide-frame { position: relative; width: 100%; aspect-ratio: 16 / 9; border-radius: 16px; overflow: hidden; border: 1px solid rgba(255,255,255,.08); background:#0b0d10; }
    .slide-bg-img { position:absolute; inset:0; width:100%; height:100%; object-fit: cover; filter: saturate(1.05) contrast(1.02); }
    .slide-overlay { position:absolute; inset:0; background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.55)); }
    .slide-content { position:relative; z-index:2; display:flex; height:100%; flex-direction:column; justify-content:center; padding: 40px; }
    .slide-title { font-weight:800; letter-spacing:-.02em; font-size: clamp(22px, 3.4vw, 44px); color:#fff; }
    .slide-bullets { margin-top: 14px; color:#fff; font-size: clamp(13px, 1.3vw, 18px); line-height:1.35; }
    .slide-bullets li { margin-bottom: 8px; }

    @media (min-width: 1024px) {
      /* Desktop: sempre um abaixo do outro */
      #slidesArea { display:flex; flex-direction:column; gap:24px; }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col text-[15px]">
  <!-- Header -->
  <header class="global-header w-full fixed top-0 left-0 right-0 z-40 py-1">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 h-[64px]">
      <div class="flex items-center">
        <a href="index.html" class="text-xl sm:text-2xl font-bold text-gray-100 hover:text-purple-400 transition-colors font-syne">CapyUniverse IA</a>
        <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapySlides</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400">API Gemini:</span>
        <div id="apiStatus" class="api-status-indicator api-status-unset" title="API Key Não Configurada"></div>
        <button id="openApi" class="text-zinc-400 hover:text-fuchsia-400" title="Configurar API"><i class="fas fa-key"></i></button>
      </div>
    </div>
  </header>

  <div class="flex flex-1 pt-16">
    <!-- Sidebar dummy (opcional) -->
    <aside class="sidebar-glass w-64 hidden lg:block p-3 border-r border-white/10 text-zinc-400">CapySidebar (use tools.json)</aside>

    <main class="flex-grow max-w-7xl mx-auto w-full pt-6 pb-10 px-3 sm:px-4 grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Configs -->
      <section class="md:col-span-1 glass border border-zinc-800 px-5 pt-5 pb-4 flex flex-col gap-4">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-bold text-zinc-200 font-syne">Configurações</h2>
          <button id="clearAll" class="text-xs text-zinc-400 hover:text-white"><i class="fa fa-broom"></i> Limpar</button>
        </div>

        <label class="text-sm text-zinc-300">Prompt da apresentação</label>
        <textarea id="inpPrompt" class="w-full bg-zinc-900/70 border border-zinc-700 text-zinc-100 rounded-lg px-3 py-2 min-h-[120px] outline-none focus:ring-2 focus:ring-purple-700" placeholder="Ex.: Pitch CapyUniverse: visão, problema, solução, tração, roadmap."></textarea>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-zinc-300">Nº de Slides</label>
            <select id="inpCount" class="w-full bg-zinc-900/70 border border-zinc-700 text-zinc-100 rounded-lg px-3 py-2">
              <option>4</option><option selected>6</option><option>8</option><option>10</option><option>12</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-zinc-300">Tom</label>
            <select id="inpTone" class="w-full bg-zinc-900/70 border border-zinc-700 text-zinc-100 rounded-lg px-3 py-2">
              <option selected>Profissional</option><option>Criativo</option><option>Didático</option><option>Persuasivo</option>
            </select>
          </div>
        </div>

        <label class="text-sm text-zinc-300">Público-alvo (opcional)</label>
        <input id="inpAudience" class="w-full bg-zinc-900/70 border border-zinc-700 text-zinc-100 rounded-lg px-3 py-2" placeholder="Diretoria, time de produto…" />

        <label class="text-sm text-zinc-300">Estilo visual da imagem</label>
        <input id="inpStyle" class="w-full bg-zinc-900/70 border border-zinc-700 text-zinc-100 rounded-lg px-3 py-2" placeholder="Futurista, neon, low‑poly…" />

        <div>
          <label class="text-sm text-zinc-300 mb-1">Gerador de imagens</label>
          <div class="flex items-center gap-3 text-sm">
            <label class="inline-flex items-center gap-2 cursor-pointer"><input type="radio" name="imgp" value="pollinations" checked> <span>Pollinations (grátis)</span></label>
            <label class="inline-flex items-center gap-2 cursor-pointer"><input type="radio" name="imgp" value="gemini"> <span>Gemini (API)</span></label>
          </div>
        </div>

        <button id="btnGenerate" class="w-full premium-gradient text-white rounded-xl py-2.5 font-syne text-[15px]"><i class="fa fa-wand-magic-sparkles mr-2"></i>Gerar Slides com IA</button>
        <div class="flex items-center justify-between">
          <button id="btnImprove" class="text-zinc-300 hover:text-white text-sm"><i class="fa fa-wand-magic mr-1"></i> Melhorar prompt</button>
          <button id="btnSuggest" class="text-zinc-300 hover:text-white text-sm"><i class="fa fa-lightbulb mr-1"></i> Sugerir prompt</button>
        </div>
        <p id="status" class="text-xs text-zinc-500 font-jetbrains">Pronto.</p>
      </section>

      <!-- Slides -->
      <section class="md:col-span-2 glass border border-zinc-800 p-5">
        <div class="flex items-center gap-3 mb-3 flex-wrap">
          <h3 class="text-lg font-bold font-syne">Slides Gerados</h3>
          <div class="ml-auto flex items-center gap-2">
            <button id="btnExportPNG" class="text-xs bg-zinc-800 text-white px-3 py-2 rounded-lg hover:bg-zinc-700"><i class="fa fa-file-image mr-1"></i> Exportar PNG (ZIP)</button>
            <button id="btnExportPPTX" class="text-xs bg-zinc-800 text-white px-3 py-2 rounded-lg hover:bg-zinc-700"><i class="fa fa-file-powerpoint mr-1"></i> Exportar PPTX (editável)</button>
          </div>
        </div>
        <div id="emptyState" class="border border-dashed border-zinc-700 rounded-xl p-8 text-center text-zinc-400">Descreva o que você quer e clique em <strong>Gerar Slides com IA</strong>.</div>
        <div id="slidesArea" class="flex flex-col gap-6"></div>
      </section>
    </main>
  </div>

  <!-- Modal API -->
  <div id="apiModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="glass border-zinc-800 p-6 rounded-2xl w-full max-w-md">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold text-purple-400 font-syne">Google Gemini API Key</h2>
        <button id="closeApi" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
      </div>
      <label class="block text-xs text-zinc-300 mb-1">API Key</label>
      <div class="flex">
        <input id="apiKey" type="password" class="font-jetbrains p-2 text-xs flex-grow rounded-l-md focus:ring-1 focus:ring-sky-500 outline-none bg-zinc-800 text-white border border-zinc-700" placeholder="Cole sua API Key"/>
        <button id="saveApi" class="bg-sky-500 hover:bg-sky-600 px-3 py-2 rounded-r-md text-xs text-white">Salvar</button>
      </div>
      <p class="text-xs text-zinc-400 mt-2">Usada para gerar conteúdo e (opcionalmente) imagens.</p>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 hidden items-center justify-center bg-black/70 backdrop-blur-sm z-[60]">
    <div class="text-center"><div class="animate-spin inline-block h-10 w-10 border-4 border-white/30 border-t-white rounded-full mb-3"></div><p class="text-sm text-zinc-200 font-jetbrains">Processando...</p></div>
  </div>

<script>
  // ===== Estado =====
  const LS_KEY = 'capyUniverseApiKey_gemini';
  let GEMINI_KEY = '';
  const dom = {
    apiStatus: document.getElementById('apiStatus'), openApi: document.getElementById('openApi'), apiModal: document.getElementById('apiModal'), closeApi: document.getElementById('closeApi'), apiKey: document.getElementById('apiKey'), saveApi: document.getElementById('saveApi'),
    inpPrompt: document.getElementById('inpPrompt'), inpCount: document.getElementById('inpCount'), inpTone: document.getElementById('inpTone'), inpAudience: document.getElementById('inpAudience'), inpStyle: document.getElementById('inpStyle'),
    btnGenerate: document.getElementById('btnGenerate'), btnImprove: document.getElementById('btnImprove'), btnSuggest: document.getElementById('btnSuggest'),
    clearAll: document.getElementById('clearAll'), status: document.getElementById('status'),
    slidesArea: document.getElementById('slidesArea'), empty: document.getElementById('emptyState'),
    btnExportPNG: document.getElementById('btnExportPNG'), btnExportPPTX: document.getElementById('btnExportPPTX')
  };
  let slidesData = []; // { title, bullets[], imgUrl?, imgDataUrl? }

  function setApiStatus(s){ dom.apiStatus.className='api-status-indicator ' + (s||'api-status-unset'); }
  function openModal(){ dom.apiModal.classList.remove('hidden'); dom.apiModal.classList.add('flex'); }
  function closeModal(){ dom.apiModal.classList.add('hidden'); dom.apiModal.classList.remove('flex'); }
  function loadKey(){ GEMINI_KEY = localStorage.getItem(LS_KEY)||''; if(GEMINI_KEY){ setApiStatus('api-status-ok'); dom.apiKey.value = GEMINI_KEY; } else { setApiStatus('api-status-unset'); } }

  // ===== IA =====
  async function geminiText(prompt){
    if(!GEMINI_KEY){ openModal(); throw new Error('API Key não configurada.'); }
    const body = { contents:[{ role:'user', parts:[{ text: prompt }] }], generationConfig:{ temperature:0.6, topP:0.9, topK:40 } };
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const data = await res.json(); if(!res.ok){ setApiStatus('api-status-error'); throw new Error(data?.error?.message||res.statusText); }
    setApiStatus('api-status-ok');
    const parts = data?.candidates?.[0]?.content?.parts||[]; return parts.map(p=>p.text||'').join('\n').trim();
  }
  async function geminiImageDataURL(prompt){
    if(!GEMINI_KEY) return null; // fallback Pollinations
    try{
      const body = { contents:[{ role:'user', parts:[{ text: `Gere UMA imagem 16:9 estilo ${dom.inpStyle.value||'moderno'} sobre: ${prompt}. Retorne base64 PNG.` }] }], generationConfig:{ temperature:0.6 } };
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const data = await res.json();
      const part = data?.candidates?.[0]?.content?.parts?.find(p=>p.inline_data && p.inline_data.mime_type?.includes('image'));
      if(part){ return `data:${part.inline_data.mime_type};base64,${part.inline_data.data}`; }
    }catch(e){ /* fallback */ }
    return null;
  }

  // ===== Helpers =====
  function extractJSONBlock(t){ try{ const m=t.match(/\{[\s\S]*\}/); return m? JSON.parse(m[0]):null }catch{ return null } }
  function sanitize(t){ return (t||'').replace(/[<>]/g,'').trim(); }
  function selectedImgProvider(){ const r=[...document.querySelectorAll('input[name="imgp"]')].find(x=>x.checked); return r? r.value:'pollinations'; }
  function buildPollinationsURL(prompt){ const style = dom.inpStyle.value?.trim(); const full = `${prompt}${style? ', style '+style:''}, cinematic, 16:9, ultra-detailed`; return `https://image.pollinations.ai/prompt/${encodeURIComponent(full)}?width=1280&height=720&nologo=true`; }
  async function urlToDataURL(url){ const resp = await fetch(url, {mode:'cors'}); const blob = await resp.blob(); return await new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(blob); }); }

  // ===== UI =====
  function clearSlides(){ slidesData=[]; dom.slidesArea.innerHTML=''; dom.empty.classList.remove('hidden'); toggleExports(false); }
  function toggleExports(on){ dom.btnExportPNG.disabled=!on; dom.btnExportPPTX.disabled=!on; dom.btnExportPNG.classList.toggle('opacity-50',!on); dom.btnExportPPTX.classList.toggle('opacity-50',!on); }

  function slideCardTemplate(s, i){
    const card = document.createElement('div'); card.className='slide-card';
    const frame = document.createElement('div'); frame.className='slide-frame'; frame.dataset.index=i;
    const img = document.createElement('img'); img.className='slide-bg-img'; img.decoding='async'; img.loading='lazy'; img.crossOrigin='anonymous'; if(s.imgUrl) img.src=s.imgUrl; if(s.imgDataUrl) img.src=s.imgDataUrl; 
    const overlay = document.createElement('div'); overlay.className='slide-overlay';
    const content = document.createElement('div'); content.className='slide-content';
    const h = document.createElement('h4'); h.className='slide-title'; h.textContent = s.title;
    const ul = document.createElement('ul'); ul.className='slide-bullets'; (s.bullets||[]).forEach(b=>{ const li=document.createElement('li'); li.textContent='• '+b; ul.appendChild(li); });
    content.appendChild(h); content.appendChild(ul);
    frame.appendChild(img); frame.appendChild(overlay); frame.appendChild(content);

    const tools = document.createElement('div'); tools.className='flex items-center gap-2 mt-2';
    const up = btn('fa-arrow-up','Mover para cima'); const down = btn('fa-arrow-down','Mover para baixo'); const regen = btn('fa-image','Regenerar imagem', true);
    up.onclick=()=> moveSlide(i,-1); down.onclick=()=> moveSlide(i,1); regen.onclick=()=> regenImage(i);
    tools.appendChild(up); tools.appendChild(down); tools.appendChild(regen);

    const wrap = document.createElement('div'); wrap.className='p-2 border border-zinc-700/60 rounded-xl'; wrap.appendChild(frame); wrap.appendChild(tools);
    card.appendChild(wrap); return card;
  }
  function btn(icon, title, label){ const b=document.createElement('button'); b.className='text-xs bg-zinc-800 text-white px-2 py-1 rounded hover:bg-zinc-700'; b.title=title; b.innerHTML = `<i class="fa ${icon}"></i>${label?' '+label:''}`; return b; }
  function render(){ dom.slidesArea.innerHTML=''; slidesData.forEach((s,i)=> dom.slidesArea.appendChild(slideCardTemplate(s,i))); dom.empty.classList.toggle('hidden', slidesData.length>0); toggleExports(slidesData.length>0); }
  function moveSlide(i,delta){ const ni=i+delta; if(ni<0||ni>=slidesData.length) return; const t=slidesData[i]; slidesData[i]=slidesData[ni]; slidesData[ni]=t; render(); }
  async function regenImage(i){ const s=slidesData[i]; if(!s) return; dom.status.textContent='Gerando imagem...';
    const prov = selectedImgProvider(); let durl=null, url=null;
    if(prov==='gemini') durl = await geminiImageDataURL(`${s.title}. ${dom.inpStyle.value||''}`);
    if(!durl){ url = buildPollinationsURL(`${s.title}. ${dom.inpStyle.value||''}`); }
    s.imgDataUrl = durl||null; s.imgUrl = url||null; render(); dom.status.textContent='Pronto.'; }

  // ===== Geração principal =====
  async function generate(){
    const prompt = dom.inpPrompt.value.trim(); if(!prompt){ dom.status.textContent='Digite um prompt.'; return; }
    const n = parseInt(dom.inpCount.value||'6',10); const tone = dom.inpTone.value; const audience = dom.inpAudience.value.trim();
    const sys = `Você é um criador de apresentações. Gere JSON:\n{ "slides": [ { "title":"...", "bullets":["...","..."] } ] }\nRegras: exatamente ${n} slides; títulos curtos e fortes; bullets objetivos (3 a 5); Tom: ${tone}. ${audience?('Público-alvo:'+audience):''}`;
    dom.status.textContent='Gerando conteúdo...'; document.getElementById('loading').classList.add('flex'); document.getElementById('loading').classList.remove('hidden');
    try{
      const text = await geminiText(`${sys}\n\nTema: ${prompt}`);
      const j = extractJSONBlock(text) || {}; let arr = Array.isArray(j.slides)? j.slides : [];
      if(arr.length===0){ // fallback bruto
        arr = text.split(/\n+/).filter(Boolean).slice(0,n).map((t,i)=>({ title: `Slide ${i+1}`, bullets:[t] }));
        while(arr.length<n) arr.push({ title:`Slide ${arr.length+1}`, bullets:["Ponto 1","Ponto 2","Ponto 3"] });
      }
      slidesData = arr.slice(0,n).map((s,i)=>({ title:sanitize(s.title)||`Slide ${i+1}`, bullets:(s.bullets||[]).slice(0,5).map(sanitize) }));
      // imagens
      const prov = selectedImgProvider();
      for(let i=0;i<slidesData.length;i++){
        const s = slidesData[i];
        let durl = null, url = null;
        if(prov==='gemini') durl = await geminiImageDataURL(`${prompt}. ${s.title}. ${dom.inpStyle.value||''}`);
        if(!durl) url = buildPollinationsURL(`${prompt}. ${s.title}. ${dom.inpStyle.value||''}`);
        s.imgDataUrl = durl||null; s.imgUrl = url||null;
      }
      render(); dom.status.textContent='Slides prontos!';
    }catch(e){ dom.status.textContent='Erro: '+e.message; }
    finally{ document.getElementById('loading').classList.add('hidden'); document.getElementById('loading').classList.remove('flex'); }
  }

  // ===== Export PNG (com imagem, CORS OK) =====
  async function exportPNGsZip(){ if(!slidesData.length) return; document.getElementById('loading').classList.add('flex'); document.getElementById('loading').classList.remove('hidden');
    try{
      const zip = new JSZip();
      const frames = [...document.querySelectorAll('.slide-frame')];
      let idx=1;
      for(const frame of frames){
        const dataUrl = await html2canvas(frame, { useCORS:true, allowTaint:false, backgroundColor:null, scale:2 });
        const b64 = dataUrl.toDataURL? dataUrl.toDataURL('image/png') : dataUrl; // compat
        const out = b64.startsWith('data:')? b64.split(',')[1] : b64;
        zip.file(`slide_${String(idx).padStart(2,'0')}.png`, out, {base64:true}); idx++;
      }
      const blob = await zip.generateAsync({type:'blob'}); saveAs(blob, 'capyslides_png.zip');
    }catch(e){ alert('Erro ao exportar PNG: '+e.message); }
    finally{ document.getElementById('loading').classList.add('hidden'); document.getElementById('loading').classList.remove('flex'); }
  }

  // ===== Export PPTX (EDITÁVEL: texto como elementos) =====
  async function exportPPTX(){ if(!slidesData.length) return; document.getElementById('loading').classList.add('flex'); document.getElementById('loading').classList.remove('hidden');
    try{
      const pptx = new PptxGenJS(); pptx.layout='LAYOUT_16x9';
      for(const s of slidesData){
        const slide = pptx.addSlide();
        // Fundo: se houver imagem, aplica como background visual
        let bgData = s.imgDataUrl || (s.imgUrl? await urlToDataURL(s.imgUrl): null);
        if(bgData){ slide.addImage({ data:bgData, x:0, y:0, w:pptx.width, h:pptx.height }); }
        // Título (EDITÁVEL)
        slide.addText(s.title, { x:0.5, y:0.6, w:pptx.width-1, h:1, fontFace:'Inter', fontSize:28, bold:true, color:'FFFFFF' });
        // Bullets (EDITÁVEIS)
        const txt = (s.bullets||[]).map(b=>'• '+b).join('\n');
        slide.addText(txt, { x:0.5, y:1.6, w:pptx.width-1, h:4.5, fontFace:'Inter', fontSize:16, color:'FFFFFF', lineSpacingMultiple:1.2 });
      }
      await pptx.writeFile({ fileName:'CapySlides_editavel.pptx' });
    }catch(e){ alert('Erro ao exportar PPTX: '+e.message); }
    finally{ document.getElementById('loading').classList.add('hidden'); document.getElementById('loading').classList.remove('flex'); }
  }

  // ===== Eventos =====
  dom.openApi.onclick = openModal; dom.closeApi.onclick = closeModal; dom.saveApi.onclick = ()=>{ const k=dom.apiKey.value.trim(); if(!k) return; localStorage.setItem(LS_KEY,k); GEMINI_KEY=k; setApiStatus('api-status-ok'); closeModal(); };
  dom.btnGenerate.onclick = generate; dom.clearAll.onclick = clearSlides; dom.btnImprove.onclick = async()=>{ if(!dom.inpPrompt.value.trim()) return; try{ const t=await geminiText(`Melhore o prompt abaixo e retorne apenas o prompt melhorado.\n\n${dom.inpPrompt.value}`); dom.inpPrompt.value=t; }catch{} };
  dom.btnSuggest.onclick = async()=>{ try{ const t=await geminiText('Sugira um prompt criativo e detalhado para gerar uma apresentação (retorne apenas o prompt).'); dom.inpPrompt.value=t; }catch{} };
  dom.btnExportPNG.onclick = exportPNGsZip; dom.btnExportPPTX.onclick = exportPPTX;

  // Boot
  loadKey();
</script>
</body>
</html>
