<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CapyContrato - Gerador de Contratos IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Bibliotecas de exportação: jsPDF para PDF baseado em texto; docx para Word; FileSaver para download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.3.1/docx.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png">
    <link rel="stylesheet" href="cu-style.css">
    <script src="cu-navigation.js" defer></script>

    <style>
        .font-jetbrains { font-family: 'JetBrains Mono', monospace; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--cu-purple); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #generatedContractHtml { background-color: #ffffff; color: #111827; padding: 20mm; border: 1px solid #d1d5db; min-height: 297mm; width: 210mm; margin: 1rem auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.5; overflow-y: auto; max-height: 80vh; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="cu-header">
        <div class="cu-brand">
            <a href="index.html" class="flex items-center gap-2 group">
                <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png"></div>
                <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
            </a>
            <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyContrato</span>
        </div>
        <div class="flex items-center gap-2">
            <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
        </div>
    </header>

    <div id="notificationArea"></div>

    <div class="flex flex-1">
        <aside id="sidebar" class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin">
            <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
        </aside>

        <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
            <section class="cu-panel p-4 sm:p-6 flex flex-col h-full max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold" style="color: var(--cu-purple);">CapyContrato 📝</h1>
                    <p class="text-cu-text-dim mt-1">Seu assistente IA para geração de modelos de contrato.</p>
                </div>
                
                <div class="mb-6">
                    <label for="contractTypeSelect" class="block text-sm font-medium text-cu-text-dim mb-2">1. Tipo de Contrato</label>
                    <select id="contractTypeSelect" class="cu-select w-full">
                        <option value="">-- Selecione --</option>
                        <option value="prestacao_servicos_geral">Prestação de Serviços (Geral)</option>
                        <option value="aluguel_residencial">Aluguel Residencial</option>
                        <option value="nda">Acordo de Confidencialidade (NDA)</option>
                    </select>
                </div>

                <!-- Formulário dinâmico removido; agora solicitamos detalhes do contrato -->
                <div id="contractDetailsContainer" class="mb-6">
                    <label for="contractDetails" class="block text-sm font-medium text-cu-text-dim mb-2">2. Detalhes e Finalidade do Contrato</label>
                    <textarea id="contractDetails" rows="6" placeholder="Explique a finalidade do contrato, as partes envolvidas, obrigações, prazos, valores, cláusulas específicas, etc." class="cu-textarea w-full"></textarea>
                </div>
                
                <button id="generateContractButton" class="cu-btn primary w-full text-lg">
                    <span class="btn-text">Gerar Contrato</span>
                    <div class="loader hidden"></div>
                </button>
                
                <div id="contractResultArea" class="mt-6 space-y-2 hidden">
                    <div class="flex flex-wrap justify-between items-center mb-3 gap-2">
                        <h3 class="text-xl font-semibold">Modelo Gerado</h3>
                        <div id="exportButtonsContainer" class="flex flex-wrap gap-2">
                            <button id="copyContractButton" class="cu-btn"><i class="fas fa-copy"></i> Copiar</button>
                            <button id="exportToTxtButton" class="cu-btn"><i class="fas fa-file-alt"></i> TXT</button>
                            <button id="exportToPdfButton" class="cu-btn"><i class="fas fa-file-pdf"></i> PDF</button>
                            <button id="exportToDocxButton" class="cu-btn"><i class="fas fa-file-word"></i> DOCX</button>
                        </div>
                    </div>
                    <div class="cu-panel bg-transparent p-1">
                        <div id="generatedContractHtml" class="p-4 rounded-md" contenteditable="true" style="white-space: pre-wrap;"></div>
                    </div>
                    <p class="text-xs text-amber-300 mt-2 text-center bg-amber-500/10 p-2 rounded">Atenção: Este é um modelo. Recomenda-se a revisão por um profissional.</p>
                </div>
            </section>
        </main>
    </div>

    <script>
        let apiKey = localStorage.getItem('capyUniverseApiKey_gemini') || '';
        const dom = { /* DOM elements */ };
        // Simplified script logic, assuming cu-navigation.js handles sidebar and modals

        document.addEventListener('DOMContentLoaded', () => {
            // Elementos do DOM
            const contractTypeSelect = document.getElementById('contractTypeSelect');
            const detailsTextarea = document.getElementById('contractDetails');
            const generateBtn = document.getElementById('generateContractButton');
            const resultArea = document.getElementById('contractResultArea');
            const outputDiv = document.getElementById('generatedContractHtml');
            const copyBtn = document.getElementById('copyContractButton');
            const txtBtn = document.getElementById('exportToTxtButton');
            const pdfBtn = document.getElementById('exportToPdfButton');
            const docxBtn = document.getElementById('exportToDocxButton');

            // Indicador de carregamento no botão
            function toggleLoading(isLoading) {
                const loader = generateBtn.querySelector('.loader');
                const btnText = generateBtn.querySelector('.btn-text');
                if (isLoading) {
                    generateBtn.disabled = true;
                    loader && loader.classList.remove('hidden');
                    btnText && btnText.classList.add('hidden');
                } else {
                    generateBtn.disabled = false;
                    loader && loader.classList.add('hidden');
                    btnText && btnText.classList.remove('hidden');
                }
            }

            // Conversão simples de Markdown para HTML (negrito, itálico e listas)
            function basicMarkdownToHtml(md) {
                if (!md) return '';
                let html = md;
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
                html = html.replace(/_(.*?)_/g, '<em>$1</em>');
                html = html.replace(/^\s*[-*]\s+(.*)$/gm, '<li>$1</li>');
                if (html.includes('<li>')) {
                    html = html.replace(/(<li>.*?<\/li>(?:\s*<li>.*?<\/li>)*)/gs, '<ul class="list-disc list-inside ml-4 space-y-1">$1</ul>');
                }
                html = html.split(/\n\s*\n/).map(p => p.trim() ? `<p>${p.replace(/\n/g, '<br>')}</p>` : '').join('');
                return html;
            }

            // Gera contrato via IA
            async function generateContract() {
                if (!apiKey) {
                    alert('Configure a chave API do Gemini nas Chaves API.');
                    return;
                }
                const type = contractTypeSelect.value;
                if (!type) {
                    alert('Selecione o tipo de contrato.');
                    return;
                }
                const details = (detailsTextarea.value || '').trim();
                if (!details) {
                    alert('Forneça detalhes e finalidade do contrato.');
                    return;
                }
                toggleLoading(true);
                resultArea.classList.remove('hidden');
                outputDiv.innerHTML = '<p class="text-cu-text-dim">Gerando contrato...</p>';
                try {
                    // Construir prompt detalhado
                    const typeLabel = {
                        prestacao_servicos_geral: 'Prestação de Serviços (Geral)',
                        aluguel_residencial: 'Aluguel Residencial',
                        nda: 'Acordo de Confidencialidade (NDA)'
                    }[type] || type;
                    const prompt = [
                        'Você é o CapyContrato, um especialista em elaboração de contratos jurídicos. Gere um contrato do tipo ' + typeLabel + ' conforme a legislação brasileira.',
                        '',
                        'Objetivo e detalhes fornecidos pelo usuário:',
                        details,
                        '',
                        'Instruções:',
                        '- Escreva em português do Brasil, com linguagem formal e precisa;',
                        '- Utilize seções claras e numeradas, como Preâmbulo, Objeto, Obrigações das Partes, Forma de Pagamento, Prazos, Confidencialidade (se aplicável), Rescisão, Foros, etc.;',
                        '- Inclua cláusulas padrão pertinentes a ' + typeLabel + ', mas adapte ao contexto fornecido;',
                        '- Para nomes, valores, prazos ou outros dados específicos, use colchetes [exemplo], para que o usuário possa preencher depois;',
                        '- No final, adicione um campo para assinaturas das partes;',
                        '',
                        'Responda com o texto completo do contrato, formatado utilizando Markdown (títulos com ## e ###, listas numeradas com 1., 2., etc., e listas com - quando necessário).'
                    ].join('\n');
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) throw new Error('Erro na API: ' + response.status);
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error('Resposta da IA vazia.');
                    // Apresenta contrato gerado e permite edição
                    outputDiv.innerHTML = basicMarkdownToHtml(text);
                } catch (error) {
                    console.error(error);
                    outputDiv.innerHTML = `<p class="text-red-500">Erro ao gerar contrato: ${error.message}</p>`;
                } finally {
                    toggleLoading(false);
                }
            }

            // Exportação do contrato em diferentes formatos
            async function exportContract(format) {
                const htmlContent = outputDiv.innerHTML;
                const plainText = outputDiv.innerText || '';
                if (!plainText.trim()) {
                    alert('Nenhum contrato disponível para exportar.');
                    return;
                }
                if (format === 'txt') {
                    const blob = new Blob([plainText], { type: 'text/plain;charset=utf-8' });
                    saveAs(blob, 'contrato.txt');
                } else if (format === 'pdf') {
                    // Exporta PDF baseado em texto para preservar a qualidade
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    const margin = 10;
                    const maxWidth = pdf.internal.pageSize.getWidth() - margin * 2;
                    // Converte quebras de linha do texto em linhas que cabem na página
                    const lines = pdf.splitTextToSize(plainText, maxWidth);
                    pdf.text(lines, margin, margin + 10);
                    pdf.save('contrato.pdf');
                } else if (format === 'docx') {
                    try {
                        // Converte o texto simples em parágrafos para o documento Word
                        const doc = new window.docx.Document();
                        const paragraphs = plainText.split(/\n/).map(line => new window.docx.Paragraph(line || ''));
                        doc.addSection({ children: paragraphs });
                        const blob = await window.docx.Packer.toBlob(doc);
                        saveAs(blob, 'contrato.docx');
                    } catch (err) {
                        console.error('Erro ao exportar DOCX:', err);
                        alert('Erro ao exportar DOCX: ' + err.message);
                    }
                }
            }

            // Eventos
            generateBtn.addEventListener('click', generateContract);
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    const text = outputDiv.innerText || '';
                    if (!text.trim()) {
                        alert('Nada para copiar.');
                        return;
                    }
                    navigator.clipboard.writeText(text).then(() => alert('Contrato copiado!'));
                });
            }
            if (txtBtn) txtBtn.addEventListener('click', () => exportContract('txt'));
            if (pdfBtn) pdfBtn.addEventListener('click', () => exportContract('pdf'));
            if (docxBtn) docxBtn.addEventListener('click', () => exportContract('docx'));
        });
    </script>
</body>
</html>

