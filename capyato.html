<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CapyAto — Ações Jurídicas por Voz</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png" />
  <link rel="stylesheet" href="cu-style.css" />
  <script src="cu-navigation.js" defer></script>

<!-- gtag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3FFD7ZEBN1"></script>
  <script>
    window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}
    gtag('js', new Date()); gtag('config','G-3FFD7ZEBN1',{page_path:location.pathname});
  </script>

</head>
<body class="min-h-screen flex flex-col">
  <header class="cu-header">
    <div class="cu-brand">
        <a href="index.html" class="flex items-center gap-2 group">
            <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png"></div>
            <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
        </a>
        <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyAto</span>
    </div>
    <div class="flex items-center gap-2">
        <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
    </div>
  </header>

  <div id="notificationArea"></div>

  <div class="flex flex-1">
    <aside id="sidebar" class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin">
      <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
    </aside>

    <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
      <section class="cu-panel p-5 sm:p-6 lg:p-8 flex flex-col">
        <div class="text-center mb-6 sm:mb-8">
          <h1 class="text-2xl sm:text-3xl font-bold" style="color: var(--cu-purple);">CapyAto ⚖️</h1>
          <p class="text-cu-text-dim mt-1">Transforme comandos de voz em petições e resumos de processos com IA.</p>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-[380px,1fr] gap-6">
          <aside class="cu-panel bg-transparent p-4 space-y-4">
            <div class="flex items-center gap-2 mb-3">
              <i class="fas fa-microphone-alt text-cu-text-dim"></i>
              <h2 class="text-lg font-semibold">Comando</h2>
            </div>
            <label class="block text-sm text-cu-text-dim">Digite ou fale o seu pedido</label>
            <textarea id="commandInput" rows="4" class="cu-textarea mt-1" placeholder="Ex: elaborar recurso de apelação para caso X"></textarea>
            <button id="btnRecord" class="mt-3 w-full cu-btn primary justify-center">
              <i class="fas fa-microphone"></i> Falar
            </button>
            <div class="grid grid-cols-2 gap-3 mt-4">
              <button id="btnPeticao" class="cu-btn justify-center" disabled>
                <i class="fas fa-file-alt"></i> Gerar Petição
              </button>
              <button id="btnResumoProc" class="cu-btn justify-center" disabled>
                <i class="fas fa-compress-alt"></i> Resumo Processo
              </button>
            </div>
            <button id="btnOuvirAto" class="mt-3 w-full cu-btn justify-center" disabled>
              <i class="fas fa-volume-up"></i> Ouvir Resultado
            </button>
          </aside>
          <section class="cu-panel bg-transparent p-4 flex flex-col">
            <h3 class="text-lg font-semibold text-cu-text">Resultado</h3>
            <textarea id="resultAto" class="cu-textarea mt-1 flex-grow" placeholder="O resultado aparecerá aqui..." readonly></textarea>
            <div class="flex gap-4 mt-4">
              <button id="btnCopyAto" class="cu-btn" disabled><i class="fas fa-copy"></i> Copiar</button>
              <button id="btnExportAto" class="cu-btn" disabled><i class="fas fa-file-export"></i> Exportar</button>
            </div>
          </section>
        </div>
      </section>
    </main>
  </div>

  <script>
    const dom = {
      commandInput: document.getElementById('commandInput'),
      btnRecord: document.getElementById('btnRecord'),
      btnPeticao: document.getElementById('btnPeticao'),
      btnResumoProc: document.getElementById('btnResumoProc'),
      btnOuvirAto: document.getElementById('btnOuvirAto'),
      resultAto: document.getElementById('resultAto'),
      btnCopyAto: document.getElementById('btnCopyAto'),
      btnExportAto: document.getElementById('btnExportAto')
    };

    let apiKey = localStorage.getItem('capyUniverseApiKey_gemini') || '';
    let recognition;
    let recording = false;

    function updateButtons() {
      const hasCommand = dom.commandInput.value.trim().length > 0;
      [dom.btnPeticao, dom.btnResumoProc].forEach(btn => btn.disabled = !hasCommand);
      const hasResult = dom.resultAto.value.trim().length > 0;
      [dom.btnOuvirAto, dom.btnCopyAto, dom.btnExportAto].forEach(btn => btn.disabled = !hasResult);
    }

    function startRecording() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return alert('Reconhecimento de fala não suportado.');
      
      recognition = new SpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.onresult = (event) => {
        dom.commandInput.value = event.results[0][0].transcript;
        updateButtons();
      };
      recognition.onerror = (event) => alert('Erro no reconhecimento: ' + event.error);
      recognition.onend = () => {
        recording = false;
        dom.btnRecord.innerHTML = '<i class="fas fa-microphone"></i> Falar';
      };
      recognition.start();
      recording = true;
      dom.btnRecord.innerHTML = '<i class="fas fa-stop"></i> Parar';
    }

    function stopRecording() {
      if (recognition) recognition.stop();
    }

    async function handleGenerateAto(type) {
      if (!apiKey) return alert('Configure a chave API do Gemini.');
      const cmd = dom.commandInput.value.trim();
      if (!cmd) return alert('Insira um comando.');

      [dom.btnPeticao, dom.btnResumoProc].forEach(btn => btn.disabled = true);
      dom.resultAto.value = "Gerando..."

      const prompt = type === 'peticao'
        ? `Como um assistente jurídico, elabore uma petição formal com base no comando: "${cmd}"`
        : `Resuma o seguinte processo ou situação jurídica: "${cmd}"`;

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        if (!response.ok) throw new Error(`Erro na API: ${response.status}`);
        const data = await response.json();
        dom.resultAto.value = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || 'Nenhum resultado.';
      } catch (err) {
        dom.resultAto.value = `Falha: ${err.message}`;
      }
      updateButtons();
    }

    function speakAto() {
      const text = dom.resultAto.value.trim();
      if (text) speechSynthesis.speak(new SpeechSynthesisUtterance(text));
    }

    function copyAto() {
      if (dom.resultAto.value) navigator.clipboard.writeText(dom.resultAto.value).then(() => alert('Resultado copiado!'));
    }

    function exportAto() {
      if (!dom.resultAto.value) return;
      const blob = new Blob([dom.resultAto.value], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `capyato_${Date.now()}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const savedKey = localStorage.getItem('capyUniverseApiKey_gemini');
      if (savedKey) apiKey = savedKey;

      dom.commandInput.addEventListener('input', updateButtons);
      dom.btnRecord.addEventListener('click', () => recording ? stopRecording() : startRecording());
      dom.btnPeticao.addEventListener('click', () => handleGenerateAto('peticao'));
      dom.btnResumoProc.addEventListener('click', () => handleGenerateAto('resumo'));
      dom.btnOuvirAto.addEventListener('click', speakAto);
      dom.btnCopyAto.addEventListener('click', copyAto);
      dom.btnExportAto.addEventListener('click', exportAto);
    });
  </script>
</body>
</html>

