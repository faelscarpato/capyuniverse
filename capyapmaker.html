<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CapyAPPMaker: Construtor de Aplicativos com IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="icons/icon-192.png">
  <link rel="stylesheet" href="cu-style.css">
  <script src="cu-navigation.js" defer></script>

  <style>
    .font-jetbrains { font-family: 'JetBrains Mono', monospace; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--cu-purple); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .radio-group input[type="radio"] { display: none; }
    .radio-group label {
        cursor: pointer; padding: 0.5rem 1rem; border-radius: 999px; border: 1px solid #ffffff22;
        background-color: #ffffff11; transition: all 0.2s ease;
    }
    .radio-group input[type="radio"]:checked + label {
        background: var(--premium-gradient);
        color: white; border-color: transparent;
    }

    .code-output-area {
        background-color: #00000033;
        border-radius: var(--cu-radius);
        padding: 1rem;
        min-height: 200px;
        max-height: 600px;
        overflow-y: auto;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.875rem;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <header class="cu-header">
    <div class="cu-brand">
        <a href="index.html" class="flex items-center gap-2 group">
            <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png"></div>
            <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
        </a>
        <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyAPPMaker</span>
    </div>
    <div class="flex items-center gap-2">
        <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
    </div>
  </header>

  <div id="notificationArea"></div>

  <div class="flex flex-1">
    <aside id="sidebar" class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin">
        <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
    </aside>

    <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
      <section class="cu-panel p-4 sm:p-6 flex flex-col max-w-3xl mx-auto">
        <div class="text-center mb-8">
          <div class="mx-auto h-12 w-12 text-purple-400 mb-2 flex items-center justify-center text-4xl">
            <i class="fas fa-cubes"></i>
          </div>
          <h1 class="text-3xl font-bold text-purple-400">CapyAPPMaker</h1>
          <p class="text-md text-cu-text-dim mt-1">Transforme ideias em realidade digital num piscar de olhos.</p>
        </div>

        <div class="space-y-6">
          <div class="cu-panel bg-transparent p-4">
            <label for="appDescription" class="block text-sm font-semibold mb-2">1. Descreva o aplicativo:</label>
            <textarea id="appDescription" rows="4" placeholder="Ex: Um app de lista de tarefas simples..." class="cu-textarea w-full"></textarea>
            <button id="improvePromptButton" class="mt-2 cu-btn w-full">
                <i class="fas fa-magic"></i> Melhorar Descrição com IA
            </button>
          </div>

          <div class="cu-panel bg-transparent p-4">
            <label class="block text-sm font-semibold mb-2">2. Recursos Chave:</label>
            <div class="radio-group flex flex-wrap gap-2">
                <input type="radio" id="featureNone" name="appFeatures" value="none" checked><label for="featureNone">Nenhum</label>
                <input type="radio" id="featureAuth" name="appFeatures" value="Autenticação"><label for="featureAuth">Autenticação</label>
                <input type="radio" id="featureDataDisplay" name="appFeatures" value="Exibição de Dados"><label for="featureDataDisplay">Exibição de Dados</label>
                <input type="radio" id="featureForm" name="appFeatures" value="Formulários"><label for="featureForm">Formulários</label>
            </div>
          </div>

          <div class="cu-panel bg-transparent p-4">
            <label class="block text-sm font-semibold mb-2">3. Tipo de Aplicativo:</label>
            <div class="radio-group flex flex-wrap gap-2">
                <input type="radio" id="typeWeb" name="appType" value="web" checked><label for="typeWeb">Web (HTML/CSS/JS)</label>
                <input type="radio" id="typeReact" name="appType" value="react"><label for="typeReact">Web (React)</label>
                <input type="radio" id="typeMobileConcept" name="appType" value="mobile-concept"><label for="typeMobileConcept">Conceito Mobile</label>
            </div>
          </div>

          <div class="cu-panel bg-transparent p-4">
            <label class="block text-sm font-semibold mb-2">4. Estilização:</label>
            <div class="radio-group flex flex-wrap gap-2">
                <input type="radio" id="techNone" name="techStack" value="none" checked><label for="techNone">Nenhum</label>
                <input type="radio" id="techTailwind" name="techStack" value="Tailwind CSS"><label for="techTailwind">Tailwind CSS</label>
                <input type="radio" id="techBootstrap" name="techStack" value="Bootstrap"><label for="techBootstrap">Bootstrap</label>
            </div>
          </div>

          <button id="generateAppButton" class="cu-btn primary w-full text-lg">
            <i class="fas fa-cogs"></i> Gerar Aplicativo
          </button>

          <div id="appCodeOutput" class="code-output-area mt-6 scrollbar-thin">
            <p class="text-cu-text-dim">O código do seu aplicativo aparecerá aqui.</p>
          </div>

          <div id="codeActions" class="flex gap-2 justify-end mt-2 hidden">
            <button id="previewAppButton" class="cu-btn"><i class="fas fa-eye"></i> Pré-visualizar</button>
            <button id="downloadAppButton" class="cu-btn"><i class="fas fa-download"></i> Download</button>
            <button id="copyCodeButton" class="cu-btn"><i class="fas fa-copy"></i> Copiar</button>
          </div>

          <div id="vercelInstructions" class="cu-panel bg-transparent p-4 hidden">
            <h3 class="text-lg font-bold text-purple-300 mb-2">Como Hospedar no Vercel:</h3>
            <ol class="list-decimal list-inside space-y-1 text-cu-text-dim text-sm">
              <li>Clique em "Download" para baixar o código.</li>
              <li>Salve o conteúdo no arquivo apropriado (ex: `index.html` ou `App.js`).</li>
              <li>Crie uma conta gratuita no <a href="https://vercel.com/" target="_blank" rel="noopener noreferrer" class="text-sky-400 hover:underline">Vercel</a> e faça o deploy.</li>
            </ol>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="appPreviewModal" class="fixed inset-0 flex items-center justify-center z-50 p-4 modal-hidden">
      <div class="absolute inset-0 bg-black modal-overlay-bg opacity-75"></div>
      <div class="modal-content cu-panel w-11/12 h-5/6 flex flex-col">
          <header class="flex items-center justify-between p-2 border-b border-white/10">
              <h2 class="text-lg font-bold">Pré-visualização</h2>
              <button id="closePreviewModalButton" class="cu-btn p-2"><i class="fas fa-times"></i></button>
          </header>
          <iframe id="appPreviewIframe" class="flex-grow bg-white"></iframe>
      </div>
  </div>

  <script type="module">
    const dom = {
        appDescriptionInput: document.getElementById('appDescription'),
        improvePromptButton: document.getElementById('improvePromptButton'),
        generateAppButton: document.getElementById('generateAppButton'),
        appCodeOutput: document.getElementById('appCodeOutput'),
        vercelInstructions: document.getElementById('vercelInstructions'),
        codeActions: document.getElementById('codeActions'),
        copyCodeButton: document.getElementById('copyCodeButton'),
        previewAppButton: document.getElementById('previewAppButton'),
        downloadAppButton: document.getElementById('downloadAppButton'),
        appPreviewModal: document.getElementById('appPreviewModal'),
        closePreviewModalButton: document.getElementById('closePreviewModalButton'),
        appPreviewIframe: document.getElementById('appPreviewIframe'),
    };

    let generatedCode = '';
    let geminiApiKey = localStorage.getItem('capyUniverseApiKey_gemini') || '';

    const showLoading = (element, message) => {
        element.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><div class="loader"></div><p class="mt-2 text-cu-text-dim">${message}</p></div>`;
    };

    const displayCode = (element, code) => {
        element.innerHTML = `<pre><code class="language-html">${escapeHtml(code)}</code></pre>`;
        generatedCode = code;
        dom.vercelInstructions.classList.remove('hidden');
        dom.codeActions.classList.remove('hidden');
    };

    function escapeHtml(text) {
        return text.replace(/[&<>"'/]/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[m] || m));
    }

    async function callGemini(prompt, button) {
        if (!geminiApiKey) {
            alert("Chave API Gemini não configurada.");
            return null;
        }
        button.disabled = true;
        const originalText = button.innerHTML;
        button.innerHTML = '<div class="loader"></div>';

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) throw new Error(`Erro na API: ${response.status}`);
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || null;
        } catch (error) {
            console.error("Erro na API Gemini:", error);
            alert("Erro ao comunicar com a IA.");
            return null;
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    dom.improvePromptButton.addEventListener('click', async () => {
        const currentDescription = dom.appDescriptionInput.value.trim();
        if (!currentDescription) return alert('Insira uma descrição para melhorar.');
        const improved = await callGemini(`Melhore e detalhe a seguinte descrição de aplicativo para geração de código: "${currentDescription}"`, dom.improvePromptButton);
        if (improved) dom.appDescriptionInput.value = improved.trim();
    });

    dom.generateAppButton.addEventListener('click', async () => {
        const appDescription = dom.appDescriptionInput.value.trim();
        if (!appDescription) return alert('Descreva o aplicativo a ser criado.');
        
        const appType = document.querySelector('input[name="appType"]:checked').value;
        const techStack = document.querySelector('input[name="techStack"]:checked').value;
        const features = document.querySelector('input[name="appFeatures"]:checked').value;

        let prompt = `Gere o código completo e funcional de um aplicativo.`;
        if (appType === 'web') prompt += ` App web em HTML, CSS e JS em um único arquivo.`;
        else if (appType === 'react') prompt += ` Componente React completo (App.js).`;
        else if (appType === 'mobile-concept') prompt = `Descreva um conceito de app mobile.`;

        prompt += `\nDescrição: "${appDescription}"`;
        if (features !== 'none') prompt += `\nRecursos: ${features}.`;
        if (techStack !== 'none') prompt += `\nEstilização: ${techStack}.`;
        if (appType !== 'mobile-concept') prompt += `\nO código deve ser entregue diretamente, sem formatação markdown.`;

        showLoading(dom.appCodeOutput, 'Gerando seu aplicativo...');
        const code = await callGemini(prompt, dom.generateAppButton);
        if (code) displayCode(dom.appCodeOutput, code);
    });

    dom.copyCodeButton.addEventListener('click', () => {
        if (generatedCode) navigator.clipboard.writeText(generatedCode).then(() => alert('Código copiado!'));
    });

    dom.previewAppButton.addEventListener('click', () => {
        if (!generatedCode) return alert('Nenhum código para pré-visualizar.');
        const blob = new Blob([generatedCode], { type: 'text/html' });
        dom.appPreviewIframe.src = URL.createObjectURL(blob);
        dom.appPreviewModal.classList.remove('modal-hidden');
    });

    dom.downloadAppButton.addEventListener('click', () => {
        if (!generatedCode) return alert('Nenhum código para download.');
        const appType = document.querySelector('input[name="appType"]:checked').value;
        const filename = appType === 'react' ? 'App.js' : 'index.html';
        const blob = new Blob([generatedCode], { type: appType === 'react' ? 'text/javascript' : 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
    });

    dom.closePreviewModalButton.addEventListener('click', () => dom.appPreviewModal.classList.add('modal-hidden'));

    document.addEventListener('DOMContentLoaded', () => {
      const savedKey = localStorage.getItem('capyUniverseApiKey_gemini');
      if(savedKey) geminiApiKey = savedKey;
    });
  </script>
</body>
</html>

