<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CapyBússola — Decisões com Clareza</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="cu-style.css">
  <script src="cu-navigation.js" defer></script>

  <style>
    .step { opacity:.6; } .step.active { opacity:1; font-weight: 600; color: var(--cu-cyan); }
    .badge { font-size:.72rem; padding:.15rem .45rem; border-radius:.5rem; border:1px solid #ffffff26; }
    .risk-0 { background: #10b98133; border-color: #10b98166;} /* green */
    .risk-1 { background: #f59e0b33; border-color: #f59e0b66;} /* amber */
    .risk-2 { background: #ef444433; border-color: #ef444466;} /* red */
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <header class="cu-header">
    <div class="cu-brand">
        <a href="index.html" class="flex items-center gap-2 group">
            <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png"></div>
            <span class="cu-appname text-lg sm:text-xl">CapyBússola</span>
        </a>
    </div>
    <div class="flex items-center gap-2">
        <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
    </div>
  </header>

  <div class="w-full max-w-5xl mx-auto px-4 pt-4">
      <div class="flex items-center justify-center gap-2 text-xs text-cu-text-dim overflow-x-auto">
        <div class="step active" data-step="1">1. Cenário</div><span>&bull;</span>
        <div class="step" data-step="2">2. Interpretações</div><span>&bull;</span>
        <div class="step" data-step="3">3. Pesos</div><span>&bull;</span>
        <div class="step" data-step="4">4. Opções</div><span>&bull;</span>
        <div class="step" data-step="5">5. Exportar</div>
      </div>
  </div>

  <main class="w-full max-w-5xl mx-auto px-4 py-4 space-y-4">
    <section id="step1" class="cu-panel p-4">
      <h2 class="font-bold text-lg mb-2">Descreva seu cenário</h2>
      <p class="text-sm text-cu-text-dim mb-3">Explique a decisão a ser tomada. A IA irá te guiar.</p>
      <textarea id="scenario" rows="6" class="cu-textarea" placeholder="Ex: Devo aceitar uma proposta de trabalho em outra cidade?"></textarea>
      <div class="mt-3"><button id="btnInterpret" class="cu-btn primary">Gerar Interpretações A/B</button></div>
    </section>

    <section id="step2" class="hidden cu-panel p-4">
      <h2 class="font-bold text-lg mb-2">Interpretações do seu cenário</h2>
      <div id="interpWrap" class="grid grid-cols-1 lg:grid-cols-2 gap-3"></div>
      <div class="mt-3"><button id="confirmInterp" disabled class="cu-btn">Confirmar interpretação</button></div>
    </section>

    <section id="step3" class="hidden cu-panel p-4">
      <h2 class="font-bold text-lg mb-2">Critérios e Restrições</h2>
      <div id="weightsWrap" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
      <div class="mt-3 flex items-center gap-3">
        <label class="flex items-center gap-2 text-sm"><input id="binaryToggle" type="checkbox" class="accent-cyan-400"> Decisão Sim/Não</label>
        <button id="btnGenerateOptions" class="ml-auto cu-btn primary">Gerar Opções</button>
      </div>
    </section>

    <section id="step4" class="hidden cu-panel p-4">
      <h2 class="font-bold text-lg mb-2">Opções e Consequências</h2>
      <div id="optionsWrap" class="grid grid-cols-1 lg:grid-cols-2 gap-3"></div>
      <div class="mt-4 flex justify-between items-center"><span class="text-xs">Histórico: <span id="pathCount">0</span></span><button id="goExport" class="cu-btn">Ir para Exportar</button></div>
    </section>

    <section id="step5" class="hidden cu-panel p-4">
      <h2 class="font-bold text-lg mb-2">Exportar Caminho de Decisão</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div class="cu-panel bg-transparent p-3">
          <h3 class="font-semibold mb-2">Mapa Mental</h3>
          <div id="mindmap" class="relative rounded-xl bg-white/5 min-h-[280px]"></div>
          <div class="mt-3 flex gap-2"><button id="btnDownloadMapPNG" class="cu-btn">Baixar PNG</button></div>
        </div>
        <div class="cu-panel bg-transparent p-3">
          <h3 class="font-semibold mb-2">Resumo & Taglines</h3>
          <div id="summary" class="text-sm whitespace-pre-wrap"></div>
          <div class="mt-3 flex gap-2"><button id="btnExportSummaryPDF" class="cu-btn">Resumo PDF</button><button id="btnGenTaglines" class="cu-btn">Gerar Taglines</button></div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-xl cu-panel text-sm"></div>

  <script>
    const state = { provider: 'gemini', model: 'gemini-2.0-flash', apiKey: localStorage.getItem('capyUniverseApiKey_gemini') || '', scenario: '', interpretations: [], selectedInterp: null, criteria: {'Impacto financeiro':7, 'Tempo':6, 'Risco':5, 'Bem-estar':8}, isBinary: false, options: [], decisionPath: [] };
    const $ = sel => document.querySelector(sel), $$ = sel => Array.from(document.querySelectorAll(sel));
    const toast = msg => { const t=$('#toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2400); };
    const setStep = n => { $$('.step').forEach(el=>el.classList.remove('active')); $(`.step[data-step="${n}"]`).classList.add('active'); $$('main > section').forEach((s,i)=>s.classList.toggle('hidden', i !== n-1)); };

    async function callLLM_JSON(prompt) {
        if (!state.apiKey) { toast('Configure sua chave de API.'); throw new Error('Sem chave'); }
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${state.model}:generateContent?key=${state.apiKey}`;
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: 'application/json' } }) });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        return JSON.parse(data.candidates[0].content.parts[0].text);
    }

    const promptInterpretations = s => `Gere DUAS interpretações (A e B) do cenário: "${s}", com summary, assumptions, critical_questions, e editable_text. Responda em JSON: {"interpretations":[{"id":"A",...},{"id":"B",...}]}`;
    const promptOptions = ({scenario, interp, criteria, isBinary}) => `Cenário: ${scenario}. Interpretação: ${interp}. Pesos: ${JSON.stringify(criteria)}. Binária? ${isBinary}. Gere opções de decisão (melhor, sensata, sim/não) com rationale, scores, consequências, mitigações e gatilhos. JSON: {"options":[{...}]}`;
    const promptEvolve = ({chosen}) => `Evolua a opção: ${JSON.stringify(chosen)}. Gere 1 nova opção superior. JSON: {"options":[{...}]}`;

    function drawWeights() {
        const wrap = $('#weightsWrap'); wrap.innerHTML = '';
        Object.entries(state.criteria).forEach(([k,v])=>{
            const row = document.createElement('div'); row.className = 'cu-panel bg-transparent p-3';
            row.innerHTML = `<div class="flex justify-between"><label>${k}</label><span id="val_${k}">${v}</span></div><input type="range" min="0" max="10" value="${v}" class="w-full mt-2" id="rng_${k}"/>`;
            wrap.appendChild(row);
            row.querySelector(`#rng_${k}`).oninput = e => { state.criteria[k]=+e.target.value; $(`#val_${k}`).textContent=e.target.value; };
        });
    }

    function drawInterpretations(data) {
        state.interpretations = data.interpretations || [];
        const wrap = $('#interpWrap'); wrap.innerHTML = '';
        state.interpretations.forEach(interp => {
            const card = document.createElement('div'); card.className = 'cu-panel bg-transparent p-3';
            card.innerHTML = `<div class="flex justify-between"><div class="font-semibold">${interp.id}</div><input type="radio" name="interpPick" value="${interp.id}"></div><p class="text-sm mt-2">${interp.summary}</p><textarea class="mt-3 w-full cu-textarea text-sm">${interp.editable_text}</textarea>`;
            wrap.appendChild(card);
        });
        $$('input[name="interpPick"]').forEach(r => r.onchange = () => $('#confirmInterp').disabled = false);
    }

    function drawOptions() {
        const wrap = $('#optionsWrap'); wrap.innerHTML = '';
        state.options.forEach((opt, idx)=>{
            const card = document.createElement('div'); card.className = `cu-panel bg-transparent p-3`;
            card.innerHTML = `<div class="flex justify-between items-center"><span class="font-bold">${opt.label}</span><div class="flex gap-2"><button data-idx="${idx}" class="btnChoose cu-btn text-xs">Escolher</button><button data-idx="${idx}" class="btnEvolve cu-btn text-xs">Evoluir</button></div></div><p class="text-sm mt-2">${opt.rationale}</p>`;
            wrap.appendChild(card);
        });
        $$('.btnChoose').forEach(b => b.onclick = async e => { const chosen = state.options[+e.target.dataset.idx]; state.decisionPath.push(chosen); $('#pathCount').textContent = state.decisionPath.length; toast(`Escolhido: ${chosen.label}`); try { const data = await callLLM_JSON(promptEvolve({chosen})); if(data?.options?.length) { state.options.push(data.options[0]); drawOptions(); } } catch(err) { toast('Falha ao evoluir.'); } });
        $$('.btnEvolve').forEach(b => b.onclick = async e => { const chosen = state.options[+e.target.dataset.idx]; try { const data = await callLLM_JSON(promptEvolve({chosen})); if(data?.options?.length) { state.options.splice(+e.target.dataset.idx + 1, 0, data.options[0]); drawOptions(); } } catch(err) { toast('Falha ao evoluir.'); } });
    }

    $('#btnInterpret').onclick = async () => { try { state.scenario = $('#scenario').value.trim(); if(!state.scenario) return; setStep(2); $('#interpWrap').innerHTML = 'Gerando...'; const data = await callLLM_JSON(promptInterpretations(state.scenario)); drawInterpretations(data); } catch(err) { toast('Falha ao gerar.'); } };
    $('#confirmInterp').onclick = () => { const pick = $$('input[name="interpPick"]').find(r=>r.checked)?.value; if(!pick) return; const card = $$('#interpWrap > div')[pick==='A'?0:1]; state.selectedInterp = { ...state.interpretations.find(i=>i.id===pick), editable_text: card.querySelector('textarea').value }; setStep(3); drawWeights(); };
    $('#binaryToggle').onchange = e => state.isBinary = e.target.checked;
    $('#btnGenerateOptions').onclick = async () => { try { setStep(4); $('#optionsWrap').innerHTML = 'Gerando...'; const data = await callLLM_JSON(promptOptions({ scenario: state.scenario, interp: state.selectedInterp.editable_text, criteria: state.criteria, isBinary: state.isBinary })); state.options = data?.options||[]; drawOptions(); } catch(err) { toast('Falha ao gerar.'); } };
    $('#goExport').onclick = () => setStep(5);

    document.addEventListener('DOMContentLoaded', () => setStep(1));
  </script>
</body>
</html>

