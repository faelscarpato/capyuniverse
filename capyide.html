<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CapyIDE Dinâmico com Sidebar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Syne:wght@700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" type="image/png">
  <link rel="stylesheet" href="tool-styles.css">

</head>
<body class="min-h-screen flex flex-col text-[15px]">
    <header class="global-header w-full fixed top-0 left-0 right-0 z-40 py-1">
        <div class="max-w-7xl mx-auto flex items-center justify-between px-4 h-[64px]">
            <div class="flex items-center">
                <button id="sidebarToggleBtn" class="lg:hidden mr-3 p-2 rounded-md text-gray-300 hover:bg-zinc-700 focus:outline-none">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <a href="index.html" class="text-xl sm:text-2xl font-bold text-gray-100 hover:text-purple-400 transition-colors font-syne">CapyUniverse IA</a>
                <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyIDE</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs text-zinc-400">API Gemini:</span>
                <div id="apiStatus" class="api-status-indicator api-status-unset" title="API Key Não Configurada"></div>
                <button id="openApi" class="text-zinc-400 hover:text-fuchsia-400" title="Configurar API"><i class="fas fa-key"></i></button>
            </div>
        </div>
    </header>

    <div id="notificationArea"></div>

    <div class="flex flex-1 pt-16"> 
        <aside id="sidebar" class="sidebar-glass text-gray-300 w-64 space-y-1 p-3 fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 lg:static lg:inset-0 transition-transform duration-300 ease-in-out z-30 shadow-lg overflow-y-auto pt-4 scrollbar-thin">
            <p class="text-xs text-center text-zinc-500 p-2">Carregando menu...</p>
        </aside>
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>

    <!-- Conteúdo Principal do CapyIDE -->
    <main class="flex-grow max-w-7xl mx-auto w-full pt-8 pb-8 px-2 sm:px-4 grid grid-cols-1 md:grid-cols-3 gap-8">
        <section class="md:col-span-1 flex flex-col gap-6">
          <div class="glass shadow-glass border-zinc-800 px-5 pt-5 pb-3 mb-0 flex flex-col min-h-[370px] max-h-[500px]">
            <div class="flex justify-between items-center mb-2">
              <h2 class="text-base font-bold text-zinc-200">Chat Interativo</h2>
              <button id="clearChatBtn" class="btn-link-style" style="font-size:0.96rem;">Limpar</button>
            </div>
            <div id="chatMessages" class="flex-grow overflow-y-auto scrollbar-thin font-jetbrains text-[0.95rem] min-h-[200px] max-h-[250px] px-1"></div>
            <div id="chatStatus" class="text-xs text-zinc-500 font-jetbrains mt-2">Pronto.</div>
            <textarea id="promptInput" placeholder="Descreva o que você quer criar..." class="mt-4 w-full bg-zinc-900/70 border border-zinc-700 text-zinc-100 font-jetbrains rounded-lg px-3 py-2 resize-none min-h-[100px] mb-3 outline-none focus:ring-2 focus:ring-purple-700 scrollbar-thin"></textarea>
            <div class="flex gap-2 mb-2">
              <button id="suggestPromptBtn" class="btn-link-style">Sugerir</button>
              <button id="improvePromptBtn" class="btn-link-style">Melhorar</button>
            </div>
            <button id="generateCodeBtn" class="btn-main">
                <span class="btn-text">Gerar Código com IA</span>
                <div class="loader hidden"></div>
            </button>
          </div>
        </section>
        
        <section class="md:col-span-2 glass shadow-glass border-zinc-800 p-6 flex flex-col">
          <div class="flex items-center border-b border-zinc-700 mb-2">
            <button id="tabBtnCode" class="tab-btn active">Código</button>
            <button id="tabBtnPreview" class="tab-btn">Preview</button>
            <button id="previewNewWindowBtn" class="ml-auto tab-btn !border-b-0 text-xs" style="padding: 0 12px;" title="Abrir preview em nova janela"><i class="fas fa-external-link-alt mr-1"></i>Nova Janela</button>
          </div>
          <div id="tabContentCode" class="flex-grow flex flex-col pt-2">
            <div id="editor-wrapper" class="flex-grow flex flex-col bg-zinc-900/70 rounded-lg border border-zinc-700">
              <div class="flex justify-between items-center p-2 border-b border-zinc-700 flex-wrap gap-2">
                <div class="flex items-center gap-2 flex-wrap">
                  <button id="modernizeProjectBtn" class="editor-action-btn"><i class="fas fa-code"></i> ModernIA</button>
                  <button id="explainCodeBtn" class="editor-action-btn"><i class="far fa-comment-dots"></i> Explicar</button>
                  <button id="generateDocsBtn" class="editor-action-btn"><i class="fas fa-clipboard-list"></i> Doc</button>
                  <button id="generateTestsBtn" class="editor-action-btn"><i class="fas fa-check-square"></i> Teste</button>
                </div>
                <div class="flex items-center gap-2">
                  <button id="copyCodeBtn" title="Copiar código" class="text-zinc-400 hover:text-white"><i class="fas fa-copy"></i></button>
                  <button id="downloadEditorBtn" title="Download HTML" class="text-zinc-400 hover:text-white"><i class="fas fa-download"></i></button>
                  <button id="fullscreenBtn" title="Tela cheia editor" class="text-zinc-400 hover:text-white"><i class="fas fa-expand"></i></button>
                </div>
              </div>
              <textarea id="code-editor" class="flex-grow bg-transparent font-jetbrains text-sm p-3 outline-none border-0 resize-none min-h-[400px] scrollbar-thin" placeholder="Seu código aparecerá aqui..."></textarea>
            </div>
          </div>
          <div id="tabContentPreview" class="hidden flex-grow flex flex-col pt-2">
            <div class="flex-grow bg-white rounded-lg overflow-hidden border border-zinc-700">
              <iframe id="previewFrame" class="w-full h-full border-none" style="min-height:450px;"></iframe>
            </div>
            <p id="editorStatus" class="text-xs text-zinc-500 font-jetbrains text-center pt-2">Preview do código do editor.</p>
          </div>
        </section>
    </main>
  </div>

  <div id="apiModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="glass border-zinc-800 p-6 rounded-2xl w-full max-w-md">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-lg font-bold text-purple-400 font-syne">Google Gemini API Key</h2>
            <button id="closeApi" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <label class="block text-xs text-zinc-300 mb-1">API Key</label>
        <div class="flex">
            <input id="apiKey" type="password" class="font-jetbrains p-2 text-xs flex-grow rounded-l-md focus:ring-1 focus:ring-sky-500 outline-none bg-zinc-800 text-white border border-zinc-700" placeholder="Cole sua API Key"/>
            <button id="saveApi" class="bg-sky-500 hover:bg-sky-600 px-3 py-2 rounded-r-md text-xs text-white">Salvar</button>
        </div>
        <p class="text-xs text-zinc-400 mt-2">Usada para gerar conteúdo.</p>
    </div>
  </div>


<script>
    const currentPageId = 'CapyIDE'; // ID desta ferramenta
    let geminiApiKeyGlobal = ''; // Para a chave global, se usada
    let geminiApiKeyLocal = ''; // Para a chave local do CapyIDE
    const API_KEY_STORAGE_KEY_GLOBAL = 'capyUniverseApiKey_gemini';
    const API_KEY_STORAGE_KEY_LOCAL_IDE = 'capyide_geminiApiKey_v1'; // Chave específica para CapyIDE
    let chatHistory = [];

    // Unified DOM selectors object
    const domSelectors = {
      sidebar: document.getElementById('sidebar'),
      sidebarToggleBtn: document.getElementById('sidebarToggleBtn'),
      sidebarOverlay: document.getElementById('sidebarOverlay'),
      apiKeysModalGlobal: document.getElementById('apiKeysModalGlobal'),
      openApiKeysModalGlobal: document.getElementById('openApiKeysModalGlobal'),
      closeApiKeysModalGlobal: document.getElementById('closeApiKeysModalButtonGlobal'),
      geminiApiKeyInputGlobal: document.getElementById('geminiApiKeyInputModalGlobal'),
      saveGeminiKeyGlobal: document.getElementById('saveGeminiKeyGlobal'),
      
      // CapyIDE specific elements
      apiKeyModalLocal: document.getElementById('apiKeyModalLocal'),
      showApiKeyModalLocal: document.querySelector('header .flex.items-center.gap-2 button[title="Configurar API Key"]'),
      closeApiKeyModalLocal: document.getElementById('closeApiKeyModalBtnLocal'),
      apiKeyInputModalLocal: document.getElementById('apiKeyInputModalLocalValue'),
      saveApiKeyBtnModalLocal: document.getElementById('saveApiKeyBtnModalLocal'),
      apiStatusIndicator: document.getElementById('apiStatusIndicator'),
      chatMessages: document.getElementById('chatMessages'),
      chatStatus: document.getElementById('chatStatus'),
      clearChatBtn: document.getElementById('clearChatBtn'),
      promptInput: document.getElementById('promptInput'),
      suggestPromptBtn: document.getElementById('suggestPromptBtn'),
      improvePromptBtn: document.getElementById('improvePromptBtn'), 
      generateCodeBtn: document.getElementById('generateCodeBtn'),
      tabBtnCode: document.getElementById('tabBtnCode'),
      tabBtnPreview: document.getElementById('tabBtnPreview'),
      tabContentCode: document.getElementById('tabContentCode'),
      tabContentPreview: document.getElementById('tabContentPreview'),
      editorWrapper: document.getElementById('editor-wrapper'), 
      codeEditor: document.getElementById('code-editor'),
      modernizeProjectBtn: document.getElementById('modernizeProjectBtn'),
      explainCodeBtn: document.getElementById('explainCodeBtn'), 
      generateDocsBtn: document.getElementById('generateDocsBtn'),
      generateTestsBtn: document.getElementById('generateTestsBtn'),
      copyCodeBtn: document.getElementById('copyCodeBtn'),
      downloadEditorBtn: document.getElementById('downloadEditorBtn'),
      fullscreenBtn: document.getElementById('fullscreenBtn'),
      previewFrame: document.getElementById('previewFrame'),
      editorStatus: document.getElementById('editorStatus'), 
      previewNewWindowBtn: document.getElementById('previewNewWindowBtn'), 
    };

    function updateApiStatusIndicator(status = 'unset', isLocal = true) {
        const indicator = isLocal ? domSelectors.apiStatusIndicator : null; // Adicionar um indicador global se necessário
        if (!indicator) return;
        indicator.classList.remove('api-status-ok', 'api-status-unset', 'api-status-error');
        switch (status) {
            case 'ok': indicator.classList.add('api-status-ok'); indicator.title = "API Key Configurada"; break;
            case 'error': indicator.classList.add('api-status-error'); indicator.title = "Erro na API Key"; break;
            default: indicator.classList.add('api-status-unset'); indicator.title = "API Key Não Configurada";
        }
    }

    function openApiKeyModalLocal() {
        if (domSelectors.apiKeyInputModalLocal) domSelectors.apiKeyInputModalLocal.value = localStorage.getItem(API_KEY_STORAGE_KEY_LOCAL_IDE) || '';
        if (domSelectors.apiKeyModalLocal) domSelectors.apiKeyModalLocal.classList.remove('hidden');
    }
    function closeApiKeyModalLocal() {
        if (domSelectors.apiKeyModalLocal) domSelectors.apiKeyModalLocal.classList.add('hidden');
    }
    function saveApiKeyLocal() {
      const key = domSelectors.apiKeyInputModalLocal.value.trim(); 
      if (!key) { 
        addMessageToChat("CapyIDE", "Por favor, insira sua API Key do Gemini.", true); 
        return; 
      }
      localStorage.setItem(API_KEY_STORAGE_KEY_LOCAL_IDE, key);
      geminiApiKeyLocal = key;
      updateApiStatusIndicator('ok', true);
      addMessageToChat("CapyIDE", "API Key do Gemini (local) salva!");
      closeApiKeyModalLocal(); 
    }
    function loadApiKeyLocal() {
      const savedKey = localStorage.getItem(API_KEY_STORAGE_KEY_LOCAL_IDE);
      if (savedKey) {
        geminiApiKeyLocal = savedKey;
        updateApiStatusIndicator('ok', true);
        addMessageToChat("CapyIDE", "API Key (local) carregada.");
      } else {
        updateApiStatusIndicator('unset', true);
        addMessageToChat("CapyIDE", "Nenhuma API Key local encontrada. Configure-a no ícone de chave no header do CapyIDE.");
        // openApiKeyModalLocal(); // Opcional: abrir automaticamente se não houver chave
      }
    }
    
    // Funções do CapyIDE (addMessageToChat, clearChat, etc. - mantidas do teu código original)
    function addMessageToChat(role, text, isError = false) {
      const msgDiv = document.createElement("div");
      const icon = role === "user" ? "👤" : (isError ? "⚠️" : "🐿️");
      const senderPrefix = role === "user" ? "Você" : (isError ? "CapyIDE (Erro)" : "CapyIDE");
      
      let bubbleClasses = "chat-bubble";
      if (isError) {
        bubbleClasses += " error";
      } else if (role === "user") {
        bubbleClasses += " user";
      }
      msgDiv.className = bubbleClasses;
      msgDiv.innerHTML = `<strong class="font-semibold">${icon} ${senderPrefix}:</strong><div class="mt-1">${text.replace(/\n/g, '<br>')}</div>`;
      
      domSelectors.chatMessages.appendChild(msgDiv);
      domSelectors.chatMessages.scrollTop = domSelectors.chatMessages.scrollHeight;
      domSelectors.chatStatus.textContent = isError ? `Erro: ${text.substring(0,50)}...` : `${senderPrefix}: ${text.substring(0,30)}...`;

      if (role !== 'user' && !isError) { 
          chatHistory.push({ role: "model", parts: [{ text: text }] });
      }
    }
    

function clearChat() {
        domSelectors.chatMessages.innerHTML = '';
        chatHistory = [];
        addMessageToChat("CapyIDE", "Conversa limpa. Pronto para um novo prompt!");
        domSelectors.chatStatus.textContent = "Conversa limpa.";
    }
    function typeTextToEditor(targetTextArea, text, speed = 10, callback) {
      targetTextArea.value = '';
      let i = 0;
      domSelectors.editorStatus.textContent = "Recebendo dados da IA...";
      const interval = setInterval(() => {
        if (i < text.length) {
          targetTextArea.value += text[i];
          targetTextArea.scrollTop = targetTextArea.scrollHeight;
           if (i % 50 === 0 || i === text.length -1) {
             domSelectors.editorStatus.textContent = `Processando... ${Math.round(((i+1)/text.length)*100)}%`;
          }
          i++;
        } else {
          clearInterval(interval);
          domSelectors.editorStatus.textContent = "Concluído!";
          if (callback) callback();
        }
      }, speed);
    }

    async function callGeminiAPI(promptText, buttonElement, processingMessage, isChatContext = false) {
        const apiKeyToUse = geminiApiKeyLocal || geminiApiKeyGlobal; // Prioriza a local
        if (!apiKeyToUse) {
             addMessageToChat("CapyIDE", "API Key do Gemini não configurada. Por favor, configure-a.", true);
             if (domSelectors.showApiKeyModalLocal) domSelectors.showApiKeyModalLocal.click(); // Abre o modal local
             else if (domSelectors.openApiKeysModalGlobal) domSelectors.openApiKeysModalGlobal.click(); // Ou o global
            return null;
        }
        
        if (buttonElement) toggleButtonLoading(buttonElement, true, processingMessage);
        domSelectors.chatStatus.textContent = `${processingMessage}...`;
        if (isChatContext) chatHistory.push({ role: "user", parts: [{ text: promptText }] });
        
        const payload = { 
            contents: isChatContext ? chatHistory : [{ role: "user", parts: [{ text: promptText }] }], 
            generationConfig: { temperature: 0.5, topP: 0.9, topK: 40 } 
        };
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKeyToUse}`, {
                method: "POST", 
                headers: { "Content-Type": "application/json" }, 
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            if (!response.ok) {
                const errorMsg = data?.error?.message || response.statusText;
                updateApiStatusIndicator('error', !!geminiApiKeyLocal);
                throw new Error(`Erro HTTP ${response.status}: ${errorMsg}`);
            }
            
            const aiResponseText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!aiResponseText) {
                if (data?.candidates?.[0]?.finishReason === "SAFETY") throw new Error("A resposta foi bloqueada por segurança.");
                else if (data?.candidates?.[0]?.finishReason === "MAX_TOKENS") throw new Error("Resposta excedeu limite de tokens.");
                throw new Error("IA não retornou conteúdo.");
            }
            
            updateApiStatusIndicator('ok', !!geminiApiKeyLocal); 
            return aiResponseText.trim();
        } catch (err) {
            addMessageToChat('CapyIDE', `Falha na API: ${err.message}`, true);
            updateApiStatusIndicator('error', !!geminiApiKeyLocal);
            if (isChatContext && chatHistory.length > 0 && chatHistory[chatHistory.length - 1].role === "user") chatHistory.pop();
            return null;
        } finally {
            if (buttonElement) toggleButtonLoading(buttonElement, false, buttonElement.querySelector('.btn-text') ? buttonElement.querySelector('.btn-text').textContent : 'Ação');
            domSelectors.chatStatus.textContent = "Pronto.";
        }
    }

    function cleanCodeResponse(rawCode) {
        let code = rawCode;
        if (code.startsWith("```html")) {
            code = code.substring(7).trim();
            if (code.endsWith("```")) code = code.slice(0, -3).trim();
        } else if (code.startsWith("```javascript")) {
            code = code.substring(11).trim();
            if (code.endsWith("```")) code = code.slice(0, -3).trim();
        } else if (code.startsWith("```")) {
            code = code.substring(3).trim();
            if (code.endsWith("```")) code = code.slice(0, -3).trim();
        }
        return code;
    }
    async function handleGenerateCode() {
      const userPrompt = domSelectors.promptInput.value.trim();
      if (!userPrompt) { 
        addMessageToChat("CapyIDE", "Por favor, descreva o código que você quer gerar.", true); 
        domSelectors.promptInput.focus();
        return; 
      }
      addMessageToChat("user", `Gerar código para: ${userPrompt}`);
      domSelectors.codeEditor.value = ""; 
      domSelectors.editorStatus.textContent = "Contactando IA para gerar código...";

      const generationSpecificPrompt = `Gere o código HTML completo com Tailwind CSS e JavaScript para o seguinte pedido: "${userPrompt}". Para todos os designs que eu pedir, que sejam bonitos, não padronizados. Crie páginas web com todos os recursos e dignas de produção. Por padrão, este modelo suporta HTML com classes CSS do Tailwind, JS , Json (caso necessário) todos em um único arquivo. Não instale outros pacotes para temas de interface, ícones, etc., a menos que seja absolutamente necessário ou que eu solicite. Use fotos de stock do Unsplash quando apropriado, apenas URLs válidos que você saiba que existem. Não baixe as imagens, apenas crie links para elas nas tags de imagem. Responda APENAS com o bloco de código HTML, sem explicações adicionais fora do código.`;

const aiResponseText = await callGeminiAPI(
    generationSpecificPrompt, 
    domSelectors.generateCodeBtn, 
    "Gerando Código"
);

if (aiResponseText) {
    const cleanHtmlCode = cleanCodeResponse(aiResponseText);
    typeTextToEditor(domSelectors.codeEditor, cleanHtmlCode, 5, () => { 
      addMessageToChat('CapyIDE', 'Código gerado e inserido no editor. Confira a aba "Preview".');
      switchToTab('preview'); 
      renderPreview();
    });
} else {
   domSelectors.editorStatus.textContent = "Falha ao gerar código.";
}
}

async function handleModernizeProject() {
        const currentCode = domSelectors.codeEditor.value.trim();
        if (!currentCode) {
            addMessageToChat("CapyIDE", "Não há código no editor para modernizar.", true);
            return;
        }
        addMessageToChat("user", "Modernizar o código do editor.");
        domSelectors.editorStatus.textContent = "Contactando IA para modernizar o código...";
        
        const modernizationPrompt = `Modernize e otimize o seguinte código HTML/CSS/JS, mantendo a funcionalidade e usando Tailwind CSS. Retorne APENAS o código HTML completo, sem explicações adicionais fora do código:\n\n\`\`\`html\n${currentCode}\n\`\`\``;

        const modernizedCode = await callGeminiAPI(
            modernizationPrompt,
            domSelectors.modernizeProjectBtn,
            "Modernizando"
        );

        if (modernizedCode) {
            const cleanHtmlCode = cleanCodeResponse(modernizedCode);
            typeTextToEditor(domSelectors.codeEditor, cleanHtmlCode, 5, () => {
                addMessageToChat('CapyIDE', 'Código modernizado e atualizado no editor.');
                switchToTab('preview');
                renderPreview();
            });
        } else {
            domSelectors.editorStatus.textContent = "Falha ao modernizar o código.";
        }
    }


    async function handleExplainCode() {
        const currentCode = domSelectors.codeEditor.value.trim();
        if (!currentCode) {
            addMessageToChat("CapyIDE", "Não há código no editor para explicar.", true);
            return;
        }
        const userMessage = "Por favor, explique o código que está no editor.";
        addMessageToChat("user", userMessage); 
        domSelectors.chatStatus.textContent = "Contactando IA para explicar o código...";
        
        const explanationPrompt = `Explique o seguinte código HTML/CSS/JS em português, de forma didática e detalhada, focando em suas partes principais e como interagem:\n\n\`\`\`html\n${currentCode}\n\`\`\`\n\nExplicação:`;
        
        const explanation = await callGeminiAPI(explanationPrompt, domSelectors.explainCodeBtn, "Explicando");

        if (explanation) {
            addMessageToChat("CapyIDE", `Explicação do código:\n${explanation}`);
        } else {
            addMessageToChat("CapyIDE", "Não foi possível obter a explicação do código.", true);
        }
    }
    

    async function handleSuggestPrompt() {
        addMessageToChat("user", "Me sugira um prompt criativo para um projeto web.");
        const suggestionInstruction = "Sugira um prompt criativo e detalhado para gerar um projeto de página web interessante usando HTML, Tailwind CSS e JavaScript. O prompt sugerido deve ser algo que eu possa usar diretamente no CapyIDE para gerar código.";
        
        const suggestedPrompt = await callGeminiAPI(suggestionInstruction, domSelectors.suggestPromptBtn, "Sugerindo");

        if (suggestedPrompt) {
            domSelectors.promptInput.value = suggestedPrompt;
            addMessageToChat("CapyIDE", `Sugestão de prompt:\n"${suggestedPrompt}"\n\nUse o botão "Gerar Código com IA" ou modifique-o como desejar.`);
        } else {
            addMessageToChat("CapyIDE", "Não foi possível obter uma sugestão de prompt no momento.", true);
        }
    }

    async function handleImprovePrompt() {
        const currentPrompt = domSelectors.promptInput.value.trim();
        if (!currentPrompt) {
            addMessageToChat("CapyIDE", "Digite um prompt primeiro para que eu possa melhorá-lo.", true);
            domSelectors.promptInput.focus();
            return;
        }
        addMessageToChat("user", `Melhorar o seguinte prompt: "${currentPrompt}"`);
        const improvementInstruction = `Melhore o seguinte prompt do usuário para que ele seja mais eficaz na geração de código HTML, Tailwind CSS e JavaScript. O prompt original é: "${currentPrompt}". O prompt melhorado deve ser claro, detalhado e focado no resultado desejado. Retorne APENAS o prompt melhorado.`;

        const improvedPrompt = await callGeminiAPI(improvementInstruction, domSelectors.improvePromptBtn, "Melhorando Prompt");
        
        if (improvedPrompt) {
            domSelectors.promptInput.value = improvedPrompt;
            addMessageToChat("CapyIDE", `Prompt melhorado:\n"${improvedPrompt}"\n\nAgora você pode usar este prompt para gerar o código.`);
        } else {
            addMessageToChat("CapyIDE", "Não foi possível melhorar o prompt no momento.", true);
        }
    }

    async function handleGenerateDocs() {
        const currentCode = domSelectors.codeEditor.value.trim();
        if (!currentCode) {
            addMessageToChat("CapyIDE", "Não há código no editor para gerar documentação.", true);
            return;
        }
        addMessageToChat("user", "Gerar documentação para o código do editor.");
        domSelectors.chatStatus.textContent = "Contactando IA para gerar documentação...";
        
        const docsPrompt = `Analise o seguinte código e gere uma documentação explicativa para ele. Se for JavaScript, descreva as funções e classes principais e seus parâmetros/retornos em formato de comentário ou JSDoc. Se for HTML/CSS, descreva a estrutura e os estilos principais através de comentários HTML. A documentação deve ser concisa e clara. Retorne a documentação como texto simples ou markdown.

Código:
\`\`\`
${currentCode}
\`\`\`
Documentação Sugerida:`;
        
        const documentation = await callGeminiAPI(docsPrompt, domSelectors.generateDocsBtn, "Gerando Doc.");

        if (documentation) {
            addMessageToChat("CapyIDE", `Documentação Gerada:\n\n${documentation}\n\n(Você pode copiar esta documentação e integrá-la ao seu código manualmente.)`);
        } else {
            addMessageToChat("CapyIDE", "Não foi possível gerar a documentação para o código.", true);
        }
    }

    async function handleGenerateTests() {
        const currentCode = domSelectors.codeEditor.value.trim();
        if (!currentCode) {
            addMessageToChat("CapyIDE", "Não há código no editor para gerar testes.", true);
            return;
        }
        addMessageToChat("user", "Gerar esqueleto de testes para o código do editor.");
        domSelectors.chatStatus.textContent = "Contactando IA para gerar testes...";
        
        const testsPrompt = `Analise o código JavaScript fornecido e gere um esqueleto de testes unitários usando um estilo similar ao Jest (ex: describe, it, expect). Foque nas funções principais. Se não for JavaScript, ou se não houver funções claras, tente descrever cenários de teste para a funcionalidade principal que o código HTML/CSS parece implementar. Retorne APENAS o código do esqueleto de teste ou os cenários de teste em formato de texto ou markdown.

Código:
\`\`\`
${currentCode}
\`\`\`
Esqueleto de Testes / Cenários de Teste:`;
        
        const testSkeletons = await callGeminiAPI(testsPrompt, domSelectors.generateTestsBtn, "Gerando Testes");

        if (testSkeletons) {
            const cleanedSkeletons = cleanCodeResponse(testSkeletons); // Reutiliza para remover markdown se houver
            addMessageToChat("CapyIDE", `Esqueleto de Testes Gerado:\n\n\`\`\`javascript\n${cleanedSkeletons}\n\`\`\`\n\n(Este é um esqueleto inicial. Adapte e complete os testes conforme necessário.)`);
        } else {
            addMessageToChat("CapyIDE", "Não foi possível gerar o esqueleto de testes para o código.", true);
        }
    }
    
    function renderPreview() {
        const fullHtmlContent = domSelectors.codeEditor.value;
        if (!fullHtmlContent.trim() && domSelectors.tabBtnPreview.classList.contains('active')) {
            domSelectors.previewFrame.srcdoc = "<div style='font-family: Inter, sans-serif; color: #555; display: flex; flex-direction:column; justify-content: center; align-items: center; height: 100%; padding: 20px; text-align:center;'>🐿️<p class='mt-2'>Editor vazio.</p><p>Gere ou cole código e clique na aba Preview para visualizar.</p></div>";
            return;
        }
        domSelectors.previewFrame.srcdoc = fullHtmlContent;
    }

    function switchToTab(tabName) {
        if (tabName === 'code') {
            domSelectors.tabContentCode.classList.remove('hidden');
            domSelectors.tabContentPreview.classList.add('hidden');
            domSelectors.tabBtnCode.classList.add('active');
            domSelectors.tabBtnPreview.classList.remove('active');
        } else if (tabName === 'preview') {
            domSelectors.tabContentCode.classList.add('hidden');
            domSelectors.tabContentPreview.classList.remove('hidden');
            domSelectors.tabBtnCode.classList.remove('active');
            domSelectors.tabBtnPreview.classList.add('active');
            renderPreview(); 
        }
    }

    function downloadFile(content, fileName, mimeType) {
      if (!content.trim()) {
        addMessageToChat("CapyIDE", "Nada para salvar. O editor está vazio.", true);
        return;
      }
      const blob = new Blob([content], { type: mimeType });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      document.body.appendChild(a); 
      a.click();
      document.body.removeChild(a); 
      URL.revokeObjectURL(a.href);
      addMessageToChat("CapyIDE", `Arquivo "${fileName}" preparado para download.`);
    }

    function copyCodeToClipboard() {
        const codeToCopy = domSelectors.codeEditor.value;
        if (!codeToCopy.trim()) {
            addMessageToChat("CapyIDE", "Nada para copiar. O editor está vazio.", true);
            return;
        }
        try {
            const textArea = document.createElement("textarea");
            textArea.value = codeToCopy;
            textArea.style.position = "fixed"; 
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            addMessageToChat("CapyIDE", "Código copiado para a área de transferência!");
        } catch (err) {
            console.error('Erro ao copiar com execCommand: ', err);
            addMessageToChat("CapyIDE", "Falha ao copiar o código. Tente manualmente.", true);
        }
    }

    function toggleEditorFullscreen() {
        const editorElem = domSelectors.editorWrapper; 
        if (!document.fullscreenElement) {
            if (editorElem.requestFullscreen) editorElem.requestFullscreen();
            else if (editorElem.mozRequestFullScreen) editorElem.mozRequestFullScreen(); 
            else if (editorElem.webkitRequestFullscreen) editorElem.webkitRequestFullscreen(); 
            else if (editorElem.msRequestFullscreen) editorElem.msRequestFullscreen(); 
            addMessageToChat("CapyIDE", "Editor em tela cheia. Pressione ESC para sair.");
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
            addMessageToChat("CapyIDE", "Editor saiu da tela cheia.");
        }
    }
    
    function openPreviewInNewWindow() {
        const code = domSelectors.codeEditor.value;
        if (!code.trim()) {
            addMessageToChat("CapyIDE", "Não há código no editor para abrir em nova janela.", true);
            return;
        }
        try {
            const newWindow = window.open("", "_blank");
            if (newWindow) {
                newWindow.document.open(); 
                newWindow.document.write(code);
                newWindow.document.close(); 
                addMessageToChat("CapyIDE", "Preview aberto em uma nova janela!");
            } else {
                addMessageToChat("CapyIDE", "Não foi possível abrir a nova janela. Verifique se o seu navegador bloqueou o pop-up.", true);
            }
        } catch (e) {
            addMessageToChat("CapyIDE", "Ocorreu um erro ao tentar abrir a nova janela.", true);
            console.error("Erro ao abrir nova janela: ", e);
        }
    }
    
    function toggleButtonLoading(buttonElement, isLoading, defaultText = "Ação") {
        const btnTextEl = buttonElement.querySelector('.btn-text');
        const loaderEl = buttonElement.querySelector('.loader');
        buttonElement.disabled = isLoading;
        if (isLoading) {
            if (btnTextEl) btnTextEl.classList.add('hidden');
            if (loaderEl) loaderEl.classList.remove('hidden');
        } else {
            if (btnTextEl) {
                 btnTextEl.classList.remove('hidden');
                 if(defaultText && btnTextEl.tagName.toLowerCase() !== 'i') btnTextEl.textContent = defaultText;
            }
            if (loaderEl) loaderEl.classList.add('hidden');
        }
    }


    async function renderGlobalSidebar() {
        if (!domSelectors.sidebar) return;
        try {
            const response = await fetch('tools.json'); 
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} ao tentar carregar tools.json`);
            }
            const toolsData = await response.json();
            
            const categories = {};
            toolsData.forEach(tool => {
                if (!categories[tool.category]) categories[tool.category] = [];
                categories[tool.category].push(tool);
            });
            domSelectors.sidebar.innerHTML = ''; 
            
            const homeLinkSidebar = document.createElement('a');
            homeLinkSidebar.href = 'index.html';
            homeLinkSidebar.className = `sidebar-link w-full flex items-center space-x-2.5 p-2.5 mb-2 rounded-md text-sm hover:bg-gray-700 transition-colors duration-150 text-gray-300`;
            homeLinkSidebar.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400 mr-2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> <span>Página Inicial</span>`;
            domSelectors.sidebar.appendChild(homeLinkSidebar);

            for (const categoryName in categories) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-1';
                const categoryButton = document.createElement('button');
                categoryButton.className = 'w-full flex justify-between items-center p-2.5 text-left text-gray-300 hover:bg-gray-700 rounded-md focus:outline-none transition-colors duration-150';
                categoryButton.innerHTML = `<span class="font-semibold text-sm">${categoryName}</span><svg class="w-4 h-4 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                const categoryContent = document.createElement('div');
                categoryContent.className = 'category-content pl-3 pt-0.5 space-y-0.5';
                
                categories[categoryName].forEach(tool => {
                    const link = document.createElement('a');
                    link.href = tool.pageUrl;
                    const sidebarIconHTML = tool.icon ? tool.icon.replace(/class="[^"]*"/g, `class="w-5 h-5 mr-2 text-${tool.color || 'gray-400'}"`) : '<span class="w-5 h-5 mr-2"></span>';
                    link.className = `sidebar-link w-full flex items-center space-x-2 py-1.5 px-2 rounded-md text-xs hover:bg-gray-600 hover:text-white transition-colors duration-150 ${tool.id === currentPageId ? 'active' : 'text-gray-400'}`;
                    link.innerHTML = sidebarIconHTML + `<span>${tool.title}</span>`;
                    categoryContent.appendChild(link);
                });

                categoryButton.addEventListener('click', () => {
                    categoryContent.classList.toggle('expanded');
                    categoryButton.querySelector('svg').classList.toggle('rotate-180');
                });
                
                // Expand category of current page
                if (categories[categoryName].some(tool => tool.id === currentPageId)) {
                    categoryContent.classList.add('expanded');
                    categoryButton.querySelector('svg').classList.add('rotate-180');
                }

                categoryDiv.appendChild(categoryButton);
                categoryDiv.appendChild(categoryContent);
                domSelectors.sidebar.appendChild(categoryDiv);
            }
        } catch (error) {
            console.error("Erro ao carregar ferramentas para a sidebar:", error);
            if(domSelectors.sidebar) domSelectors.sidebar.innerHTML = '<p class="text-xs text-red-500 p-2">Erro ao carregar menu. Verifique "tools.json".</p>';
        }
    }
    
    function loadApiKeyGlobal() {
        geminiApiKeyGlobal = localStorage.getItem(API_KEY_STORAGE_KEY_GLOBAL) || '';
        if(domSelectors.geminiApiKeyInputGlobal) domSelectors.geminiApiKeyInputGlobal.value = geminiApiKeyGlobal;
    }

    function initializeAppEventListeners() {
        // CapyIDE event listeners
        if(domSelectors.showApiKeyModalLocal) domSelectors.showApiKeyModalLocal.onclick = openApiKeyModalLocal;
        if(domSelectors.closeApiKeyModalLocal) domSelectors.closeApiKeyModalLocal.onclick = closeApiKeyModalLocal;
        if(domSelectors.saveApiKeyBtnModalLocal) domSelectors.saveApiKeyBtnModalLocal.onclick = saveApiKeyLocal; 
        if(domSelectors.clearChatBtn) domSelectors.clearChatBtn.onclick = clearChat;
        if(domSelectors.generateCodeBtn) domSelectors.generateCodeBtn.onclick = handleGenerateCode;
        if(domSelectors.suggestPromptBtn) domSelectors.suggestPromptBtn.onclick = handleSuggestPrompt;
        if(domSelectors.improvePromptBtn) domSelectors.improvePromptBtn.onclick = handleImprovePrompt; 
        if(domSelectors.tabBtnCode) domSelectors.tabBtnCode.onclick = () => switchToTab('code');
        if(domSelectors.tabBtnPreview) domSelectors.tabBtnPreview.onclick = () => switchToTab('preview');
        if(domSelectors.modernizeProjectBtn) domSelectors.modernizeProjectBtn.onclick = handleModernizeProject; 
        if(domSelectors.explainCodeBtn) domSelectors.explainCodeBtn.onclick = handleExplainCode; 
        if(domSelectors.generateDocsBtn) domSelectors.generateDocsBtn.onclick = handleGenerateDocs; 
        if(domSelectors.generateTestsBtn) domSelectors.generateTestsBtn.onclick = handleGenerateTests; 
        if(domSelectors.copyCodeBtn) domSelectors.copyCodeBtn.onclick = copyCodeToClipboard;
        if(domSelectors.downloadEditorBtn) domSelectors.downloadEditorBtn.onclick = () => downloadFile(domSelectors.codeEditor.value, "capyide-codigo.html", "text/html");
        if(domSelectors.fullscreenBtn) domSelectors.fullscreenBtn.onclick = toggleEditorFullscreen;
        if(domSelectors.previewNewWindowBtn) domSelectors.previewNewWindowBtn.onclick = openPreviewInNewWindow;
        if(domSelectors.promptInput) domSelectors.promptInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); 
                if (domSelectors.promptInput.value.trim()) handleGenerateCode(); 
            }
        });

        // Global sidebar and API modal events
        if(domSelectors.sidebarToggleBtn && domSelectors.sidebar && domSelectors.sidebarOverlay){
            domSelectors.sidebarToggleBtn.addEventListener('click', () => { 
                domSelectors.sidebar.classList.toggle('-translate-x-full'); 
                domSelectors.sidebarOverlay.classList.toggle('hidden'); 
            });
            if(domSelectors.sidebarOverlay) domSelectors.sidebarOverlay.addEventListener('click', () => { 
                domSelectors.sidebar.classList.add('-translate-x-full'); 
                domSelectors.sidebarOverlay.classList.add('hidden'); 
            });
        }
        
        if (domSelectors.openApiKeysModalGlobal && domSelectors.apiKeysModalGlobal) {
            domSelectors.openApiKeysModalGlobal.addEventListener('click', () => 
                domSelectors.apiKeysModalGlobal.classList.remove('hidden')
            );
        }
        
        if (domSelectors.closeApiKeysModalGlobal && domSelectors.apiKeysModalGlobal) {
            domSelectors.closeApiKeysModalGlobal.addEventListener('click', () => 
                domSelectors.apiKeysModalGlobal.classList.add('hidden')
            );
        }
        
        if (domSelectors.saveGeminiKeyGlobal && domSelectors.geminiApiKeyInputGlobal && domSelectors.apiKeysModalGlobal) {
            domSelectors.saveGeminiKeyGlobal.addEventListener('click', () => {
                const key = domSelectors.geminiApiKeyInputGlobal.value.trim();
                if(key) { 
                    localStorage.setItem(API_KEY_STORAGE_KEY_GLOBAL, key); 
                    geminiApiKeyGlobal = key; 
                    addMessageToChat("CapyIDE", "Chave API Global do Gemini salva!");
                    domSelectors.apiKeysModalGlobal.classList.add('hidden'); 
                } else { 
                    addMessageToChat("CapyIDE", "Por favor, insira uma chave API.", true);
                }
            });
        }
    }
    
    function initCapyIDE() {
      initializeAppEventListeners(); // Configura todos os event listeners
      loadApiKeyLocal(); // Carrega a chave API específica do CapyIDE
      loadApiKeyGlobal(); // Carrega a chave API global (pode ser usada como fallback)
      addMessageToChat("CapyIDE", "Bem-vindo ao CapyIDE! Configure a sua API Key local ou global e comece a criar.");
      switchToTab('code'); 
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderGlobalSidebar(); // Carrega a sidebar principal do CapyUniverse
        initCapyIDE(); // Inicializa as funcionalidades específicas do CapyIDE
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker registrado'))
        .catch(err => console.error('Erro no SW', err));
    }
  </script>
</body>
</html>
