<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CapyIDE Din√¢mico</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Syne:wght@700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#9333ea">
<link rel="icon" type="image/png" href="icons/icon-192.png">

  <style>
    html { background: #121217; }
    body {
      font-family: 'Inter', sans-serif;
     
      color: #e5e7eb;
 background-image: url('patter4.png');
  background-repeat: repeat;
   background-size: 300px; /* ajuste o tamanho se quiser mais ou menos zoom */
  background-color: #18181b; /* cor base escura para combinar */
    }
    /*.font-syne { font-family: 'Syne', sans-serif; }*/
    .font-jetbrains { font-family: 'JetBrains Mono', monospace; }
    .glass {
      background: rgba(0, 0, 0, 0.041);
      backdrop-filter: blur(6px);
      border-radius: 1.2rem;
      box-shadow: 0 4px 40px 0 rgba(0, 0, 0, 0.116);
      border: 1px solid rgba(63,63,70,0.28);
    }
    .shadow-glass { box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.137); }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #292932; border-radius: 60px; }
    .scrollbar-thin { scrollbar-width: thin; scrollbar-color: #4a4a4d #ffffff00;  }
    .chat-bubble {
      background: rgba(39,39,42,0.9);
      border: 1px solid #32323a;
      border-radius: 10px;
      padding: 8px 14px;
      margin-bottom: 8px;
      font-size: 14px;
      color: #d4d4d8;
      max-width: 90%;
      word-break: break-word;
    }
    .chat-bubble.user {
      background: linear-gradient(90deg, #ede13a 60%, #f6cd5c 100%);
      color: #fff;
      border: 1px solid #fadc8ba2;
      align-self: flex-end;
    }
    .chat-bubble.error {
      background: #e11d48; color: #fff;
      border: 1px solid #be123c;
    }
    .api-status-indicator { width: 10px; height: 10px; border-radius: 50%; margin-left:6px; margin-right:3px; }
    .api-status-ok { background: #22c55e; }
    .api-status-unset { background: #f59e0b; }
    .api-status-error { background: #ef4444; }
    .btn-main {
      background: linear-gradient(180deg, #00000098 0%, #6666664f 100%);
      border: 2px solid #ffffff3d; border-radius: 1.2rem;
      color: #ffffff; font-weight: 500; font-family: 'Syne', sans-serif;
      font-size: 15px;  padding: 5px 0;
      margin-top: 7px; box-shadow: 0 2px 20px 0 #00000042;
    }
    .btn-main:hover { background: linear-gradient(90deg, #ffffff33 0%, #ffffff05 100%); box-shadow: 0 2px 20px #1b1b1b90; color: #000; border: #000 solid 3px; }
    .btn-link-style {
      background: none; color: #ffffff; border: none;
      font-weight: 500; font-size: 0.93rem; cursor: pointer; padding: 0 6px;
    }
    .btn-link-style:hover { color: #a5b4fc; text-decoration: underline; }
    .tab-btn {
      background: none; border: none; color: #a1a1aa; font-weight: 600;
      padding: 10px 22px; border-bottom: 3px solid transparent; font-family: 'Syne',sans-serif;
      font-size: 1.09rem; letter-spacing: -1px; border-radius: 0; transition: color .17s, border .2s;
    }
    .tab-btn.active, .tab-btn:hover { color: #fff; border-bottom: 3px solid #ffffff; background: none; }
    .editor-action-btn {
      background: #00000038; border-radius: 0.7rem; color: #ffffff;
      border: 3px solid #ffffffbe;
      padding: 4px 10px; font-weight: 200; 
      margin-left: 6px; border: none; transition: background .15s, color .14s;
      font-size: 10px;
    }
    .editor-action-btn:hover { background: linear-gradient(180deg, #ffffff33 0%, #ffffff05 100%); color: #fff; }
    /* Footer */
    .footer-logo { height: 42px; width: 42px; object-fit: contain; display: inline-block; vertical-align: middle; }
    .footer-title { font-family: sans-serif; font-weight: 800; font-size: 1.15rem; letter-spacing: -1px; color: #fff; display: inline-block; }
    .footer-desc { color: #a1a1aa; font-size: 0.97rem; }
    .footer-link { color: #c7d2fe; margin: 0 10px; font-size: 0.93rem; }
    .footer-link:hover { color: #fff; text-decoration: underline; }
  </style>
</head>
<body class="dark min-h-screen flex flex-col text-[15px]">
  <!-- Header -->
  <header class="w-full fixed top-0 left-0 right-0 z-40 bg-zinc-950/90 backdrop-blur-lg border-b border-zinc-900 shadow-glass py-1 px-0">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 h-[64px]">
      <div class="flex items-center gap-3">
        <img src="icons/logo-capyide3.png" alt="Logo" class="h-8 w-8 footer-logo"/>
        <span class="font-syne text-2xl font-extrabold tracking-tight align-middle">CapyIDE</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs text-zinc-400 font-semibold">API Gemini:</span>
        <div id="apiStatusIndicator" class="api-status-indicator api-status-unset"></div>
        <button id="showApiKeyModalBtn" class="text-zinc-400 hover:text-fuchsia-400 transition-colors" title="Configurar API Key"><i class="fas fa-key"></i></button>
      </div>
    </div>
  </header>
  <main class="flex-grow max-w-7xl mx-auto pt-24 pb-8 px-2 sm:px-4 grid grid-cols-1 md:grid-cols-3 gap-8">
    <!-- Chat e Prompt -->
    <section class="md:col-span-1 flex flex-col gap-6">
      <div class="glass shadow-glass border-zinc-800 px-5 pt-5 pb-3 mb-0 flex flex-col min-h-[370px] max-h-[500px]">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-base font-bold text-zinc-200">Chat Interativo</h2>
          <button id="clearChatBtn" class="btn-link-style" style="font-size:0.96rem;">Limpar</button>
        </div>
        <div id="chatMessages" class="flex-grow overflow-y-auto scrollbar-thin font-jetbrains text-[0.95rem] min-h-[200px] max-h-[250px] px-1"></div>
        <div id="chatStatus" class="text-xs text-zinc-500 font-jetbrains mt-2">Pronto.</div>
      
      
        <textarea id="promptInput" placeholder="Descreva o que voc√™ quer criar, modernizar ou entender..." class="bg-zinc-900/70 border border-zinc-700 text-zinc-100 font-jetbrains rounded-lg px-3 py-2 resize-none min-h-[96px] mb-3 outline-none focus:ring-2 focus:ring-fuchsia-700"></textarea>
        <div class="flex gap-2 mb-2">
          <button id="suggestPromptBtn" class="btn-link-style">Sugerir</button>
          <button id="improvePromptBtn" class="btn-link-style">Melhorar</button>
        </div>
        <button id="generateCodeBtn" class="btn-main">Gerar C√≥digo com IA</button>
      </div>
    </section>
    <!-- Editor e Preview -->
    <section class="md:col-span-2 glass shadow-glass border-zinc-800 p-6 flex flex-col">
      <div class="flex items-center border-b border-zinc-700 mb-2">
        <button id="tabBtnCode" class="tab-btn active">C√≥digo</button>
        <button id="tabBtnPreview" class="tab-btn">Preview</button>
        <button id="previewNewWindowBtn" class="ml-auto tab-btn !border-b-0 text-xs" style="padding: 0 12px;" title="Abrir preview em nova janela"><i class="fas fa-external-link-alt mr-1"></i>Nova Janela</button>
      </div>
      <!-- Editor Code -->
      <div id="tabContentCode" class="flex-grow flex flex-col pt-2">
        <div id="editor-wrapper" class="flex-grow flex flex-col bg-zinc-900/70 rounded-lg border border-zinc-700">
          <div class="flex justify-between items-center p-2 border-b border-zinc-700">
            
            <div class="flex items-center">
              <button id="modernizeProjectBtn" class="editor-action-btn"><i class="fas fa-code"></i> ModernIA</button>
              <button id="explainCodeBtn" class="editor-action-btn"><i class="far fa-comment-dots"></i> Explicar</button>
              <button id="generateDocsBtn" class="editor-action-btn"><i class="fas fa-clipboard-list"></i> Doc</button>
              <button id="generateTestsBtn" class="editor-action-btn"><i class="fas fa-check-square"></i> Teste</button>
              <button id="copyCodeBtn" class="editor-action-btn ml-2" title="Copiar c√≥digo"><i class="fas fa-copy"></i>Copiar</button>
              <button id="downloadEditorBtn" class="editor-action-btn ml-1" title="Download HTML"><i class="fas fa-download"></i>Down</button>
              <button id="fullscreenBtn" class="editor-action-btn ml-1" title="Tela cheia editor"><i class="fas fa-expand"></i></button>
            </div>
          </div>
          <textarea id="code-editor" class="flex-grow bg-transparent font-jetbrains text-[0.97rem] px-2 py-2 outline-none border-0 resize-none min-h-[170px] max-h-[350px] scrollbar-thin" placeholder="Seu c√≥digo aparecer√° aqui..."></textarea>
        </div>
      </div>
      <!-- Preview -->
      <div id="tabContentPreview" class="hidden flex-grow flex flex-col pt-2">
        <div class="flex-grow bg-zinc-900/80 rounded-lg overflow-hidden border border-zinc-700">
          <iframe id="previewFrame" class="w-full h-full border-none" style="min-height:200px;"></iframe>
        </div>
        <p id="editorStatus" class="text-xs text-zinc-500 font-jetbrains text-center pt-2">Preview do c√≥digo do editor.</p>
      </div>
    </section>
  </main>
  <!-- Modal API Key -->
  <div id="apiKeyModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
    <div class="glass border border-zinc-800 p-7 rounded-2xl shadow-glass w-full max-w-md">
      <h2 class="text-lg font-bold mb-4 text-fuchsia-400">Configurar API Key do Gemini</h2>
      <input id="apiKeyInputModal" type="password" class="bg-zinc-900/70 border border-zinc-700 text-zinc-100 font-jetbrains rounded-lg px-4 py-3 mb-5 w-full outline-none focus:ring-2 focus:ring-fuchsia-700" placeholder="Cole sua API Key do Gemini aqui"/>
      <div class="flex justify-end gap-3">
        <button id="closeApiKeyModalBtn" type="button" class="editor-action-btn">Cancelar</button>
        <button id="saveApiKeyBtnModal" type="button" class="btn-main py-2 px-5 !rounded-lg">Salvar Chave</button>
      </div>
    </div>
  </div>
  <!-- Footer -->
  <footer class="w-full bg-zinc-950/95 border-t border-zinc-900 mt-3 pt-8 pb-7 px-4">
    <div class="max-w-2xl mx-auto flex flex-col items-center text-center">
      <div class="mb-2 flex flex-col items-center gap-2">
        <img src="icons/logo-capyide3.png" alt="Logo CapyIDE" class="footer-logo"/>
        <div class="footer-title">CapyIDE</div>
      </div>
      <div class="mb-2">
        <span class="font-bold text-yellow-400">CapyIDE Din√¢mico</span>: Seu ambiente para criar, modernizar e entender c√≥digos com IA generativa.<br>
        <span class="footer-desc">Design inspirado em Prompthancer, powered by Rafael Front Insano.</span>
      </div>
      <div class="flex gap-5 mb-1">
        <a href="#" class="footer-link">Features</a>
        <a href="#" class="footer-link">Sobre</a>
        <a href="#" class="footer-link">GitHub</a>
      </div>
      <div class="w-full border-t border-zinc-800 mt-5 pt-2">
        <span class="footer-desc">¬© 2025 CapyIDE | Todos os direitos reservados.</span>
      </div>
    </div>
  </footer>

  <script>
document.addEventListener("DOMContentLoaded", function() {
    const domSelectors = {
      apiKeyModal: document.getElementById('apiKeyModal'),
      showApiKeyModalBtn: document.getElementById('showApiKeyModalBtn'),
      closeApiKeyModalBtn: document.getElementById('closeApiKeyModalBtn'),
      apiKeyInputModal: document.getElementById('apiKeyInputModal'), 
      saveApiKeyBtnModal: document.getElementById('saveApiKeyBtnModal'), 
      apiStatusIndicator: document.getElementById('apiStatusIndicator'),
      chatMessages: document.getElementById('chatMessages'),
      chatStatus: document.getElementById('chatStatus'),
      clearChatBtn: document.getElementById('clearChatBtn'),
      promptInput: document.getElementById('promptInput'),
      suggestPromptBtn: document.getElementById('suggestPromptBtn'),
      improvePromptBtn: document.getElementById('improvePromptBtn'), 
      generateCodeBtn: document.getElementById('generateCodeBtn'),
      tabBtnCode: document.getElementById('tabBtnCode'),
      tabBtnPreview: document.getElementById('tabBtnPreview'),
      tabContentCode: document.getElementById('tabContentCode'),
      tabContentPreview: document.getElementById('tabContentPreview'),
      editorWrapper: document.getElementById('editor-wrapper'), 
      codeEditor: document.getElementById('code-editor'),
      modernizeProjectBtn: document.getElementById('modernizeProjectBtn'),
      explainCodeBtn: document.getElementById('explainCodeBtn'), 
      generateDocsBtn: document.getElementById('generateDocsBtn'), // Novo
      generateTestsBtn: document.getElementById('generateTestsBtn'), // Novo
      copyCodeBtn: document.getElementById('copyCodeBtn'),
      downloadEditorBtn: document.getElementById('downloadEditorBtn'),
      fullscreenBtn: document.getElementById('fullscreenBtn'),
      previewFrame: document.getElementById('previewFrame'),
      editorStatus: document.getElementById('editorStatus'), 
      previewNewWindowBtn: document.getElementById('previewNewWindowBtn'), 
    };

    const API_KEY_STORAGE_KEY = "capyide_geminiApiKey_v1";
    let currentApiKey = '';
    let chatHistory = [];

    function updateApiStatusIndicator(status = 'unset') {
        domSelectors.apiStatusIndicator.classList.remove('api-status-ok', 'api-status-unset', 'api-status-error');
        switch (status) {
            case 'ok':
                domSelectors.apiStatusIndicator.classList.add('api-status-ok');
                domSelectors.apiStatusIndicator.title = "API Key Configurada e V√°lida";
                break;
            case 'error':
                domSelectors.apiStatusIndicator.classList.add('api-status-error');
                domSelectors.apiStatusIndicator.title = "Erro na API Key ou Conex√£o";
                break;
            default: 
                domSelectors.apiStatusIndicator.classList.add('api-status-unset');
                domSelectors.apiStatusIndicator.title = "API Key N√£o Configurada";
        }
    }

    function openApiKeyModal() {
        domSelectors.apiKeyInputModal.value = localStorage.getItem(API_KEY_STORAGE_KEY) || '';
        domSelectors.apiKeyModal.classList.remove('hidden');
    }

    function closeApiKeyModal() {
        domSelectors.apiKeyModal.classList.add('hidden');
    }

    function addMessageToChat(role, text, isError = false) {
      const msgDiv = document.createElement("div");
      const icon = role === "user" ? "üë§" : (isError ? "‚ö†Ô∏è" : "üêøÔ∏è");
      const senderPrefix = role === "user" ? "Voc√™" : (isError ? "CapyIDE (Erro)" : "CapyIDE");
      
      let bubbleClasses = "chat-bubble";
      if (isError) {
        bubbleClasses += " bg-red-700/80 border border-red-500 text-red-100 self-start mr-auto";
      } else if (role === "user") {
        bubbleClasses += " bg-gray-900/20 border border-white text-white self-end ml-auto";
      } else { 
        bubbleClasses += " bg-black border border-gray-200 text-gray-500  self-start mr-auto";
      }
      msgDiv.className = bubbleClasses;
      msgDiv.innerHTML = `<strong class="font-semibold">${icon} ${senderPrefix}:</strong><div class="mt-1">${text.replace(/\n/g, '<br>')}</div>`;
      
      domSelectors.chatMessages.appendChild(msgDiv);
      domSelectors.chatMessages.scrollTop = domSelectors.chatMessages.scrollHeight;
      domSelectors.chatStatus.textContent = isError ? `Erro: ${text.substring(0,50)}...` : `${senderPrefix}: ${text.substring(0,30)}...`;

      if (role !== 'user' && !isError) { 
          chatHistory.push({ role: "model", parts: [{ text: text }] });
      }
    }
    
    function clearChat() {
        domSelectors.chatMessages.innerHTML = '';
        chatHistory = [];
        addMessageToChat("CapyIDE", "Conversa limpa. Pronto para um novo prompt!");
        domSelectors.chatStatus.textContent = "Conversa limpa.";
    }

    function typeTextToEditor(targetTextArea, text, speed = 10, callback) {
      targetTextArea.value = '';
      let i = 0;
      domSelectors.editorStatus.textContent = "Recebendo dados da IA...";
      const interval = setInterval(() => {
        if (i < text.length) {
          targetTextArea.value += text[i];
          targetTextArea.scrollTop = targetTextArea.scrollHeight;
           if (i % 50 === 0 || i === text.length -1) {
             domSelectors.editorStatus.textContent = `Processando... ${Math.round(((i+1)/text.length)*100)}%`;
          }
          i++;
        } else {
          clearInterval(interval);
          domSelectors.editorStatus.textContent = "Conclu√≠do!";
          if (callback) callback();
        }
      }, speed);
    }

    function saveApiKey() {
      const key = domSelectors.apiKeyInputModal.value.trim(); 
      if (!key) { 
        addMessageToChat("CapyIDE", "Por favor, insira sua API Key do Gemini.", true); 
        return; 
      }
      localStorage.setItem(API_KEY_STORAGE_KEY, key);
      currentApiKey = key;
      updateApiStatusIndicator('ok');
      addMessageToChat("CapyIDE", "API Key do Gemini salva localmente!");
      closeApiKeyModal(); 
    }

    function loadApiKey() {
      const savedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
      if (savedKey) {
        currentApiKey = savedKey;
        updateApiStatusIndicator('ok');
        addMessageToChat("CapyIDE", "API Key carregada do armazenamento local.");
      } else {
        updateApiStatusIndicator('unset');
        addMessageToChat("CapyIDE", "Nenhuma API Key encontrada. Por favor, configure-a no √≠cone de chave.");
        openApiKeyModal();
      }
    }

    async function callGeminiAPI(promptText, buttonElement, processingMessage, isChatContext = false) {
        if (!currentApiKey) {
            addMessageToChat("CapyIDE", "API Key n√£o configurada. Por favor, configure-a primeiro.", true);
            openApiKeyModal();
            return null;
        }

        const originalButtonHTML = buttonElement ? buttonElement.innerHTML : null;
        if (buttonElement) {
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" stroke-opacity="0.3"></circle><path d="M12 2a10 10 0 0 1 10 10" stroke-opacity="0.8"></path></svg> ${processingMessage}...`;
        }
        domSelectors.chatStatus.textContent = `${processingMessage}...`;

        if (isChatContext) {
            chatHistory.push({ role: "user", parts: [{ text: promptText }] });
        }
        
        const payload = {
            contents: isChatContext ? chatHistory : [{ role: "user", parts: [{ text: promptText }] }],
            generationConfig: { temperature: 0.5, topP: 0.9, topK: 40 } 
        };
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${currentApiKey}`, {
                method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
                updateApiStatusIndicator('error');
                throw new Error(`Erro HTTP ${response.status}: ${errorData.error?.message || 'Erro desconhecido da API.'}`);
            }
            const data = await response.json();

            if (data.error) { 
                updateApiStatusIndicator('error');
                throw new Error(`Erro da API Gemini: ${data.error.message}`);
            }
            
            const aiResponseText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!aiResponseText) {
                if (data?.candidates?.[0]?.finishReason === "SAFETY") {
                     throw new Error("A resposta foi bloqueada devido a configura√ß√µes de seguran√ßa.");
                } else if (data?.candidates?.[0]?.finishReason === "MAX_TOKENS") {
                    throw new Error("A resposta excedeu o limite m√°ximo de tokens.");
                }
                throw new Error("A IA n√£o retornou conte√∫do ou a resposta estava vazia.");
            }
            
            updateApiStatusIndicator('ok'); 
            return aiResponseText.trim();

        } catch (err) {
            console.error('Erro na chamada da API Gemini:', err);
            addMessageToChat('CapyIDE', `Falha na comunica√ß√£o com a API: ${err.message}`, true);
            updateApiStatusIndicator('error');
            if (isChatContext && chatHistory.length > 0 && chatHistory[chatHistory.length - 1].role === "user") {
                chatHistory.pop();
            }
            return null;
        } finally {
            if (buttonElement) {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalButtonHTML;
            }
            domSelectors.chatStatus.textContent = "Pronto.";
        }
    }
    
    function cleanCodeResponse(rawCode) {
        let code = rawCode;
        if (code.startsWith("```html")) {
            code = code.substring(7).trim();
            if (code.endsWith("```")) code = code.slice(0, -3).trim();
        } else if (code.startsWith("```javascript")) {
            code = code.substring(11).trim();
            if (code.endsWith("```")) code = code.slice(0, -3).trim();
        } else if (code.startsWith("```")) {
            code = code.substring(3).trim();
            if (code.endsWith("```")) code = code.slice(0, -3).trim();
        }
        return code;
    }

    async function handleGenerateCode() {
      const userPrompt = domSelectors.promptInput.value.trim();
      if (!userPrompt) { 
        addMessageToChat("CapyIDE", "Por favor, descreva o c√≥digo que voc√™ quer gerar.", true); 
        domSelectors.promptInput.focus();
        return; 
      }
      
      addMessageToChat("user", `Gerar c√≥digo para: ${userPrompt}`);
      domSelectors.codeEditor.value = ""; 
      domSelectors.editorStatus.textContent = "Contactando IA para gerar c√≥digo...";
      
      const generationSpecificPrompt = `Gere o c√≥digo HTML completo com Tailwind CSS e JavaScript para o seguinte pedido: "${userPrompt}". Para todos os designs que eu pedir, que sejam bonitos, n√£o padronizados. Crie p√°ginas web com todos os recursos e dignas de produ√ß√£o. Por padr√£o, este modelo suporta HTML com classes CSS do Tailwind, JS , Json (caso necess√°rio) todos em um √∫nico arquivo. N√£o instale outros pacotes para temas de interface, √≠cones, etc., a menos que seja absolutamente necess√°rio ou que eu solicite. Use fotos de stock do Unsplash quando apropriado, apenas URLs v√°lidos que voc√™ saiba que existem. N√£o baixe as imagens, apenas crie links para elas nas tags de imagem. Responda APENAS com o bloco de c√≥digo HTML, sem explica√ß√µes adicionais fora do c√≥digo.`;

      const aiResponseText = await callGeminiAPI(
          generationSpecificPrompt, 
          domSelectors.generateCodeBtn, 
          "Gerando C√≥digo"
      );

      if (aiResponseText) {
          const cleanHtmlCode = cleanCodeResponse(aiResponseText);
          typeTextToEditor(domSelectors.codeEditor, cleanHtmlCode, 5, () => { 
            addMessageToChat('CapyIDE', 'C√≥digo gerado e inserido no editor. Confira a aba "Preview".');
            switchToTab('preview'); 
            renderPreview();
          });
      } else {
         domSelectors.editorStatus.textContent = "Falha ao gerar c√≥digo.";
      }
    }

    async function handleModernizeProject() {
        const currentCode = domSelectors.codeEditor.value.trim();
        if (!currentCode) {
            addMessageToChat("CapyIDE", "N√£o h√° c√≥digo no editor para modernizar.", true);
            return;
        }
        addMessageToChat("user", "Modernizar o c√≥digo do editor.");
        domSelectors.editorStatus.textContent = "Contactando IA para modernizar o c√≥digo...";
        
        const modernizationPrompt = `Modernize e otimize o seguinte c√≥digo HTML/CSS/JS, mantendo a funcionalidade e usando Tailwind CSS. Retorne APENAS o c√≥digo HTML completo, sem explica√ß√µes adicionais fora do c√≥digo:\n\n\`\`\`html\n${currentCode}\n\`\`\``;

        const modernizedCode = await callGeminiAPI(
            modernizationPrompt,
            domSelectors.modernizeProjectBtn,
            "Modernizando"
        );

        if (modernizedCode) {
            const cleanHtmlCode = cleanCodeResponse(modernizedCode);
            typeTextToEditor(domSelectors.codeEditor, cleanHtmlCode, 5, () => {
                addMessageToChat('CapyIDE', 'C√≥digo modernizado e atualizado no editor.');
                switchToTab('preview');
                renderPreview();
            });
        } else {
            domSelectors.editorStatus.textContent = "Falha ao modernizar o c√≥digo.";
        }
    }

    async function handleExplainCode() {
        const currentCode = domSelectors.codeEditor.value.trim();
        if (!currentCode) {
            addMessageToChat("CapyIDE", "N√£o h√° c√≥digo no editor para explicar.", true);
            return;
        }
        const userMessage = "Por favor, explique o c√≥digo que est√° no editor.";
        addMessageToChat("user", userMessage); 
        domSelectors.chatStatus.textContent = "Contactando IA para explicar o c√≥digo...";
        
        const explanationPrompt = `Explique o seguinte c√≥digo HTML/CSS/JS em portugu√™s, de forma did√°tica e detalhada, focando em suas partes principais e como interagem:\n\n\`\`\`html\n${currentCode}\n\`\`\`\n\nExplica√ß√£o:`;
        
        const explanation = await callGeminiAPI(explanationPrompt, domSelectors.explainCodeBtn, "Explicando");

        if (explanation) {
            addMessageToChat("CapyIDE", `Explica√ß√£o do c√≥digo:\n${explanation}`);
        } else {
            addMessageToChat("CapyIDE", "N√£o foi poss√≠vel obter a explica√ß√£o do c√≥digo.", true);
        }
    }
    
    async function handleSuggestPrompt() {
        addMessageToChat("user", "Me sugira um prompt criativo para um projeto web.");
        const suggestionInstruction = "Sugira um prompt criativo e detalhado para gerar um projeto de p√°gina web interessante usando HTML, Tailwind CSS e JavaScript. O prompt sugerido deve ser algo que eu possa usar diretamente no CapyIDE para gerar c√≥digo.";
        
        const suggestedPrompt = await callGeminiAPI(suggestionInstruction, domSelectors.suggestPromptBtn, "Sugerindo");

        if (suggestedPrompt) {
            domSelectors.promptInput.value = suggestedPrompt;
            addMessageToChat("CapyIDE", `Sugest√£o de prompt:\n"${suggestedPrompt}"\n\nUse o bot√£o "Gerar C√≥digo com IA" ou modifique-o como desejar.`);
        } else {
            addMessageToChat("CapyIDE", "N√£o foi poss√≠vel obter uma sugest√£o de prompt no momento.", true);
        }
    }

    async function handleImprovePrompt() {
        const currentPrompt = domSelectors.promptInput.value.trim();
        if (!currentPrompt) {
            addMessageToChat("CapyIDE", "Digite um prompt primeiro para que eu possa melhor√°-lo.", true);
            domSelectors.promptInput.focus();
            return;
        }
        addMessageToChat("user", `Melhorar o seguinte prompt: "${currentPrompt}"`);
        const improvementInstruction = `Melhore o seguinte prompt do usu√°rio para que ele seja mais eficaz na gera√ß√£o de c√≥digo HTML, Tailwind CSS e JavaScript. O prompt original √©: "${currentPrompt}". O prompt melhorado deve ser claro, detalhado e focado no resultado desejado. Retorne APENAS o prompt melhorado.`;

        const improvedPrompt = await callGeminiAPI(improvementInstruction, domSelectors.improvePromptBtn, "Melhorando Prompt");
        
        if (improvedPrompt) {
            domSelectors.promptInput.value = improvedPrompt;
            addMessageToChat("CapyIDE", `Prompt melhorado:\n"${improvedPrompt}"\n\nAgora voc√™ pode usar este prompt para gerar o c√≥digo.`);
        } else {
            addMessageToChat("CapyIDE", "N√£o foi poss√≠vel melhorar o prompt no momento.", true);
        }
    }

    async function handleGenerateDocs() {
        const currentCode = domSelectors.codeEditor.value.trim();
        if (!currentCode) {
            addMessageToChat("CapyIDE", "N√£o h√° c√≥digo no editor para gerar documenta√ß√£o.", true);
            return;
        }
        addMessageToChat("user", "Gerar documenta√ß√£o para o c√≥digo do editor.");
        domSelectors.chatStatus.textContent = "Contactando IA para gerar documenta√ß√£o...";
        
        const docsPrompt = `Analise o seguinte c√≥digo e gere uma documenta√ß√£o explicativa para ele. Se for JavaScript, descreva as fun√ß√µes e classes principais e seus par√¢metros/retornos em formato de coment√°rio ou JSDoc. Se for HTML/CSS, descreva a estrutura e os estilos principais atrav√©s de coment√°rios HTML. A documenta√ß√£o deve ser concisa e clara. Retorne a documenta√ß√£o como texto simples ou markdown.

C√≥digo:
\`\`\`
${currentCode}
\`\`\`
Documenta√ß√£o Sugerida:`;
        
        const documentation = await callGeminiAPI(docsPrompt, domSelectors.generateDocsBtn, "Gerando Doc.");

        if (documentation) {
            addMessageToChat("CapyIDE", `Documenta√ß√£o Gerada:\n\n${documentation}\n\n(Voc√™ pode copiar esta documenta√ß√£o e integr√°-la ao seu c√≥digo manualmente.)`);
        } else {
            addMessageToChat("CapyIDE", "N√£o foi poss√≠vel gerar a documenta√ß√£o para o c√≥digo.", true);
        }
    }

    async function handleGenerateTests() {
        const currentCode = domSelectors.codeEditor.value.trim();
        if (!currentCode) {
            addMessageToChat("CapyIDE", "N√£o h√° c√≥digo no editor para gerar testes.", true);
            return;
        }
        addMessageToChat("user", "Gerar esqueleto de testes para o c√≥digo do editor.");
        domSelectors.chatStatus.textContent = "Contactando IA para gerar testes...";
        
        const testsPrompt = `Analise o c√≥digo JavaScript fornecido e gere um esqueleto de testes unit√°rios usando um estilo similar ao Jest (ex: describe, it, expect). Foque nas fun√ß√µes principais. Se n√£o for JavaScript, ou se n√£o houver fun√ß√µes claras, tente descrever cen√°rios de teste para a funcionalidade principal que o c√≥digo HTML/CSS parece implementar. Retorne APENAS o c√≥digo do esqueleto de teste ou os cen√°rios de teste em formato de texto ou markdown.

C√≥digo:
\`\`\`
${currentCode}
\`\`\`
Esqueleto de Testes / Cen√°rios de Teste:`;
        
        const testSkeletons = await callGeminiAPI(testsPrompt, domSelectors.generateTestsBtn, "Gerando Testes");

        if (testSkeletons) {
            const cleanedSkeletons = cleanCodeResponse(testSkeletons); // Reutiliza para remover markdown se houver
            addMessageToChat("CapyIDE", `Esqueleto de Testes Gerado:\n\n\`\`\`javascript\n${cleanedSkeletons}\n\`\`\`\n\n(Este √© um esqueleto inicial. Adapte e complete os testes conforme necess√°rio.)`);
        } else {
            addMessageToChat("CapyIDE", "N√£o foi poss√≠vel gerar o esqueleto de testes para o c√≥digo.", true);
        }
    }
    
    function renderPreview() {
        const fullHtmlContent = domSelectors.codeEditor.value;
        if (!fullHtmlContent.trim() && domSelectors.tabBtnPreview.classList.contains('active')) {
            domSelectors.previewFrame.srcdoc = "<div style='font-family: Inter, sans-serif; color: #555; display: flex; flex-direction:column; justify-content: center; align-items: center; height: 100%; padding: 20px; text-align:center;'>üêøÔ∏è<p class='mt-2'>Editor vazio.</p><p>Gere ou cole c√≥digo e clique na aba Preview para visualizar.</p></div>";
            return;
        }
        domSelectors.previewFrame.srcdoc = fullHtmlContent;
    }

    function switchToTab(tabName) {
        if (tabName === 'code') {
            domSelectors.tabContentCode.classList.remove('hidden');
            domSelectors.tabContentPreview.classList.add('hidden');
            domSelectors.tabBtnCode.classList.add('active');
            domSelectors.tabBtnPreview.classList.remove('active');
        } else if (tabName === 'preview') {
            domSelectors.tabContentCode.classList.add('hidden');
            domSelectors.tabContentPreview.classList.remove('hidden');
            domSelectors.tabBtnCode.classList.remove('active');
            domSelectors.tabBtnPreview.classList.add('active');
            renderPreview(); 
        }
    }

    function downloadFile(content, fileName, mimeType) {
      if (!content.trim()) {
        addMessageToChat("CapyIDE", "Nada para salvar. O editor est√° vazio.", true);
        return;
      }
      const blob = new Blob([content], { type: mimeType });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      document.body.appendChild(a); 
      a.click();
      document.body.removeChild(a); 
      URL.revokeObjectURL(a.href);
      addMessageToChat("CapyIDE", `Arquivo "${fileName}" preparado para download.`);
    }

    function copyCodeToClipboard() {
        const codeToCopy = domSelectors.codeEditor.value;
        if (!codeToCopy.trim()) {
            addMessageToChat("CapyIDE", "Nada para copiar. O editor est√° vazio.", true);
            return;
        }
        try {
            const textArea = document.createElement("textarea");
            textArea.value = codeToCopy;
            textArea.style.position = "fixed"; 
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            addMessageToChat("CapyIDE", "C√≥digo copiado para a √°rea de transfer√™ncia!");
        } catch (err) {
            console.error('Erro ao copiar com execCommand: ', err);
            addMessageToChat("CapyIDE", "Falha ao copiar o c√≥digo. Tente manualmente.", true);
        }
    }

    function toggleEditorFullscreen() {
        const editorElem = domSelectors.editorWrapper; 
        if (!document.fullscreenElement) {
            if (editorElem.requestFullscreen) editorElem.requestFullscreen();
            else if (editorElem.mozRequestFullScreen) editorElem.mozRequestFullScreen(); 
            else if (editorElem.webkitRequestFullscreen) editorElem.webkitRequestFullscreen(); 
            else if (editorElem.msRequestFullscreen) editorElem.msRequestFullscreen(); 
            addMessageToChat("CapyIDE", "Editor em tela cheia. Pressione ESC para sair.");
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
            addMessageToChat("CapyIDE", "Editor saiu da tela cheia.");
        }
    }
    
    function openPreviewInNewWindow() {
        const code = domSelectors.codeEditor.value;
        if (!code.trim()) {
            addMessageToChat("CapyIDE", "N√£o h√° c√≥digo no editor para abrir em nova janela.", true);
            return;
        }
        try {
            const newWindow = window.open("", "_blank");
            if (newWindow) {
                newWindow.document.open(); 
                newWindow.document.write(code);
                newWindow.document.close(); 
                addMessageToChat("CapyIDE", "Preview aberto em uma nova janela!");
            } else {
                addMessageToChat("CapyIDE", "N√£o foi poss√≠vel abrir a nova janela. Verifique se o seu navegador bloqueou o pop-up.", true);
            }
        } catch (e) {
            addMessageToChat("CapyIDE", "Ocorreu um erro ao tentar abrir a nova janela.", true);
            console.error("Erro ao abrir nova janela: ", e);
        }
    }

    function initializeEventListeners() {
      domSelectors.showApiKeyModalBtn.onclick = openApiKeyModal;
      domSelectors.closeApiKeyModalBtn.onclick = closeApiKeyModal;
      domSelectors.saveApiKeyBtnModal.onclick = saveApiKey; 
      domSelectors.clearChatBtn.onclick = clearChat;
      domSelectors.generateCodeBtn.onclick = handleGenerateCode;
      domSelectors.suggestPromptBtn.onclick = handleSuggestPrompt;
      domSelectors.improvePromptBtn.onclick = handleImprovePrompt; 
      domSelectors.tabBtnCode.onclick = () => switchToTab('code');
      domSelectors.tabBtnPreview.onclick = () => switchToTab('preview');
      domSelectors.modernizeProjectBtn.onclick = handleModernizeProject; 
      domSelectors.explainCodeBtn.onclick = handleExplainCode; 
      domSelectors.generateDocsBtn.onclick = handleGenerateDocs; // Novo
      domSelectors.generateTestsBtn.onclick = handleGenerateTests; // Novo
      domSelectors.copyCodeBtn.onclick = copyCodeToClipboard;
      domSelectors.downloadEditorBtn.onclick = () => downloadFile(domSelectors.codeEditor.value, "capyide-codigo.html", "text/html");
      domSelectors.fullscreenBtn.onclick = toggleEditorFullscreen;
      domSelectors.previewNewWindowBtn.onclick = openPreviewInNewWindow;

      domSelectors.promptInput.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' && !event.shiftKey) {
              event.preventDefault(); 
              if (domSelectors.promptInput.value.trim()) {
                  handleGenerateCode(); 
              }
          }
      });
    }

    function init() {
      initializeEventListeners();
      loadApiKey(); 
      addMessageToChat("CapyIDE", "Bem-vindo ao CapyIDE Din√¢mico! Configure sua API Key e comece a criar.");
      switchToTab('code'); 
    }

    init(); 
  });
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker registrado'))
    .catch(err => console.error('Erro no SW', err));
}

</script>
</body>
</html>
