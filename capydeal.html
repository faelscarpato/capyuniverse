<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapyDeal | Ca√ßadora de Ofertas üè∑Ô∏è</title>
    
    <!-- Fontes e √çcones -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Space+Grotesk:wght@500;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Marked para Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- DNA AURORA (Economia Mode) --- */
        :root {
            --bg-deep: #050511;
            --glass-surface: rgba(20, 20, 35, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary-glow: #f59e0b; /* Amber/Gold (Dinheiro) */
            --secondary-glow: #10b981; /* Verde (Economia) */
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(245, 158, 11, 0.08), transparent 40%), 
                radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.08), transparent 40%);
        }

        /* --- LAYOUT --- */
        .layout-grid { display: flex; width: 100%; height: 100%; }

        /* SIDEBAR */
        .sidebar {
            width: 60px; background: rgba(5, 5, 17, 0.85); backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 20px;
            z-index: 50;
        }
        .brand-icon { font-size: 1.8rem; color: var(--primary-glow); margin-bottom: 10px; animation: pulse 3s infinite; }
        
        .nav-btn {
            width: 40px; height: 40px; border-radius: 10px; display: grid; place-items: center;
            color: var(--text-muted); cursor: pointer; transition: 0.2s;
        }
        .nav-btn:hover, .nav-btn.active { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid var(--primary-glow); }

        /* CHAT PANEL */
        .chat-panel {
            width: 380px; background: rgba(5, 5, 17, 0.5); border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column; position: relative; flex-shrink: 0;
        }

        .panel-header {
            padding: 15px 20px; border-bottom: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.02);
        }

        .chat-stream {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;
        }

        .msg { padding: 12px 16px; border-radius: 16px; font-size: 0.9rem; line-height: 1.5; max-width: 90%; animation: slideIn 0.3s ease; }
        .msg.user { background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg.ai { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); align-self: flex-start; border-bottom-left-radius: 4px; }

        /* COMPOSER */
        .composer-area {
            padding: 15px; border-top: 1px solid var(--glass-border); background: rgba(0,0,0,0.2);
        }
        .composer-box {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 8px; display: flex; align-items: center; gap: 8px;
        }
        .chat-input {
            flex: 1; background: transparent; border: none; color: #fff; resize: none;
            font-family: inherit; font-size: 0.95rem; max-height: 100px; padding: 8px;
        }
        .icon-btn {
            width: 36px; height: 36px; display: grid; place-items: center; border-radius: 8px;
            color: var(--text-muted); cursor: pointer; transition: 0.2s; background: transparent; border: none;
        }
        .icon-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .send-btn {
            background: var(--primary-glow); color: #000; border: none; border-radius: 8px;
            width: 36px; height: 36px; display: grid; place-items: center; cursor: pointer; font-weight: bold;
        }

        /* DASHBOARD (RESULTADOS) */
        .dashboard-panel {
            flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 30px;
            background: radial-gradient(circle at top right, rgba(16, 185, 129, 0.05), transparent 40%);
        }

        .dashboard-header { display: flex; justify-content: space-between; align-items: center; }
        .location-badge {
            display: flex; align-items: center; gap: 6px; font-size: 0.8rem;
            background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 20px;
            border: 1px solid var(--glass-border); color: var(--text-muted);
        }

        /* PRODUCT CARDS */
        .products-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;
        }

        .product-card {
            background: rgba(30, 30, 45, 0.6); border: 1px solid var(--glass-border);
            border-radius: 20px; overflow: hidden; position: relative;
            transition: transform 0.3s, border-color 0.3s;
            display: flex; flex-direction: column;
        }
        .product-card:hover {
            transform: translateY(-5px); border-color: var(--primary-glow);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .product-badge {
            position: absolute; top: 10px; right: 10px; z-index: 10;
            padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
        }
        .badge-best { background: var(--primary-glow); color: #000; }
        .badge-cheap { background: var(--secondary-glow); color: #000; }

        .product-img-box {
            height: 180px; width: 100%; background: #fff; /* Fundo branco para produtos */
            display: flex; align-items: center; justify-content: center; padding: 10px;
            position: relative;
        }
        .product-img { max-height: 100%; max-width: 100%; object-fit: contain; mix-blend-mode: multiply; }

        .product-info { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .product-title { font-weight: 700; font-size: 1rem; margin-bottom: 5px; line-height: 1.3; }
        .product-store { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; margin-bottom: 10px; }
        
        .product-price { font-family: 'Space Grotesk', sans-serif; font-size: 1.5rem; font-weight: 700; color: var(--primary-glow); }
        .price-old { font-size: 0.9rem; text-decoration: line-through; color: var(--text-muted); margin-left: 8px; }

        .product-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; background: rgba(255,255,255,0.1); color: #ccc; }
        .tag.coupon { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px dashed #34d399; }

        .product-actions {
            margin-top: auto; padding-top: 15px; display: flex; gap: 10px;
        }
        .btn-buy {
            flex: 1; background: var(--text-main); color: #000; border: none; padding: 10px;
            border-radius: 10px; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none;
            transition: transform 0.2s;
        }
        .btn-buy:hover { transform: scale(1.05); }

        /* COMPARISON TABLE */
        .comparison-table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
            background: rgba(0,0,0,0.2); border-radius: 16px; overflow: hidden;
        }
        .comparison-table th, .comparison-table td {
            padding: 15px; text-align: left; border-bottom: 1px solid var(--glass-border);
        }
        .comparison-table th { background: rgba(255,255,255,0.05); color: var(--primary-glow); }
        .comparison-table tr:last-child td { border-bottom: none; }

        /* Modal API */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; place-items: center; backdrop-filter: blur(5px); }
        .modal.open { display: grid; }
        .modal-box { background: #13131f; padding: 30px; border-radius: 24px; border: 1px solid var(--glass-border); width: 400px; text-align: center; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        @media(max-width: 900px) {
            .layout-grid { flex-direction: column; }
            .sidebar { width: 100%; height: 60px; flex-direction: row; justify-content: center; border-right: none; border-bottom: 1px solid var(--glass-border); }
            .chat-panel { width: 100%; height: 45%; border-right: none; border-bottom: 1px solid var(--glass-border); }
        }
    </style>
</head>
<body>

    <div class="layout-grid">
        
        <!-- SIDEBAR -->
        <nav class="sidebar">
            <div class="brand-icon"><i class="ph-fill ph-tag"></i></div>
            <div class="nav-btn active" title="Buscar"><i class="ph-bold ph-magnifying-glass"></i></div>
            <div class="nav-btn" title="Hist√≥rico" onclick="toggleHistory()"><i class="ph-bold ph-clock-counter-clockwise"></i></div>
            <div class="nav-btn" title="Localiza√ß√£o" onclick="getLocation()"><i class="ph-bold ph-map-pin"></i></div>
            <a href="index.html" class="nav-btn" title="Voltar"><i class="ph-bold ph-house"></i></a>
        </nav>

        <!-- CHAT IA -->
        <aside class="chat-panel">
            <div class="panel-header">
                <div class="flex items-center gap-2">
                    <i class="ph-fill ph-robot text-amber-400"></i>
                    <span class="font-bold">CapyDeal</span>
                </div>
                <button class="icon-btn" onclick="clearChat()" title="Limpar"><i class="ph-bold ph-trash"></i></button>
            </div>

            <div class="chat-stream" id="chatStream">
                <div class="msg ai">
                    Ol√°! Sou sua <strong>Personal Shopper</strong>. üõçÔ∏è
                    <br><br>
                    Posso comparar produtos, encontrar cupons e estimar fretes. O que voc√™ procura hoje?
                    <br><br>
                    <em>Ex: "Notebook gamer at√© R$ 4000" ou envie uma foto.</em>
                </div>
            </div>

            <div class="composer-area">
                <!-- Preview de Imagem -->
                <div id="imgPreview" class="hidden mb-2 px-2 relative">
                    <img id="previewThumb" class="h-16 rounded-lg border border-white/20">
                    <button onclick="clearImage()" class="absolute -top-2 left-14 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">√ó</button>
                </div>

                <div class="composer-box">
                    <button class="icon-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="ph-bold ph-camera"></i>
                    </button>
                    <textarea id="promptInput" class="chat-input" placeholder="Descreva o produto..." rows="1"></textarea>
                    <button id="sendBtn" class="send-btn"><i class="ph-bold ph-paper-plane-right"></i></button>
                </div>
                <input type="file" id="fileInput" hidden accept="image/*">
            </div>
        </aside>

        <!-- DASHBOARD DE OFERTAS -->
        <main class="dashboard-panel">
            <div class="dashboard-header">
                <h2 class="text-2xl font-bold font-space text-white">Melhores Ofertas</h2>
                <div class="location-badge" id="locationBadge">
                    <i class="ph-fill ph-globe"></i> <span id="userLocation">Brasil (Global)</span>
                </div>
            </div>

            <!-- Status Loader -->
            <div id="loader" class="hidden items-center gap-3 text-amber-400">
                <i class="ph-bold ph-spinner ph-spin text-xl"></i>
                <span class="text-sm font-mono">Escaneando e-commerces do multiverso...</span>
            </div>

            <!-- √Årea de Compara√ß√£o -->
            <div id="comparisonArea" class="hidden">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="ph-fill ph-scales text-blue-400"></i> Comparativo Direto</h3>
                <div class="overflow-x-auto rounded-xl border border-white/10">
                    <table class="comparison-table" id="compTable">
                        <!-- Injetado via JS -->
                    </table>
                </div>
            </div>

            <!-- Grid de Produtos -->
            <div class="products-grid" id="productsGrid">
                <!-- Cards Injetados Aqui -->
                <div class="product-card opacity-50 pointer-events-none">
                    <div class="product-img-box">
                        <i class="ph-duotone ph-shopping-bag text-6xl text-gray-300"></i>
                    </div>
                    <div class="product-info">
                        <div class="product-title">Aguardando busca...</div>
                    </div>
                </div>
            </div>
            
            <!-- Mapa (Hidden by default) -->
            <div id="mapContainer" class="hidden w-full h-64 rounded-2xl overflow-hidden border border-white/10 mt-4 bg-gray-800 relative">
                <p class="absolute inset-0 flex items-center justify-center text-gray-500 text-sm">Mapa de lojas pr√≥ximas (Simulado)</p>
                <!-- Iframe do Google Maps Embed ser√° injetado aqui -->
            </div>

        </main>
    </div>

    <!-- API Modal -->
    <div class="modal" id="apiModal">
        <div class="modal-box">
            <i class="ph-fill ph-key text-4xl text-amber-400 mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">Chave de Acesso</h3>
            <p class="text-gray-400 text-sm mb-4">Insira sua Gemini API Key para ativar a busca inteligente.</p>
            <input type="password" id="apiKeyInput" class="w-full bg-black/50 border border-white/20 rounded-lg p-3 text-white mb-4" placeholder="AIzaSy...">
            <button onclick="saveKey()" class="w-full bg-amber-500 hover:bg-amber-600 text-black font-bold py-3 rounded-lg">Conectar</button>
        </div>
    </div>

    <script>
        // --- ESTADO ---
        const state = {
            apiKey: localStorage.getItem('capyUniverseApiKey_gemini') || '',
            location: { city: 'S√£o Paulo', uf: 'SP', cep: '' }, // Default
            imageBase64: null,
            history: []
        };

        const els = {
            input: document.getElementById('promptInput'),
            send: document.getElementById('sendBtn'),
            chat: document.getElementById('chatStream'),
            grid: document.getElementById('productsGrid'),
            compArea: document.getElementById('comparisonArea'),
            compTable: document.getElementById('compTable'),
            loader: document.getElementById('loader'),
            fileIn: document.getElementById('fileInput'),
            imgPreview: document.getElementById('imgPreview'),
            thumb: document.getElementById('previewThumb'),
            apiModal: document.getElementById('apiModal'),
            locBadge: document.getElementById('userLocation')
        };

        if(!state.apiKey) els.apiModal.classList.add('open');

        // --- GEOLOCALIZA√á√ÉO ---
        function getLocation() {
            if (navigator.geolocation) {
                els.locBadge.innerText = "Localizando...";
                navigator.geolocation.getCurrentPosition(successGeo, errorGeo);
            } else {
                alert("Geolocaliza√ß√£o n√£o suportada.");
            }
        }

        async function successGeo(pos) {
            // Reverse Geocoding Simples (Simulado ou via API aberta se dispon√≠vel)
            // Aqui apenas salvamos as coordenadas para o prompt da IA
            const { latitude, longitude } = pos.coords;
            state.location.lat = latitude;
            state.location.lng = longitude;
            state.location.active = true;
            
            // Tenta pegar cidade via API gratuita (OpenStreetMap)
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                const data = await res.json();
                const city = data.address.city || data.address.town || data.address.village;
                state.location.city = city;
                els.locBadge.innerText = `Pr√≥ximo a ${city}`;
                addMessage(`üìç Localiza√ß√£o atualizada: **${city}**. Buscarei ofertas na regi√£o.`, 'ai');
            } catch(e) {
                els.locBadge.innerText = "Localiza√ß√£o Ativa";
            }
        }

        function errorGeo() {
            els.locBadge.innerText = "Brasil (Sem local)";
            alert("N√£o foi poss√≠vel obter localiza√ß√£o. Usaremos busca global.");
        }

        // --- UPLOAD DE IMAGEM ---
        els.fileIn.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                state.imageBase64 = ev.target.result;
                els.thumb.src = state.imageBase64;
                els.imgPreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });

        window.clearImage = () => {
            state.imageBase64 = null;
            els.fileIn.value = '';
            els.imgPreview.classList.add('hidden');
        };

        // --- L√ìGICA DE BUSCA (O C√âREBRO) ---
        async function sendMessage() {
            const text = els.input.value.trim();
            if(!text && !state.imageBase64) return;
            if(!state.apiKey) { els.apiModal.classList.add('open'); return; }

            // UI Updates
            const userMsg = text || (state.imageBase64 ? "" : "...");
            addMessage(userMsg, 'user');
            els.input.value = '';
            els.input.style.height = 'auto';
            els.loader.classList.remove('hidden');
            if(state.imageBase64) clearImage();

            // Montar Prompt Complexo
            const parts = [];
            
            if (state.imageBase64) {
                const base64Data = state.imageBase64.split(',')[1];
                const mimeType = state.imageBase64.split(';')[0].split(':')[1];
                parts.push({ inline_data: { mime_type: mimeType, data: base64Data } });
                parts.push({ text: "Analise esta imagem de produto. Identifique o que √© (marca, modelo)." });
            }

            const systemPrompt = `
                Atue como CapyDeal, uma assistente de compras expert.
                
                CONTEXTO DO USU√ÅRIO:
                Localiza√ß√£o: ${state.location.city || 'Brasil Geral'}.
                Pedido: "${text}"
                
                OBJETIVO:
                1. Identificar a inten√ß√£o (Busca, Compara√ß√£o ou D√∫vida).
                2. Se for BUSCA, gerar um JSON com 4-6 recomenda√ß√µes de produtos reais/populares no Brasil.
                3. Se for COMPARA√á√ÉO, gerar um JSON com tabela comparativa.
                
                FORMATO DE RESPOSTA (JSON OBRIGAT√ìRIO):
                {
                    "type": "search" | "compare" | "chat",
                    "message": "Texto amig√°vel e curto explicando as escolhas.",
                    "products": [
                        {
                            "name": "Nome do Produto",
                            "price": "R$ 0.000,00",
                            "store": "Nome da Loja (ex: Amazon, Kabum)",
                            "image_url": "URL de imagem real ou placeholder (use placehold.co se n√£o souber)",
                            "link": "https://...",
                            "badge": "Melhor Pre√ßo | Custo-Benef√≠cio | Premium",
                            "tags": ["Cupon√°vel", "Frete Gr√°tis", "12x sem juros"],
                            "pros": "Bateria longa, Tela 120hz"
                        }
                    ],
                    "comparison": {
                        "headers": ["Spec", "Prod A", "Prod B"],
                        "rows": [ ["Bateria", "5000mAh", "4000mAh"], ["Tela", "IPS", "OLED"] ]
                    },
                    "coupons": [
                        { "store": "Amazon", "code": "CAPY10", "desc": "10% off em eletr√¥nicos" }
                    ]
                }
                
                NOTA: Como voc√™ √© uma IA, estime pre√ßos atuais de mercado no Brasil. Se n√£o tiver certeza do link, use uma busca do Google Shopping gen√©rica.
            `;

            parts.push({ text: systemPrompt });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: parts }] })
                });

                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
                
                // Parse JSON
                const jsonStr = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                let parsed = {};
                try {
                    parsed = JSON.parse(jsonStr);
                } catch(e) {
                    // Se falhar, trata como chat normal
                    parsed = { type: 'chat', message: aiText };
                }

                // Renderizar
                els.loader.classList.add('hidden');
                addMessage(parsed.message, 'ai');

                if(parsed.type === 'search' && parsed.products) renderProducts(parsed.products);
                if(parsed.type === 'compare' && parsed.comparison) renderComparison(parsed.comparison);
                
                // Mostrar Cupons se houver
                if(parsed.coupons && parsed.coupons.length > 0) {
                    const couponMsg = parsed.coupons.map(c => `üéüÔ∏è **${c.store}**: Use \`${c.code}\` (${c.desc})`).join('\n');
                    addMessage(couponMsg, 'ai');
                }

            } catch (error) {
                els.loader.classList.add('hidden');
                addMessage("Meus sensores falharam. Tente novamente.", 'ai');
                console.error(error);
            }
        }

        // --- RENDERIZADORES ---
        function renderProducts(products) {
            els.compArea.classList.add('hidden');
            els.grid.classList.remove('hidden');
            els.grid.innerHTML = '';

            products.forEach(p => {
                const badgeClass = p.badge.includes('Pre√ßo') ? 'badge-cheap' : 'badge-best';
                // Fallback image se a IA n√£o der URL v√°lida
                const img = (p.image_url && p.image_url.startsWith('http')) ? p.image_url : `https://placehold.co/300x300/1e293b/ffffff?text=${encodeURIComponent(p.name)}`;
                // Google Search Link Gen√©rico se n√£o vier link
                const link = p.link && p.link.startsWith('http') ? p.link : `https://www.google.com/search?q=${encodeURIComponent(p.name + ' comprar')}&tbm=shop`;

                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    ${p.badge ? `<div class="product-badge ${badgeClass}">${p.badge}</div>` : ''}
                    <div class="product-img-box">
                        <img src="${img}" class="product-img" alt="${p.name}">
                    </div>
                    <div class="product-info">
                        <div class="product-store"><i class="ph-bold ph-storefront"></i> ${p.store}</div>
                        <div class="product-title">${p.name}</div>
                        <div class="flex items-baseline mt-2">
                            <div class="product-price">${p.price}</div>
                        </div>
                        <div class="product-tags">
                            ${p.tags.map(t => `<span class="tag ${t.includes('Cupom')?'coupon':''}">${t}</span>`).join('')}
                        </div>
                        <p class="text-xs text-gray-400 mt-3 line-clamp-2">${p.pros}</p>
                        <div class="product-actions">
                            <a href="${link}" target="_blank" class="btn-buy">Ver na Loja <i class="ph-bold ph-arrow-up-right"></i></a>
                        </div>
                    </div>
                `;
                els.grid.appendChild(card);
            });
        }

        function renderComparison(comp) {
            els.grid.classList.add('hidden');
            els.compArea.classList.remove('hidden');
            
            const thead = `<thead><tr>${comp.headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
            const tbody = `<tbody>${comp.rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody>`;
            
            els.compTable.innerHTML = thead + tbody;
        }

        // --- UTILS ---
        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `msg ${sender}`;
            div.innerHTML = marked.parse(text);
            els.chat.appendChild(div);
            els.chat.scrollTop = els.chat.scrollHeight;
        }

        function clearChat() {
            els.chat.innerHTML = '';
            els.grid.innerHTML = '';
            els.compArea.classList.add('hidden');
            addMessage("Mem√≥ria limpa. Pronta para novas ca√ßadas!", 'ai');
        }

        window.saveKey = () => {
            const k = document.getElementById('apiKeyInput').value.trim();
            if(k) { localStorage.setItem('capyUniverseApiKey_gemini', k); state.apiKey = k; document.getElementById('apiModal').classList.remove('open'); }
        };

        // Enter Key
        els.input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') { sendMessage(); }
        });

    </script>
</body>
</html>