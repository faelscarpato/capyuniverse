<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Syne:wght@700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" />
  <title>CapyCaption — CapyUniverse</title>
  <style>
    :root{ --glass: rgba(255,255,255,.06); --glass-border: rgba(255,255,255,.1) }
    html{background: radial-gradient(1200px 800px at 80% -10%, #1a2030 0%, #0b0f14 60%), #0b0f14;}
    body{color:#e6edf3;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',sans-serif;}
    .font-syne{font-family:'Syne',sans-serif}.font-mono{font-family:'JetBrains Mono',ui-monospace,Menlo,Consolas,monospace}
    .glass{background:var(--glass);backdrop-filter:blur(18px);border:1px solid var(--glass-border);border-radius:1.25rem;box-shadow:0 8px 32px rgba(0,0,0,.35)}
    .sidebar-glass{background:rgba(255,255,255,.03);backdrop-filter:blur(18px);border-right:1px solid var(--glass-border)}
    .sidebar-link.active{background:#6366f1;color:#fff;font-weight:600}
    .input{background:#27272a;border:1px solid #3f3f46;color:#e4e4e7;border-radius:.5rem}
    .input:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.45)}
    .btn{background:#2563eb;color:#fff;border-radius:.5rem;padding:.625rem .9rem;font-weight:700}.btn:hover{background:#1d4ed8}
    .chip{background:rgba(255,255,255,.06);border:1px solid var(--glass-border);padding:.35rem .6rem;border-radius:.6rem}
    .card{border:1px solid var(--glass-border)}
  </style>
</head>
<body class="min-h-screen flex flex-col text-[15px]">
<header class="bg-zinc-900/80 backdrop-blur-md shadow-lg flex justify-between items-center fixed top-0 left-0 right-0 z-40 h-16 px-4 sm:px-6">
  <div class="flex items-center">
    <button id="sidebarToggleBtn" class="lg:hidden mr-3 p-2 rounded-md text-gray-300 hover:bg-zinc-700 focus:outline-none"><i class="fas fa-bars text-xl"></i></button>
    <a href="index.html" class="text-xl sm:text-2xl font-bold text-gray-100 hover:text-purple-400 transition-colors font-syne">CapyUniverse IA</a>
  </div>
  <div class="flex items-center">
    <button onclick="window.location.href='index.html'" class="bg-purple-600 hover:bg-purple-700 px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-semibold text-white mr-2 transition-colors">Início</button>
    <button id="openApiKeysModalButton" class="bg-purple-600 hover:bg-purple-700 px-3 py-1.5 sm:px-4 sm:py-2 rounded-md text-xs sm:text-sm font-semibold text-white transition-colors">Chaves API</button>
  </div>
</header>

<div class="flex flex-1 pt-16">
  <aside id="sidebar" class="sidebar-glass text-gray-300 w-64 space-y-1 p-3 fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 lg:static lg:inset-0 transition-transform duration-300 ease-in-out z-30 shadow-lg overflow-y-auto pt-4">
    <p class="text-xs text-center text-zinc-500 p-2">Carregando menu...</p>
  </aside>
  <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>

  <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto w-full">
    <section class="glass border-zinc-800 p-6">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold font-syne text-pink-400">CapyCaption ✨</h1>
        <p class="text-zinc-300 mt-1">Gere variações de legendas para redes sociais, exporte CSV e crie calendário (ICS).</p>
      </div>

      <div class="grid lg:grid-cols-3 gap-5">
        <div class="lg:col-span-2 space-y-4">
          <div class="glass p-4 border border-zinc-800">
            <div class="grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-zinc-400">Plataforma</label>
                <select id="platform" class="input w-full">
                  <option>Instagram</option><option>LinkedIn</option><option>Facebook</option><option>TikTok</option><option>X (Twitter)</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-zinc-400">Variações</label>
                <input id="variations" type="number" class="input w-full" value="6" min="1" max="20">
              </div>
              <div>
                <label class="text-xs text-zinc-400">Tom</label>
                <select id="tone" class="input w-full"><option>Amigável</option><option>Profissional</option><option>Engraçado</option><option>Direto</option><option>Inspirador</option></select>
              </div>
              <div>
                <label class="text-xs text-zinc-400">Idioma</label>
                <select id="language" class="input w-full"><option>pt-BR</option><option>en</option><option>es</option></select>
              </div>
              <div class="sm:col-span-2">
                <label class="text-xs text-zinc-400">Briefing</label>
                <textarea id="brief" class="input w-full min-h-[120px]" placeholder="Tema, produto, público, oferta, dor/benefício..."></textarea>
              </div>
              <div class="sm:col-span-2">
                <label class="text-xs text-zinc-400">Hashtags base (opcional)</label>
                <input id="hashtags" class="input w-full" placeholder="#capy #capyuniverse">
              </div>
              <div class="sm:col-span-2 grid grid-cols-2 gap-2">
                <label class="chip text-xs flex items-center gap-2"><input id="withEmojis" type="checkbox" class="accent-indigo-500" checked>Emojis</label>
                <label class="chip text-xs flex items-center gap-2"><input id="withCTA" type="checkbox" class="accent-indigo-500" checked>Call to Action</label>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 mt-3">
              <button id="btnGenerateAI" class="btn"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Gerar (IA)</button>
              <button id="btnGenerateLocal" class="btn bg-amber-600 hover:bg-amber-700"><i class="fa-solid fa-bolt mr-2"></i>Gerar (local)</button>
            </div>
          </div>

          <div class="glass p-4 border border-zinc-800">
            <div class="grid md:grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-zinc-400">Início (agenda)</label>
                <input id="startDateTime" type="datetime-local" class="input w-full">
              </div>
              <div>
                <label class="text-xs text-zinc-400">Intervalo entre posts</label>
                <select id="interval" class="input w-full">
                  <option value="PT1H">1 hora</option><option value="PT6H">6 horas</option><option value="P1D">1 dia</option><option value="P2D">2 dias</option>
                </select>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 mt-3">
              <button id="btnExportCSV" class="btn bg-sky-600 hover:bg-sky-700"><i class="fa-solid fa-file-csv mr-2"></i>Exportar CSV</button>
              <button id="btnExportICS" class="btn bg-emerald-600 hover:bg-emerald-700"><i class="fa-solid fa-calendar-day mr-2"></i>Exportar ICS</button>
            </div>
          </div>
        </div>

        <div class="space-y-3" id="cards"></div>
      </div>
    </section>
  </main>
</div>

<div id="apiKeysModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4"></div>

<script>
    // ===== Sidebar + API modal =====
    const API_KEY_STORAGE_KEY = 'capyUniverseApiKey_gemini';
    const dom = {
        sidebar: document.getElementById('sidebar'),
        sidebarToggleBtn: document.getElementById('sidebarToggleBtn'),
        sidebarOverlay: document.getElementById('sidebarOverlay'),
        apiKeysModal: document.getElementById('apiKeysModal'),
        openApiKeysModalButton: document.getElementById('openApiKeysModalButton')
    };

    async function renderSidebar(currentPageId) {
        try {
            const r = await fetch('tools.json');
            const data = await r.json();
            const cats = {};
            data.forEach(t => {
                let c = t.category;
                if (typeof c === 'string') c = [c];
                (c || []).forEach(cat => {
                    (cats[cat] = cats[cat] || []).push(t);
                });
            });

            if (!dom.sidebar) return;
            dom.sidebar.innerHTML = '';

            const home = document.createElement('a');
            home.href = 'index.html';
            home.className = 'sidebar-link w-full flex items-center space-x-2.5 p-2.5 mb-2 rounded-md text-sm hover:bg-gray-700 transition-colors duration-150 text-gray-300';
            home.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span>Página Inicial</span>';
            dom.sidebar.appendChild(home);

            for (const name in cats) {
                const box = document.createElement('div');
                box.className = 'mb-1';

                const btn = document.createElement('button');
                btn.className = 'w-full flex justify-between items-center p-2.5 text-left text-gray-300 hover:bg-gray-700 rounded-md';
                btn.innerHTML = `<span class='font-semibold text-sm'>${name}</span><svg class='w-4 h-4 transform transition-transform duration-200' fill='none' stroke='currentColor' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'></path></svg>`;

                const content = document.createElement('div');
                content.className = 'category-content pl-3 pt-0.5 space-y-0.5';

                cats[name].forEach(t => {
                    const a = document.createElement('a');
                    a.href = t.pageUrl;
                    const icon = t.icon ? t.icon.replace('w-10 h-10', 'w-5 h-5').replace('mb-2', 'mr-2') : '<span class="w-5 h-5 mr-2"></span>';
                    a.className = `sidebar-link w-full flex items-center space-x-2 py-1.5 px-2 rounded-md text-xs hover:bg-gray-600 hover:text-white ${t.id === currentPageId ? 'active' : 'text-gray-400'}`;
                    a.innerHTML = icon + `<span>${t.title}</span>`;
                    content.appendChild(a);
                });

                btn.addEventListener('click', () => {
                    content.classList.toggle('expanded');
                    const svg = btn.querySelector('svg');
                    if (svg) svg.classList.toggle('rotate-180');
                });

                if (cats[name].some(t => t.id === currentPageId)) {
                    content.classList.add('expanded');
                    const svg = btn.querySelector('svg');
                    if (svg) svg.classList.add('rotate-180');
                }

                box.appendChild(btn);
                box.appendChild(content);
                dom.sidebar.appendChild(box);
            }
        } catch (e) {
            if (dom.sidebar) {
                dom.sidebar.innerHTML = '<p class="text-xs text-red-500 p-2">Erro ao carregar menu. Verifique "tools.json".</p>';
            }
            console.error('renderSidebar error', e);
        }
    }

    function setupApiKeyModal() {
        if (!dom.apiKeysModal) return;
        const html = `
            <div class='glass border-zinc-800 p-7 rounded-2xl w-full max-w-md'>
                <div class='flex justify-between items-center mb-4'>
                    <h2 class='text-lg font-bold text-purple-400 font-syne'>Gerenciar Chaves de API</h2>
                    <button id='closeApiKeysModalButton' class='text-gray-400 hover:text-white text-2xl'>&times;</button>
                </div>
                <div class='space-y-3'>
                    <div class='p-3 border border-zinc-700 rounded-md bg-zinc-900'>
                        <h3 class='text-md font-medium text-sky-400 mb-1.5'>Google Gemini</h3>
                        <label class='block text-xs font-medium text-gray-300 mb-1'>Sua Chave API Gemini:</label>
                        <div class='flex'>
                            <input id='geminiApiKeyInputModal' type='password' placeholder='Cole sua chave API aqui' class='input w-full rounded-r-none'>
                            <button id='saveGeminiKey' class='bg-sky-600 hover:bg-sky-700 px-3 py-1.5 rounded-l-none rounded-r-md text-xs text-white'>Salvar</button>
                        </div>
                        <p class='text-xs text-zinc-400 mt-2'>Sua chave é salva localmente.</p>
                    </div>
                </div>
            </div>
        `;
        dom.apiKeysModal.innerHTML = html;

        const openBtn = dom.openApiKeysModalButton;
        const closeBtn = document.getElementById('closeApiKeysModalButton');
        const saveBtn = document.getElementById('saveGeminiKey');
        const input = document.getElementById('geminiApiKeyInputModal');

        if (openBtn) openBtn.addEventListener('click', () => dom.apiKeysModal.classList.remove('hidden'));
        if (closeBtn) closeBtn.addEventListener('click', () => dom.apiKeysModal.classList.add('hidden'));
        if (saveBtn && input) {
            saveBtn.addEventListener('click', () => {
                const v = input.value.trim();
                if (v) {
                    localStorage.setItem(API_KEY_STORAGE_KEY, v);
                    alert('Chave API salva!');
                    dom.apiKeysModal.classList.add('hidden');
                } else {
                    alert('Insira uma chave.');
                }
            });
        }
    }

    // ===== CapyCaption =====
    const $ = (s, e = document) => e.querySelector(s);
    function getApiKey() { return localStorage.getItem(API_KEY_STORAGE_KEY) || ''; }
    const state = { items: [] };

    function renderCards() {
        const wrap = document.getElementById('cards');
        if (!wrap) return;
        wrap.innerHTML = '';
        if (!state.items.length) {
            wrap.innerHTML = '<p class="text-zinc-400 text-sm">Gere para ver os cards.</p>';
            return;
        }
        state.items.forEach((it, idx) => {
            const div = document.createElement('div');
            div.className = 'glass card p-4 rounded-xl';
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold text-zinc-200">Var ${idx + 1} — ${it.platform}</span>
                    <button class="chip text-xs copy"><i class="fa-regular fa-copy mr-1"></i>Copiar</button>
                </div>
                <div class="text-sm text-zinc-100 whitespace-pre-wrap">${it.caption}</div>
                ${it.hashtags ? `<div class="text-xs text-zinc-400 mt-2">${it.hashtags}</div>` : ''}
            `;
            const copyBtn = div.querySelector('.copy');
            if (copyBtn) {
                copyBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(it.caption + (it.hashtags ? '\n\n' + it.hashtags : ''));
                        alert('Copiado!');
                    } catch (e) {
                        alert('Falha ao copiar.');
                    }
                });
            }
            wrap.appendChild(div);
        });
    }

    function localGenerate(n, brief, tone, withEmojis, withCTA, hashtags, platform, language) {
        const hooks = {
            "pt-BR": [
                "Você já viu isso?",
                "Dica rápida:",
                "Pare tudo e veja:",
                "3 coisas que ninguém te contou:",
                "Se eu fosse você, salvaria isto."
            ],
            "en": ["Quick tip:", "Stop scrolling:", "3 things no one told you:", "You should save this.", "Have you seen this?"],
            "es": ["Truco rápido:", "Deja de hacer scroll:", "3 cosas que nadie te contó:", "Guárdalo para después.", "¿Ya viste esto?"]
        }[language] || ["Vamos lá:"];

        const ctas = {
            "pt-BR": ["Comente sua opinião 👇", "Salve para usar depois 🔖", "Compartilhe com alguém 📤"],
            "en": ["Comment your take 👇", "Save for later 🔖", "Share with someone 📤"],
            "es": ["Comenta tu opinión 👇", "Guárdalo para después 🔖", "Compártelo con alguien 📤"]
        }[language] || ["Comente sua opinião 👇"];

        const emojis = withEmojis ? ["✨", "🔥", "🚀", "💡", "🔧", "📌", "🧠"] : [""];

        const base = [];
        for (let i = 0; i < n; i++) {
            const hook = hooks[i % hooks.length];
            const emo = emojis[i % emojis.length] || "";
            const body = `${emo} ${hook}\n${brief}\n\n${tone === 'Direto' ? '' : '— '}${tone}.`;
            const cta = withCTA ? `\n\n${ctas[i % ctas.length]}` : '';
            base.push({ platform, caption: body + cta, hashtags });
        }
        return base;
    }

    async function generateAI() {
        const apiKey = getApiKey();
        if (!apiKey) { alert("Chave API Gemini não configurada. Abra 'Chaves API'."); return; }

        const platform = $('#platform').value;
        const tone = $('#tone').value;
        const language = $('#language').value;
        const brief = $('#brief').value.trim();
        const hashtags = $('#hashtags').value.trim();
        const withEmojis = $('#withEmojis').checked;
        const withCTA = $('#withCTA').checked;
        const variations = parseInt($('#variations').value || '6', 10);

        const instructions = `
Gere ${variations} legendas curtas para ${platform} em ${language}.
BRIEFING: """${brief}"""
TOM: ${tone}. Emojis: ${withEmojis ? 'sim' : 'não'}. CTA: ${withCTA ? 'sim' : 'não'}.
Responda APENAS com JSON no formato:
{"itens":[{"caption":"...","hashtags":"... (opcional)"}]}
Use frases naturais, sem repetir muito os ganchos. Não inclua links. Não inclua marcação de código.
`.trim();

        try {
            const payload = { contents: [{ parts: [{ text: instructions }] }], generationConfig: { responseMimeType: "application/json" } };
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err?.error?.message || ('HTTP ' + res.status));
            }
            const data = await res.json();
            const txt = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!txt) throw new Error('Resposta vazia');
            const json = JSON.parse(txt);
            state.items = (json.itens || []).map(x => ({ platform, caption: x.caption, hashtags: x.hashtags || (hashtags || '') }));
            renderCards();
        } catch (e) {
            alert('Falha ao gerar com IA: ' + (e.message || e));
            console.error(e);
        }
    }

    function exportCSV() {
        if (!state.items.length) return alert('Nada para exportar.');
        const rows = [['platform', 'caption', 'hashtags', 'scheduled_at']];
        const sched = scheduleDates();
        state.items.forEach((it, i) => rows.push([it.platform, it.caption.replace(/\n/g, '\\n'), it.hashtags || '', sched[i] || '']));
        const csv = rows.map(r => r.map(v => {
            const s = String(v ?? '');
            return (s.includes(',') || s.includes('"') || s.includes('\\n')) ? ('"' + s.replace(/"/g, '""') + '"') : s;
        }).join(',')).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
        a.download = 'capycaption.csv';
        a.click();
    }

    function isoToIcsDate(dt) {
        const d = new Date(dt);
        const pad = n => String(n).padStart(2, '0');
        return d.getUTCFullYear() + pad(d.getUTCMonth() + 1) + pad(d.getUTCDate()) + 'T' + pad(d.getUTCHours()) + pad(d.getUTCMinutes()) + pad(d.getUTCSeconds()) + 'Z';
    }

    function scheduleDates() {
        const start = $('#startDateTime').value;
        if (!start) return state.items.map(() => '');
        const isoDur = $('#interval').value; // PT1H / P1D etc
        const stepMs = isoDur.startsWith('PT') ? parseInt(isoDur.match(/PT(\d+)H/)?.[1] || '1', 10) * 3600e3
            : isoDur.startsWith('P') ? parseInt(isoDur.match(/P(\d+)D/)?.[1] || '1', 10) * 86400e3 : 3600e3;
        const t0 = new Date(start).getTime();
        return state.items.map((_, i) => new Date(t0 + i * stepMs).toISOString());
    }

    function exportICS() {
        if (!state.items.length) return alert('Nada para exportar.');
        const sched = scheduleDates();
        const lines = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//CapyUniverse//CapyCaption//PT'];
        state.items.forEach((it, i) => {
            if (!sched[i]) return;
            const dt = isoToIcsDate(sched[i]);
            const summary = `Post ${it.platform} #${i + 1}`;
            const desc = (it.caption + (it.hashtags ? '\n\n' + it.hashtags : '')).replace(/\n/g, '\\n');
            lines.push('BEGIN:VEVENT', 'DTSTART:' + dt, 'DTEND:' + dt, 'SUMMARY:' + summary, 'DESCRIPTION:' + desc, 'END:VEVENT');
        });
        lines.push('END:VCALENDAR');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([lines.join('\r\n')], { type: 'text/calendar' }));
        a.download = 'capycaption.ics';
        a.click();
    }

    // attach UI handlers
    const btnGenerateLocal = document.getElementById('btnGenerateLocal');
    const btnGenerateAI = document.getElementById('btnGenerateAI');
    const btnExportCSV = document.getElementById('btnExportCSV');
    const btnExportICS = document.getElementById('btnExportICS');

    if (btnGenerateLocal) {
        btnGenerateLocal.addEventListener('click', () => {
            const platform = $('#platform').value;
            const tone = $('#tone').value;
            const language = $('#language').value;
            const brief = $('#brief').value.trim();
            const hashtags = $('#hashtags').value.trim();
            const withEmojis = $('#withEmojis').checked;
            const withCTA = $('#withCTA').checked;
            const n = parseInt($('#variations').value || '6', 10);
            state.items = localGenerate(n, brief, tone, withEmojis, withCTA, hashtags, platform, language);
            renderCards();
        });
    }
    if (btnGenerateAI) btnGenerateAI.addEventListener('click', generateAI);
    if (btnExportCSV) btnExportCSV.addEventListener('click', exportCSV);
    if (btnExportICS) btnExportICS.addEventListener('click', exportICS);

    // boot
    function baseBoot(currentPageId) {
        renderSidebar(currentPageId);
        setupApiKeyModal();
        if (dom.sidebarToggleBtn) {
            dom.sidebarToggleBtn.addEventListener('click', () => {
                if (dom.sidebar) dom.sidebar.classList.toggle('-translate-x-full');
                if (dom.sidebarOverlay) dom.sidebarOverlay.classList.toggle('hidden');
            });
        }
        if (dom.sidebarOverlay) {
            dom.sidebarOverlay.addEventListener('click', () => {
                if (dom.sidebar) dom.sidebar.classList.add('-translate-x-full');
                dom.sidebarOverlay.classList.add('hidden');
            });
        }
    }

    baseBoot('CapyCaption');
</script>
</body>
</html>
