<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" />
  <title>CapyCaption — CapyUniverse</title>
  <link rel="stylesheet" href="cu-style.css">
  <script src="cu-navigation.js" defer></script>
</head>
<body class="min-h-screen flex flex-col">
<header class="cu-header">
    <div class="cu-brand">
        <a href="index.html" class="flex items-center gap-2 group">
            <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png"></div>
            <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
        </a>
        <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyCaption</span>
    </div>
    <div class="flex items-center gap-2">
        <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
    </div>
</header>

<div class="flex flex-1">
  <aside id="sidebar" class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin">
    <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
  </aside>

  <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
    <section class="cu-panel p-4 sm:p-6">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold" style="color: var(--cu-pink);">CapyCaption ✨</h1>
        <p class="text-cu-text-dim mt-1">Gere legendas para redes sociais, exporte CSV e crie um calendário (ICS).</p>
      </div>

      <div class="grid lg:grid-cols-3 gap-5">
        <div class="lg:col-span-2 space-y-4">
          <div class="cu-panel bg-transparent p-4">
            <div class="grid sm:grid-cols-2 gap-4">
              <div>
                <label class="text-xs text-cu-text-dim">Plataforma</label>
                <select id="platform" class="cu-select w-full">
                  <option>Instagram</option><option>LinkedIn</option><option>Facebook</option><option>TikTok</option><option>X (Twitter)</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-cu-text-dim">Variações</label>
                <input id="variations" type="number" class="cu-input w-full" value="6" min="1" max="20">
              </div>
              <div>
                <label class="text-xs text-cu-text-dim">Tom</label>
                <select id="tone" class="cu-select w-full"><option>Amigável</option><option>Profissional</option><option>Engraçado</option><option>Direto</option><option>Inspirador</option></select>
              </div>
              <div>
                <label class="text-xs text-cu-text-dim">Idioma</label>
                <select id="language" class="cu-select w-full"><option>pt-BR</option><option>en</option><option>es</option></select>
              </div>
              <div class="sm:col-span-2">
                <label class="text-xs text-cu-text-dim">Briefing</label>
                <textarea id="brief" class="cu-textarea w-full min-h-[120px]" placeholder="Tema, produto, público..."></textarea>
              </div>
              <div class="sm:col-span-2">
                <label class="text-xs text-cu-text-dim">Hashtags base (opcional)</label>
                <input id="hashtags" class="cu-input w-full" placeholder="#capy #capyuniverse">
              </div>
              <div class="sm:col-span-2 grid grid-cols-2 gap-2">
                <label class="cu-chip text-xs flex items-center gap-2"><input id="withEmojis" type="checkbox" class="accent-purple-500" checked>Emojis</label>
                <label class="cu-chip text-xs flex items-center gap-2"><input id="withCTA" type="checkbox" class="accent-purple-500" checked>Call to Action</label>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 mt-3">
              <button id="btnGenerateAI" class="cu-btn primary"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Gerar (IA)</button>
              <button id="btnGenerateLocal" class="cu-btn"><i class="fa-solid fa-bolt mr-2"></i>Gerar (local)</button>
            </div>
          </div>

          <div class="cu-panel bg-transparent p-4">
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="text-xs text-cu-text-dim">Início (agenda)</label>
                <input id="startDateTime" type="datetime-local" class="cu-input w-full">
              </div>
              <div>
                <label class="text-xs text-cu-text-dim">Intervalo</label>
                <select id="interval" class="cu-select w-full">
                  <option value="PT1H">1 hora</option><option value="PT6H">6 horas</option><option value="P1D">1 dia</option><option value="P2D">2 dias</option>
                </select>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 mt-3">
              <button id="btnExportCSV" class="cu-btn"><i class="fa-solid fa-file-csv mr-2"></i>CSV</button>
              <button id="btnExportICS" class="cu-btn"><i class="fa-solid fa-calendar-day mr-2"></i>ICS</button>
            </div>
          </div>
        </div>

        <div class="space-y-3" id="cards"></div>
      </div>
    </section>
  </main>
</div>

<div id="notificationArea"></div>

<script>
    const $ = (s, e = document) => e.querySelector(s);
    const getApiKey = () => localStorage.getItem('capyUniverseApiKey_gemini') || '';
    const state = { items: [] };

    function renderCards() {
        const wrap = $('#cards');
        wrap.innerHTML = state.items.length ? '' : '<p class="text-cu-text-dim text-sm">Gere para ver os cards.</p>';
        state.items.forEach((it, idx) => {
            const div = document.createElement('div');
            div.className = 'cu-panel bg-transparent p-4';
            div.innerHTML = `<div class="flex justify-between items-center mb-2"><span class="font-semibold">Var ${idx + 1} — ${it.platform}</span><button class="cu-btn text-xs copy"><i class="fa-regular fa-copy mr-1"></i>Copiar</button></div><div class="text-sm whitespace-pre-wrap">${it.caption}</div>${it.hashtags ? `<div class="text-xs text-cu-text-dim mt-2">${it.hashtags}</div>` : ''}`;
            div.querySelector('.copy').addEventListener('click', () => navigator.clipboard.writeText(it.caption + (it.hashtags ? `\n\n${it.hashtags}` : '')).then(() => alert('Copiado!')));
            wrap.appendChild(div);
        });
    }

    function localGenerate(n, brief, tone, withEmojis, withCTA, hashtags, platform, language) {
        const hooks = {"pt-BR":["Você já viu?","Dica rápida:","Pare e veja:"]}[language] || ["Quick tip:"];
        const ctas = {"pt-BR":["Comente 👇","Salve 🔖","Compartilhe 📤"]}[language] || ["Comment 👇"];
        const emojis = withEmojis ? ["✨", "🔥", "🚀"] : [""];
        return Array.from({length: n}, (_, i) => ({ platform, caption: `${emojis[i%emojis.length]} ${hooks[i%hooks.length]}\n${brief}\n\n— ${tone}.${withCTA ? `\n\n${ctas[i%ctas.length]}` : ''}`, hashtags }));
    }

    async function generateAI() {
        const apiKey = getApiKey();
        if (!apiKey) return alert("Chave API Gemini não configurada.");
        const brief = $('#brief').value.trim();
        if (!brief) return alert("O briefing não pode estar vazio.");

        const instructions = `Gere ${$('#variations').value} legendas para ${$('#platform').value} em ${$('#language').value}. Briefing: "${brief}". Tom: ${$('#tone').value}. Emojis: ${$('#withEmojis').checked}. CTA: ${$('#withCTA').checked}. Responda em JSON: {"itens":[{"caption":"...","hashtags":"..."}]}`;

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: instructions }] }], generationConfig: { responseMimeType: "application/json" } })
            });
            if (!res.ok) throw new Error((await res.json()).error.message);
            const json = JSON.parse((await res.json()).candidates[0].content.parts[0].text);
            state.items = (json.itens || []).map(x => ({ platform: $('#platform').value, caption: x.caption, hashtags: x.hashtags || $('#hashtags').value.trim() }));
            renderCards();
        } catch (e) { alert('Falha na IA: ' + e.message); }
    }

    function exportCSV() {
        if (!state.items.length) return;
        const sched = scheduleDates();
        const rows = [['platform', 'caption', 'hashtags', 'scheduled_at'], ...state.items.map((it, i) => [it.platform, it.caption, it.hashtags || '', sched[i] || ''])];
        const csv = rows.map(r => r.map(v => `"${String(v|| '').replace(/"/g, '""')}"`).join(',')).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
        a.download = 'capycaption.csv';
        a.click();
    }

    function scheduleDates() {
        const start = $('#startDateTime').value;
        if (!start) return [];
        const dur = $('#interval').value;
        const stepMs = dur.startsWith('PT') ? parseInt(dur.match(/(\d+)H/)[1]) * 3600e3 : parseInt(dur.match(/(\d+)D/)[1]) * 86400e3;
        return state.items.map((_, i) => new Date(new Date(start).getTime() + i * stepMs).toISOString());
    }

    function exportICS() {
        if (!state.items.length) return;
        const sched = scheduleDates();
        const lines = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//CapyUniverse//CapyCaption//PT', ...state.items.flatMap((it, i) => sched[i] ? ['BEGIN:VEVENT', `DTSTART:${isoToIcsDate(sched[i])}`, `SUMMARY:Post ${it.platform}`,
            `DESCRIPTION:${(it.caption + (it.hashtags ? `\n\n${it.hashtags}` : '')).replace(/\n/g, '\\n')}`, 'END:VEVENT'] : [])];
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([lines.join('\r\n')], { type: 'text/calendar' }));
        a.download = 'capycaption.ics';
        a.click();
    }
    const isoToIcsDate = dt => new Date(dt).toISOString().replace(/[-:.]/g, '').slice(0, 15) + 'Z';

    $('#btnGenerateLocal').addEventListener('click', () => { state.items = localGenerate(parseInt($('#variations').value), $('#brief').value.trim(), $('#tone').value, $('#withEmojis').checked, $('#withCTA').checked, $('#hashtags').value.trim(), $('#platform').value, $('#language').value); renderCards(); });
    $('#btnGenerateAI').addEventListener('click', generateAI);
    $('#btnExportCSV').addEventListener('click', exportCSV);
    $('#btnExportICS').addEventListener('click', exportICS);

    document.addEventListener('DOMContentLoaded', () => renderCards());
</script>
</body>
</html>

