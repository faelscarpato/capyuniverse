<!DOCTYPE html>
<html lang="pt-br" data-theme="capyuniverse">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="icon" href="https://raw.githubusercontent.com/faelscarpato/capyuniverse/main/2.png" />
  <title>CapyCSV — CapyUniverse</title>
  <link rel="stylesheet" href="cu-style.css">
  <script src="cu-navigation.js" defer></script>

  <style>
    .dropzone { border: 2px dashed #ffffff33; transition: background-color 0.3s; }
    .dropzone.dragover { background-color: #ffffff11; }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <header class="cu-header">
    <div class="cu-brand">
        <a href="index.html" class="flex items-center gap-2 group">
            <div class="cu-logo flex-shrink-0"><img src="icons/icon-512.png"></div>
            <span class="cu-appname text-lg sm:text-xl">CapyUniverse</span>
        </a>
        <span class="ml-3 text-xs text-zinc-400 hidden sm:inline">/ CapyCSV</span>
    </div>
    <div class="flex items-center gap-2">
        <button id="openManageApiKeyModalButtonHeader" class="cu-btn primary">Chaves API</button>
    </div>
  </header>

  <div class="flex flex-1">
    <aside id="sidebar" class="hidden lg:block cu-panel w-64 space-y-1 p-3 fixed inset-y-0 left-0 z-30 overflow-y-auto pt-20 scrollbar-thin">
      <p class="text-xs text-center text-cu-text-dim p-2">Carregando menu...</p>
    </aside>

    <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:ml-64 w-full">
      <section class="cu-panel p-4 sm:p-6">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold" style="color: var(--cu-cyan);">CapyCSV 🧹</h1>
          <p class="text-cu-text-dim mt-1">Limpe, una e exporte dados CSV/XLSX no navegador.</p>
        </div>

        <div class="grid lg:grid-cols-3 gap-5">
          <div class="lg:col-span-2 space-y-4">
            <div class="cu-panel bg-transparent p-4">
              <div id="csvDrop" class="dropzone p-5 text-center">
                <input id="csvInput" type="file" accept=".csv,.tsv,.txt,.xlsx" multiple class="absolute inset-0 opacity-0 cursor-pointer">
                <p class="text-cu-text-dim"><i class="fa-solid fa-cloud-arrow-up mr-2"></i>Arraste CSV/XLSX ou <span class="underline">clique</span>.</p>
              </div>
            </div>

            <div class="cu-panel bg-transparent p-3">
              <div class="flex flex-wrap gap-2 mb-2">
                <select id="delim" class="cu-select text-xs"><option value="auto">Delimitador: Auto</option><option value=",">,</option><option value=";">;</option><option value="\t">Tab</option></select>
                <label class="cu-chip text-xs"><input id="trimCells" type="checkbox" class="accent-purple-500 mr-2">Trim</label>
                <label class="cu-chip text-xs"><input id="removeEmpty" type="checkbox" class="accent-purple-500 mr-2">Remover vazias</label>
                <select id="headerCase" class="cu-select text-xs"><option value="keep">Cabeçalho: Manter</option><option value="title">Title Case</option><option value="snake">snake_case</option></select>
              </div>
              <div class="flex gap-2">
                <button id="btnApply" class="cu-btn primary"><i class="fa-solid fa-broom mr-2"></i>Limpar</button>
                <button id="btnExportCSV" class="cu-btn"><i class="fa-solid fa-file-csv mr-2"></i>CSV</button>
                <button id="btnExportXLSX" class="cu-btn"><i class="fa-solid fa-file-excel mr-2"></i>XLSX</button>
              </div>
            </div>

            <div id="preview" class="overflow-auto cu-panel bg-transparent p-3 max-h-[60vh] scrollbar-thin"></div>
          </div>

          <div class="space-y-4">
            <div class="cu-panel bg-transparent p-4">
              <h3 class="font-semibold mb-2">Arquivos</h3>
              <ul id="fileList" class="text-sm space-y-1"></ul>
              <button id="btnMerge" class="cu-btn w-full mt-2"><i class="fa-solid fa-layer-group mr-2"></i>Unir</button>
            </div>
            <div class="cu-panel bg-transparent p-4">
              <h3 class="font-semibold mb-2">Status</h3>
              <p id="status" class="text-cu-text-dim text-sm">Nenhum arquivo.</p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const $ = s => document.querySelector(s);
    const state = { datasets: [], headers: [], merged: [] };

    async function readFile(file) {
        if (file.name.toLowerCase().endsWith('.xlsx')) {
            const ab = await file.arrayBuffer();
            const wb = XLSX.read(ab, {type: 'array'});
            return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
        } else {
            const text = await file.text();
            const delim = $('#delim').value === 'auto' ? Papa.parse(text, {preview: 1}).meta.delimiter : $('#delim').value;
            return Papa.parse(text, {delimiter: delim, skipEmptyLines: false}).data;
        }
    }

    function renderFiles() {
        $('#fileList').innerHTML = state.datasets.map(d => `<li><span class="cu-chip text-xs">${d.name}</span></li>`).join('');
        $('#status').textContent = `${state.datasets.length} arquivo(s) carregado(s).`;
    }

    function preview(rows) {
        const wrap = $('#preview');
        if (!rows.length) return wrap.innerHTML = '<p>Sem dados.</p>';
        const table = `<table><thead><tr>${rows[0].map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${rows.slice(1, 100).map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
        wrap.innerHTML = table;
    }

    function clean(rows) {
        let out = $('#trimCells').checked ? rows.map(r => r.map(c => String(c || '').trim())) : rows;
        if ($('#removeEmpty').checked) out = out.filter((r, i) => i === 0 || r.some(c => String(c || '').trim()));
        const headerCase = $('#headerCase').value;
        if (headerCase !== 'keep') out[0] = out[0].map(h => headerCase === 'lower' ? h.toLowerCase() : headerCase === 'snake' ? h.toLowerCase().replace(/\W+/g, '_') : h.replace(/\w\S*/g, txt => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()));
        return out;
    }

    async function handleFiles(files) {
        for (const f of files) {
            const rows = await readFile(f);
            state.datasets.push({ name: f.name, rows });
        }
        renderFiles();
        preview(state.datasets[0].rows);
    }

    document.getElementById('btnApply').addEventListener('click', () => {
        state.datasets = state.datasets.map(ds => ({ ...ds, rows: clean(ds.rows) }));
        preview(state.datasets[0].rows);
    });

    document.getElementById('btnMerge').addEventListener('click', () => {
        if (state.datasets.length < 2) return alert('Carregue pelo menos 2 arquivos para unir.');
        const allRows = state.datasets.flatMap(ds => ds.rows.slice(1));
        state.merged = [state.datasets[0].rows[0], ...allRows];
        preview(state.merged);
    });

    function exportFile(format) {
        const rows = state.merged.length ? state.merged : state.datasets[0]?.rows;
        if (!rows) return alert('Nenhum dado para exportar.');
        const filename = `capy.${format}`;
        if (format === 'csv') {
            const csv = Papa.unparse(rows);
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
        } else if (format === 'xlsx') {
            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Dados');
            const out = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([out], { type: 'application/octet-stream' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
        }
    }

    document.getElementById('btnExportCSV').addEventListener('click', () => exportFile('csv'));
    document.getElementById('btnExportXLSX').addEventListener('click', () => exportFile('xlsx'));

    const dropzone = document.getElementById('csvDrop');
    dropzone.addEventListener('click', () => document.getElementById('csvInput').click());
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', e => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    document.getElementById('csvInput').addEventListener('change', e => handleFiles(e.target.files));
  </script>
</body>
</html>

