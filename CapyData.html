<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapyData | O Or√°culo üîÆ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- DNA AURORA --- */
        :root {
            --bg-deep: #050511;
            --glass-surface: rgba(20, 20, 35, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary-glow: #10b981; /* Verde Matrix */
            --secondary-glow: #3b82f6; /* Azul Tech */
            --accent-hot: #f59e0b; /* Laranja Alerta */
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(16, 185, 129, 0.1), transparent 40%), 
                radial-gradient(circle at 90% 80%, rgba(59, 130, 246, 0.1), transparent 40%);
        }

        /* --- LAYOUT --- */
        .layout-grid { display: flex; width: 100%; height: 100%; }

        /* SIDEBAR */
        .sidebar {
            width: 60px; background: rgba(5, 5, 17, 0.85); backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 20px;
            z-index: 50;
        }
        .brand-icon { font-size: 1.8rem; color: var(--primary-glow); margin-bottom: 10px; animation: pulse 3s infinite; }
        .nav-btn {
            width: 40px; height: 40px; border-radius: 10px; display: grid; place-items: center;
            color: var(--text-muted); cursor: pointer; transition: 0.2s;
        }
        .nav-btn:hover, .nav-btn.active { background: rgba(255,255,255,0.1); color: #fff; }

        /* CHAT PANEL */
        .chat-panel {
            width: 350px; background: rgba(5, 5, 17, 0.5); border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column; position: relative;
        }

        .panel-header {
            padding: 15px 20px; border-bottom: 1px solid var(--glass-border);
            display: flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: 0.5px;
        }

        .chat-stream {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;
        }

        .msg { padding: 12px 16px; border-radius: 12px; font-size: 0.9rem; line-height: 1.5; max-width: 90%; }
        .msg.user { background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); align-self: flex-end; }
        .msg.ai { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); align-self: flex-start; }

        /* INPUT AREA */
        .composer-area {
            padding: 15px; border-top: 1px solid var(--glass-border); background: rgba(0,0,0,0.2);
        }
        .composer-box {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 8px; display: flex; align-items: flex-end; gap: 8px;
        }
        .chat-input {
            flex: 1; background: transparent; border: none; color: #fff; resize: none;
            font-family: inherit; font-size: 0.9rem; max-height: 100px; padding: 8px;
        }
        .send-btn {
            background: var(--primary-glow); color: #000; border: none; border-radius: 8px;
            width: 36px; height: 36px; display: grid; place-items: center; cursor: pointer; transition: transform 0.2s;
        }
        .send-btn:hover { transform: scale(1.1); }

        /* DASHBOARD PANEL */
        .dashboard-panel {
            flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 30px; position: relative;
        }

        /* Toolbar de Exporta√ß√£o */
        .export-bar {
            display: flex; gap: 10px; justify-content: flex-end;
        }
        .export-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            color: var(--text-muted); padding: 8px 16px; border-radius: 8px;
            font-size: 0.85rem; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px; transition: all 0.2s;
        }
        .export-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: var(--primary-glow); }
        .export-btn.excel:hover { color: #10b981; border-color: #10b981; }
        .export-btn.sheets:hover { color: #34a853; border-color: #34a853; }
        .export-btn.html:hover { color: #f97316; border-color: #f97316; }

        /* Cards de Estat√≠sticas */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;
        }
        .stat-card {
            background: rgba(30, 30, 45, 0.6); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 20px; position: relative; overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow));
        }
        .stat-value { font-size: 2rem; font-weight: 800; margin: 10px 0 5px 0; color: #fff; }
        .stat-label { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }

        /* Chart Container */
        .chart-container {
            background: rgba(30, 30, 45, 0.6); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 20px; flex: 1; min-height: 400px; position: relative;
        }

        /* Data Table (Hidden/Toggle) */
        .data-table-wrapper {
            max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out;
            background: rgba(30, 30, 45, 0.9); border-radius: 12px;
        }
        .data-table-wrapper.open { max-height: 400px; border: 1px solid var(--glass-border); margin-top: 20px; overflow-y: auto; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 15px; background: rgba(255,255,255,0.05); color: var(--primary-glow); position: sticky; top: 0; font-weight: 700; }
        td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-main); }
        tr:hover td { background: rgba(255,255,255,0.02); }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; place-items: center; backdrop-filter: blur(5px); }
        .modal.open { display: grid; }
        .modal-box { background: #13131f; padding: 30px; border-radius: 20px; border: 1px solid var(--glass-border); width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-input { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #fff; border-radius: 8px; margin: 15px 0; }
        .modal-btn { width: 100%; padding: 12px; background: var(--primary-glow); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #000; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        @media(max-width: 900px) {
            .layout-grid { flex-direction: column; }
            .sidebar { width: 100%; height: 60px; flex-direction: row; justify-content: center; border-right: none; border-bottom: 1px solid var(--glass-border); }
            .chat-panel { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid var(--glass-border); }
        }
    </style>
</head>
<body>

    <div class="layout-grid">
        
        <nav class="sidebar">
            <div class="brand-icon"><i class="ph-fill ph-chart-polar"></i></div>
            <div class="nav-btn active" title="Dashboard"><i class="ph-bold ph-squares-four"></i></div>
            <div class="nav-btn" onclick="toggleTable()" title="Ver Tabela"><i class="ph-bold ph-table"></i></div>
            <div class="nav-btn" onclick="openApiModal()" title="Configura√ß√µes"><i class="ph-bold ph-gear"></i></div>
            <a href="index.html" class="nav-btn" title="Voltar"><i class="ph-bold ph-house"></i></a>
        </nav>

        <aside class="chat-panel">
            <div class="panel-header">
                <i class="ph-fill ph-robot text-green-400"></i> CapyAnalyst
            </div>
            <div class="chat-stream" id="chatStream">
                <div class="msg ai">
                    Cole seus dados aqui (texto, CSV, JSON) ou pe√ßa uma an√°lise.
                    <br><br>
                    <em>"Analise as vendas do trimestre..."</em>
                </div>
            </div>
            <div class="composer-area">
                <div class="composer-box">
                    <textarea id="promptInput" class="chat-input" placeholder="Digite ou cole dados..." rows="1"></textarea>
                    <button id="sendBtn" class="send-btn"><i class="ph-bold ph-paper-plane-right"></i></button>
                </div>
            </div>
        </aside>

        <main class="dashboard-panel">
            
            <div class="export-bar">
                <button class="export-btn sheets" onclick="copyForSheets()" title="Copiar para colar no Google Sheets">
                    <i class="ph-bold ph-copy"></i> Copiar p/ Sheets
                </button>
                <button class="export-btn excel" onclick="downloadExcel()" title="Baixar arquivo Excel">
                    <i class="ph-bold ph-file-xls"></i> Excel (.xlsx)
                </button>
                <button class="export-btn html" onclick="downloadHtmlReport()" title="Baixar Relat√≥rio HTML">
                    <i class="ph-bold ph-file-html"></i> Relat√≥rio HTML
                </button>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-label">Status</div>
                    <div class="stat-value" style="color: var(--primary-glow)">Aguardando Input</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>

            <div class="data-table-wrapper" id="dataTableWrapper">
                <table id="dataTable">
                    <thead><tr><th>Dado</th><th>Valor</th></tr></thead>
                    <tbody><tr><td>-</td><td>-</td></tr></tbody>
                </table>
            </div>

        </main>
    </div>

    <div class="modal" id="apiModal">
        <div class="modal-box">
            <i class="ph-fill ph-lock-key" style="font-size: 3rem; color: var(--primary-glow);"></i>
            <h3>Chave do Or√°culo</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Insira sua Gemini API Key.</p>
            <input type="password" id="apiKeyInput" class="modal-input" placeholder="AIzaSy...">
            <button onclick="saveKey()" class="modal-btn">Salvar</button>
        </div>
    </div>

    <script>
        // --- ESTADO GLOBAL ---
        const state = {
            apiKey: localStorage.getItem('capyide_gemini_key') || '',
            currentChart: null,
            history: [],
            currentData: null // Armazena os dados atuais para exporta√ß√£o
        };

        const els = {
            prompt: document.getElementById('promptInput'),
            sendBtn: document.getElementById('sendBtn'),
            chatStream: document.getElementById('chatStream'),
            statsGrid: document.getElementById('statsGrid'),
            ctx: document.getElementById('mainChart').getContext('2d'),
            apiModal: document.getElementById('apiModal'),
            keyInput: document.getElementById('apiKeyInput'),
            tableWrapper: document.getElementById('dataTableWrapper'),
            table: document.getElementById('dataTable')
        };

        // Configura√ß√£o Chart.js
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
        Chart.defaults.font.family = "'Inter', sans-serif";

        if(!state.apiKey) els.apiModal.classList.add('open');

        // --- L√ìGICA PRINCIPAL ---

        async function sendMessage() {
            const text = els.prompt.value.trim();
            if(!text) return;
            if(!state.apiKey) { els.apiModal.classList.add('open'); return; }

            addMessage(text, 'user');
            els.prompt.value = '';
            const loadingId = addMessage('Processando...', 'ai', true);

            // Prompt Engenharia de Dados
            const systemPrompt = `
                Atue como um Cientista de Dados S√™nior. Analise a entrada.
                Gere um JSON para visualiza√ß√£o.
                
                IMPORTANTE: Voc√™ DEVE retornar um campo "table_data" com os dados brutos para Excel.
                
                Formato JSON esperado:
                {
                    "speak": "Coment√°rio curto",
                    "chart": {
                        "type": "bar|line|pie|doughnut|radar",
                        "labels": ["A", "B"],
                        "datasets": [{ "label": "X", "data": [10, 20] }]
                    },
                    "kpis": [
                        { "label": "Total", "value": "30" }
                    ],
                    "table_data": [
                        ["Categoria", "Valor"], 
                        ["A", 10], 
                        ["B", 20]
                    ]
                }
                Se n√£o houver dados, invente um exemplo did√°tico. Responda APENAS o JSON.
            `;

            state.history.push({ role: "user", parts: [{ text: systemPrompt + "\n\nInput: " + text }] });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: state.history })
                });

                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
                
                const jsonStr = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                const parsed = JSON.parse(jsonStr);

                document.getElementById(loadingId).remove();
                
                // Atualiza Estado
                state.currentData = parsed;

                if(parsed.speak) addMessage(parsed.speak, 'ai');
                if(parsed.chart) renderChart(parsed.chart);
                if(parsed.kpis) renderKPIs(parsed.kpis);
                if(parsed.table_data) renderTable(parsed.table_data);

                state.history.push({ role: "model", parts: [{ text: aiText }] });

            } catch (error) {
                document.getElementById(loadingId).innerText = "Erro: " + error.message;
            }
        }

        // --- RENDERIZA√á√ÉO ---

        function renderChart(config) {
            if(state.currentChart) state.currentChart.destroy();
            
            const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ec4899'];
            config.datasets.forEach((ds, i) => {
                ds.backgroundColor = colors[i % colors.length] + '80';
                ds.borderColor = colors[i % colors.length];
                ds.borderWidth = 2;
                ds.fill = true;
                ds.tension = 0.4;
            });

            state.currentChart = new Chart(els.ctx, {
                type: config.type,
                data: { labels: config.labels, datasets: config.datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { color: '#fff' } } }
                }
            });
        }

        function renderKPIs(kpis) {
            els.statsGrid.innerHTML = '';
            kpis.forEach(kpi => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `<div class="stat-label">${kpi.label}</div><div class="stat-value">${kpi.value}</div>`;
                els.statsGrid.appendChild(card);
            });
        }

        function renderTable(rows) {
            els.table.innerHTML = '';
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            
            rows.forEach((row, i) => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const el = i === 0 ? document.createElement('th') : document.createElement('td');
                    el.textContent = cell;
                    tr.appendChild(el);
                });
                if(i === 0) thead.appendChild(tr); else tbody.appendChild(tr);
            });
            
            els.table.appendChild(thead);
            els.table.appendChild(tbody);
        }

        // --- EXPORTA√á√ÉO (O GRANDE FINAL) ---

        // 1. Excel (.xlsx) via SheetJS
        function downloadExcel() {
            if(!state.currentData || !state.currentData.table_data) {
                alert("Nenhum dado para exportar. Pe√ßa uma an√°lise primeiro.");
                return;
            }
            const ws = XLSX.utils.aoa_to_sheet(state.currentData.table_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dados");
            XLSX.writeFile(wb, "CapyData_Export.xlsx");
        }

        // 2. Copiar para Sheets (TSV)
        function copyForSheets() {
            if(!state.currentData || !state.currentData.table_data) {
                alert("Sem dados."); return;
            }
            // Converte array de arrays para String separada por Tabs (TSV)
            const tsv = state.currentData.table_data.map(row => row.join('\t')).join('\n');
            navigator.clipboard.writeText(tsv).then(() => {
                alert("Copiado! Abra o Google Sheets e d√™ CTRL+V.");
            });
        }

        // 3. Relat√≥rio HTML
        function downloadHtmlReport() {
            if(!state.currentData) { alert("Gere um gr√°fico antes."); return; }
            
            const chartImg = state.currentChart.toBase64Image();
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Relat√≥rio CapyData</title>
                    <style>
                        body { font-family: sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        h1 { color: #333; }
                        .kpi { display: inline-block; padding: 20px; background: #f0f0f0; margin: 10px; border-radius: 8px; }
                        .kpi h3 { margin: 0; font-size: 0.9rem; color: #666; }
                        .kpi p { margin: 5px 0 0 0; font-size: 1.5rem; font-weight: bold; color: #10b981; }
                        img { max-width: 100%; margin-top: 30px; border: 1px solid #ddd; }
                        table { width: 100%; border-collapse: collapse; margin-top: 40px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>Relat√≥rio Anal√≠tico</h1>
                    <p>${state.currentData.speak || ''}</p>
                    
                    <div>
                        ${state.currentData.kpis.map(k => `
                            <div class="kpi"><h3>${k.label}</h3><p>${k.value}</p></div>
                        `).join('')}
                    </div>

                    <img src="${chartImg}" />

                    <h3>Dados Detalhados</h3>
                    <table>
                        ${state.currentData.table_data.map((row, i) => `
                            <tr>${row.map(cell => `<${i===0?'th':'td'}>${cell}</${i===0?'th':'td'}>`).join('')}</tr>
                        `).join('')}
                    </table>
                    <p style="margin-top:50px; color:#999; font-size:0.8rem;">Gerado por CapyData AI</p>
                </body>
                </html>
            `;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "Relatorio_CapyData.html";
            a.click();
        }

        // --- HELPERS ---
        function addMessage(text, sender, isTemp=false) {
            const div = document.createElement('div');
            div.className = `msg ${sender}`;
            div.id = isTemp ? 'loading-msg' : '';
            div.innerHTML = marked.parse(text);
            els.chatStream.appendChild(div);
            els.chatStream.scrollTop = els.chatStream.scrollHeight;
            return div.id;
        }

        function toggleTable() { els.tableWrapper.classList.toggle('open'); }
        function openApiModal() { els.apiModal.classList.add('open'); if(state.apiKey) els.keyInput.value = state.apiKey; }
        
        window.saveKey = () => {
            const key = els.keyInput.value.trim();
            if(key) {
                localStorage.setItem('capyide_gemini_key', key);
                state.apiKey = key;
                els.apiModal.classList.remove('open');
            }
        };

        // Enter to Send
        els.sendBtn.onclick = sendMessage;
        els.prompt.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') sendMessage();
        });

    </script>
</body>
</html>